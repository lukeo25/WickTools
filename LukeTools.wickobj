{"object":{"classname":"Clip","identifier":null,"name":null,"uuid":"8b5cb2d0-6594-4b16-a581-3c869162bd6f","children":["d435b44d-051f-4cc4-97a5-3ba7a093b3eb"],"scripts":[{"name":"default","src":"// ==UserScript==\n// @name         Luke Tools Local Panel Bridge\n// @version      2.8.10\n// @description  Draggable Luke Tools panel, launcher button, tool loader, and a generic bridge for selection, clips, assets, scripts, and transform edits\n// @match        https://www.wickeditor.com/editor/*\n// @match        https://wickeditor.com/editor/*\n// @grant        none\n// ==/UserScript==\n\n(function () {\n    \"use strict\";\n\n\n    var LT_GITHUB_RAW_BASE = \"https://raw.githubusercontent.com/lukeo25/WickTools/main/\"; // FIX\n    var LT_CONFIG_URL = LT_GITHUB_RAW_BASE + \"Config.json\"; // FIX\n\n    var GUARD = \"LukeToolsLocalPanelBridgeLoaded_282\";\n    if (window[GUARD]) return;\n    window[GUARD] = true;\n\n    var PANEL_ID = \"luke_tools_panel_271\";\n    var LAUNCHER_ID = \"luke_tools_launcher_271\";\n    var GAMESPRITE_LAUNCHER_ID = \"luke_tools_gamesprite_launcher_271\"; // FIX\n    var GAMESPRITE_PANEL_ID = \"luke_tools_gamesprite_panel_271\"; // FIX\n    var GAMESPRITE_PANEL_IFRAME_ID = \"luke_tools_gamesprite_panel_iframe_271\"; // FIX\n    var OVERLAY_ID = \"luke_tools_fullscreen_overlay_271\";\n    var OVERLAY_IFRAME_ID = \"luke_tools_fullscreen_iframe_271\";\n    var PANEL_IFRAME_ID = \"luke_tools_panel_iframe_271\";\n\n    var STORAGE_X = \"LukeToolsPanelPosX_271\";\n    var STORAGE_Y = \"LukeToolsPanelPosY_271\";\n    var STORAGE_PANEL_JSON = \"LukeToolsPanelConfigJSON_271\"; // FIX: JSON config for icon buttons\n    var DEFAULT_PANEL_JSON_URL = LT_GITHUB_RAW_BASE + \"scripts/config.json\"; // FIX: default config location in public/scripts // FIX: default resolves to config.json beside this script // FIX: auto load panel config from public scripts\n    var ICON_PANEL_ONLY = true; // FIX: hide legacy picker UI and show JSON icon panel only\n\n    var DEFAULT_PANEL_W = 300; // FIX: default panel width\n    var DEFAULT_PANEL_H = 600; // FIX: default panel height\n\n    function resetPanelSizeToDefault() { // FIX\n        try {\n            var panel = document.getElementById(PANEL_ID);\n            if (!panel) return;\n            panel.style.width = DEFAULT_PANEL_W + \"px\";\n            panel.style.height = DEFAULT_PANEL_H + \"px\";\n            panel.style.maxHeight = DEFAULT_PANEL_H + \"px\";\n        } catch (e) { }\n    }\n\n    function applyPanelSizeFromMessage(msg) { // FIX\n        try {\n            var panel = document.getElementById(PANEL_ID);\n            if (!panel) return;\n            var pw = msg && (msg.panelWidth !== undefined && msg.panelWidth !== null) ? parseInt(String(msg.panelWidth), 10) : NaN;\n            var ph = msg && (msg.panelHeight !== undefined && msg.panelHeight !== null) ? parseInt(String(msg.panelHeight), 10) : NaN;\n            if (isNaN(pw) || pw <= 0) pw = DEFAULT_PANEL_W;\n            if (isNaN(ph) || ph <= 0) ph = DEFAULT_PANEL_H;\n            panel.style.width = pw + \"px\";\n            panel.style.height = ph + \"px\";\n            panel.style.maxHeight = ph + \"px\";\n        } catch (e) { }\n    }\n    function computePanelConfigUrlSameFolder() { // FIX\n        // Only use the GitHub config URL. Never resolve relative to the host site.\n        return LT_CONFIG_URL; // FIX\n    }\n\n    var STORAGE_SEL_NAME = \"LukeToolsSelectedClipName\";\n    var STORAGE_SEL_UUID = \"LukeToolsSelectedClipUUID\";\n    var STORAGE_SEL_IDENTIFIER = \"LukeToolsSelectedClipIdentifier\";\n\n\n\n    var RUNTIME_KEY = \"LukeToolsRuntime\";\n\n    function ensureRuntime() {\n        var rt = null;\n        try { rt = window[RUNTIME_KEY] || null; } catch (e0) { rt = null; }\n\n        if (rt && rt.ok) return rt;\n\n        rt = {\n            ok: true,\n            version: \"2.8.9\",\n            killed: false,\n            kill: function () {\n                try { this.killed = true; } catch (e1) { }\n            }\n        };\n\n        try { window[RUNTIME_KEY] = rt; } catch (e2) { }\n        return rt;\n    }\n\n    function isKilled() {\n        try {\n            var rt = window[RUNTIME_KEY] || null;\n            return !!(rt && rt.killed);\n        } catch (e) {\n            return false;\n        }\n    }\n\n    ensureRuntime();\n    var BRAND_ICON_URL = LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/LukeTools.svg\"; // FIX\n\n    function log() {\n        try { console.log.apply(console, arguments); } catch (e) { }\n    }\n\n    function s(v) {\n        if (v === null || v === undefined) return \"\";\n        return String(v);\n    }\n\n    function escapeAttr(v) { // FIX\n        try {\n            return s(v)\n                .replace(/&/g, \"&amp;\")\n                .replace(/\"/g, \"&quot;\")\n                .replace(/</g, \"&lt;\")\n                .replace(/>/g, \"&gt;\");\n        } catch (e) {\n            return s(v);\n        }\n    }\n\n\n    function safeGet(obj, path) {\n        var cur = obj;\n        for (var i = 0; i < path.length; i += 1) {\n            if (!cur) return null;\n            cur = cur[path[i]];\n        }\n        return cur || null;\n    }\n\n    function nowMs() {\n        try { return Date.now(); } catch (e) { return 0; }\n    }\n\n    function normalizeText(v) {\n        return s(v).replace(/\\s+/g, \" \").trim();\n    }\n\n    function isFn(fn) {\n        return typeof fn === \"function\";\n    }\n\n    function tryCall(obj, fnNames, args) {\n        if (!obj) return { ok: false, reason: \"obj missing\" };\n        for (var i = 0; i < fnNames.length; i += 1) {\n            var name = fnNames[i];\n            try {\n                if (isFn(obj[name])) {\n                    var out = obj[name].apply(obj, args || []);\n                    return { ok: true, name: name, out: out };\n                }\n            } catch (e) {\n                return { ok: false, reason: \"call failed \" + name, error: s(e && e.message ? e.message : e) };\n            }\n        }\n        return { ok: false, reason: \"no matching function\" };\n    }\n\n    function getEditor() {\n        try { if (window.wickEditor) return window.wickEditor; } catch (e1) { }\n        try { if (window.WickEditor && window.WickEditor.editor) return window.WickEditor.editor; } catch (e2) { }\n        try { if (window.editor) return window.editor; } catch (e3) { }\n        try { if (window.app) return window.app; } catch (e4) { }\n        return null;\n    }\n\n    function getProject() {\n        var ed = getEditor();\n        try { if (ed && ed.project) return ed.project; } catch (e1) { }\n        return null;\n    }\n\n    function getSelectionApi(ed) {\n        if (!ed) ed = getEditor();\n        var p = null;\n        try { p = ed && ed.project ? ed.project : null; } catch (e0) { p = null; }\n        if (p && p.selection) return p.selection;\n        if (ed && ed.selection) return ed.selection;\n        return null;\n    }\n\n    function getSelectedObjects(ed) {\n        var sel = getSelectionApi(ed);\n        if (!sel) return [];\n        try {\n            if (isFn(sel.getSelectedObjects)) {\n                var list = sel.getSelectedObjects();\n                return list && list.length ? list : [];\n            }\n        } catch (e1) { }\n        return [];\n    }\n\n    function getSelectedObject(ed) {\n        var list = getSelectedObjects(ed);\n        return list && list.length ? (list[0] || null) : null;\n    }\n\n    function getObjName(obj) {\n        if (!obj) return \"\";\n        if (typeof obj.name === \"string\") return obj.name.trim();\n        if (isFn(obj.getName)) {\n            try { return s(obj.getName()).trim(); } catch (e) { return \"\"; }\n        }\n        return \"\";\n    }\n\n    function getObjUUID(obj) {\n        if (!obj) return \"\";\n        if (typeof obj.uuid === \"string\") return obj.uuid.trim();\n        if (typeof obj.UUID === \"string\") return obj.UUID.trim();\n        if (typeof obj.id === \"string\") return obj.id.trim();\n        return \"\";\n    }\n\n    function getObjIdentifier(obj) {\n        if (!obj) return \"\";\n        try { if (typeof obj._identifier === \"string\" && obj._identifier.trim()) return obj._identifier.trim(); } catch (e1) { }\n        try { if (typeof obj.identifier === \"string\" && obj.identifier.trim()) return obj.identifier.trim(); } catch (e2) { }\n        var nm = getObjName(obj);\n        if (nm) return nm;\n        var uu = getObjUUID(obj);\n        if (uu) return uu;\n        return \"\";\n    }\n\n    function markDirty(ed) {\n        try {\n            if (ed && ed.project && isFn(ed.project.markAsModified)) ed.project.markAsModified();\n        } catch (e1) { }\n        try {\n            if (ed && ed.project) ed.project.unsavedChanges = true;\n        } catch (e2) { }\n        try {\n            if (ed && ed.canvas && isFn(ed.canvas.render)) ed.canvas.render();\n        } catch (e3) { }\n        try {\n            window.dispatchEvent(new Event(\"resize\"));\n        } catch (e4) { }\n    }\n\n    function findInputNearLabelText(labelLower) {\n        var nodes = document.querySelectorAll(\"div, span, label, p, strong, b\");\n        for (var i = 0; i < nodes.length; i += 1) {\n            var t = normalizeText(nodes[i].textContent).toLowerCase();\n            if (t === labelLower) {\n                var container = nodes[i].parentElement;\n                if (!container) continue;\n\n                var input1 = container.querySelector(\"input, textarea\");\n                if (input1) return input1;\n\n                var sib = nodes[i].nextElementSibling;\n                if (sib) {\n                    var tag = (sib.tagName || \"\").toLowerCase();\n                    if (tag === \"input\" || tag === \"textarea\") return sib;\n                    var input2 = sib.querySelector && sib.querySelector(\"input, textarea\");\n                    if (input2) return input2;\n                }\n\n                var parent = container.parentElement;\n                if (parent) {\n                    var input3 = parent.querySelector(\"input, textarea\");\n                    if (input3) return input3;\n                }\n            }\n        }\n        return null;\n    }\n\n    function setInspectorNumber(labelLower, valueNumber) {\n        var input = findInputNearLabelText(labelLower);\n        if (!input) return { ok: false, reason: \"inspector input not found for \" + labelLower };\n\n        try {\n            input.focus();\n            input.value = String(valueNumber);\n\n            input.dispatchEvent(new Event(\"input\", { bubbles: true }));\n            input.dispatchEvent(new Event(\"change\", { bubbles: true }));\n\n            try { input.blur(); } catch (e0) { }\n\n            try {\n                input.dispatchEvent(new KeyboardEvent(\"keydown\", { key: \"Enter\", bubbles: true }));\n                input.dispatchEvent(new KeyboardEvent(\"keyup\", { key: \"Enter\", bubbles: true }));\n            } catch (e1) { }\n\n            return { ok: true };\n        } catch (e) {\n            return { ok: false, reason: \"inspector write error\", error: s(e && e.message ? e.message : e) };\n        }\n    }\n\n    function tryRefreshSelectionWithoutDeselect(ed) {\n        try {\n            var sel = getSelectionApi(ed);\n            if (!sel || !isFn(sel.getSelectedObjects)) return false;\n\n            var list = sel.getSelectedObjects();\n            if (!list || !list.length) return false;\n\n            var selectFns = [\"selectObjects\", \"setSelectedObjects\", \"select\"];\n            for (var j = 0; j < selectFns.length; j += 1) {\n                var fn2 = sel[selectFns[j]];\n                if (isFn(fn2)) {\n                    try { fn2.call(sel, list); return true; } catch (e2) { }\n                }\n            }\n\n            return false;\n        } catch (e3) {\n            return false;\n        }\n    }\n\n    function tryEnsureKeyframe(ed) {\n        try {\n            if (!ed || !ed.project) return false;\n            var p = ed.project;\n\n            var frame = 1;\n            try { if (typeof p.currentFrameNumber === \"number\") frame = p.currentFrameNumber; } catch (e0) { }\n\n            var tl = p.timeline || p.activeTimeline || null;\n            if (!tl) return false;\n\n            var candidates = [\n                \"addKeyframe\",\n                \"insertKeyframe\",\n                \"createKeyframe\",\n                \"makeKeyframe\",\n                \"convertToKeyframe\",\n                \"splitFrame\",\n                \"splitFrames\"\n            ];\n\n            for (var i = 0; i < candidates.length; i += 1) {\n                var fn = tl[candidates[i]];\n                if (isFn(fn)) {\n                    try { fn.call(tl, frame); return true; } catch (e1) { }\n                }\n            }\n\n            return false;\n        } catch (e2) {\n            return false;\n        }\n    }\n\n    function selectionInfo() {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!obj) return { ok: false, reason: \"nothing selected\" };\n\n        return {\n            ok: true,\n            name: getObjName(obj),\n            uuid: getObjUUID(obj),\n            identifier: getObjIdentifier(obj)\n        };\n    }\n\n    function walkProjectChildren(visitor) {\n        var ed = getEditor();\n        var project = ed ? ed.project : null;\n        if (!project) return { ok: false, reason: \"project missing\" };\n\n        var rootTimeline = project.timeline || project.activeTimeline || null;\n\n        function visitTimeline(tl) {\n            if (!tl || !tl.layers) return;\n            for (var i = 0; i < tl.layers.length; i += 1) {\n                var layer = tl.layers[i];\n                if (!layer || !layer.frames) continue;\n                for (var j = 0; j < layer.frames.length; j += 1) {\n                    var fr = layer.frames[j];\n                    if (!fr || !fr.children) continue;\n                    for (var k = 0; k < fr.children.length; k += 1) {\n                        var child = fr.children[k];\n                        if (!child) continue;\n                        try { visitor(child); } catch (e0) { }\n                    }\n                }\n            }\n        }\n\n        function visitClipAsset(obj) {\n            var ca = null;\n            try { ca = obj && obj.clipAsset ? obj.clipAsset : null; } catch (e1) { ca = null; }\n            if (!ca) return;\n            var tl = null;\n            try { tl = ca.timeline ? ca.timeline : null; } catch (e2) { tl = null; }\n            if (!tl) return;\n            visitTimeline(tl);\n        }\n\n        if (rootTimeline) {\n            visitTimeline(rootTimeline);\n        }\n\n        var visited = 0;\n        var visitedMax = 20000;\n\n        walkSelectionAndClips();\n\n        function walkSelectionAndClips() {\n            var seen = {};\n            function keyFor(o) {\n                var uu = getObjUUID(o);\n                var id = getObjIdentifier(o);\n                return (uu ? uu : \"nouu\") + \"|\" + (id ? id : \"noid\");\n            }\n\n            function walkObj(o, depth) {\n                if (!o) return;\n                if (depth > 40) return;\n                var key = keyFor(o);\n                if (seen[key]) return;\n                seen[key] = true;\n\n                visited += 1;\n                if (visited > visitedMax) return;\n\n                try { visitor(o); } catch (e0) { }\n\n                var tl = null;\n                try { tl = (o.clipAsset && o.clipAsset.timeline) ? o.clipAsset.timeline : o.timeline; } catch (e1) { tl = null; }\n                if (tl && tl.layers) {\n                    for (var i = 0; i < tl.layers.length; i += 1) {\n                        var layer = tl.layers[i];\n                        if (!layer || !layer.frames) continue;\n                        for (var j = 0; j < layer.frames.length; j += 1) {\n                            var fr = layer.frames[j];\n                            if (!fr || !fr.children) continue;\n                            for (var k = 0; k < fr.children.length; k += 1) {\n                                var child = fr.children[k];\n                                if (!child) continue;\n                                walkObj(child, depth + 1);\n                            }\n                        }\n                    }\n                }\n\n                if (o.clipAsset) visitClipAsset(o);\n            }\n\n            var sel = getSelectedObjects(ed);\n            for (var i = 0; i < sel.length; i += 1) walkObj(sel[i], 0);\n        }\n\n        return { ok: true, visited: visited };\n    }\n\n    function findObjectByUUID(uuid) {\n        var want = s(uuid).trim();\n        if (!want) return null;\n        var found = null;\n\n        walkProjectChildren(function (o) {\n            if (found) return;\n            var uu = getObjUUID(o);\n            if (uu && uu === want) found = o;\n        });\n\n        return found;\n    }\n\n    function findObjectByIdentifier(identifier) {\n        var want = s(identifier).trim();\n        if (!want) return null;\n        var found = null;\n\n        walkProjectChildren(function (o) {\n            if (found) return;\n            var id = getObjIdentifier(o);\n            if (id && id === want) found = o;\n        });\n\n        return found;\n    }\n\n    function findObjectByInfo(info) {\n        if (!info) return null;\n        var uu = s(info.uuid).trim();\n        var id = s(info.identifier || info.name).trim();\n\n        if (uu) {\n            var byU = findObjectByUUID(uu);\n            if (byU) return byU;\n        }\n\n        if (id) {\n            var byI = findObjectByIdentifier(id);\n            if (byI) return byI;\n        }\n\n        return null;\n    }\n\n    function selectObjects(ed, objs) {\n        var sel = getSelectionApi(ed);\n        if (!sel) return { ok: false, reason: \"selection api missing\" };\n\n        var arr = objs && objs.length ? objs : [];\n        var out = tryCall(sel, [\"selectObjects\", \"setSelectedObjects\", \"select\"], [arr]);\n        if (out.ok) return { ok: true, via: out.name };\n        return { ok: false, reason: \"no selection setter found\" };\n    }\n\n    function withTemporarySelection(targetObj, fn) {\n        var ed = getEditor();\n        if (!ed) return { ok: false, reason: \"editor missing\" };\n\n        var sel = getSelectionApi(ed);\n        if (!sel || !isFn(sel.getSelectedObjects)) return { ok: false, reason: \"selection api missing\" };\n\n        var prev = [];\n        try { prev = sel.getSelectedObjects() || []; } catch (e0) { prev = []; }\n\n        var selRes = selectObjects(ed, [targetObj]);\n        if (!selRes.ok) return { ok: false, reason: \"could not select target\", detail: selRes };\n\n        var result = null;\n        try { result = fn(); } catch (e1) { result = { ok: false, reason: \"fn threw\", error: s(e1 && e1.message ? e1.message : e1) }; }\n\n        try { selectObjects(ed, prev); } catch (e2) { }\n\n        return result;\n    }\n\n    function editPropertyOnSelection(prop, value, opts) {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!ed || !obj) return { ok: false, reason: \"nothing selected\" };\n\n        var opt = opts || {};\n        if (opt.viaInspector && prop === \"rotation\") {\n            var nextR = Number(value);\n            if (!isFinite(nextR)) nextR = 0;\n\n            var r = setInspectorNumber(\"rotation\", nextR);\n            if (!r.ok) return { ok: false, reason: \"inspector failed\", detail: r };\n\n            if (opt.keyframe) tryEnsureKeyframe(ed);\n            markDirty(ed);\n            tryRefreshSelectionWithoutDeselect(ed);\n\n            return { ok: true, mode: \"inspector\", prop: prop, value: nextR, uuid: getObjUUID(obj), identifier: getObjIdentifier(obj) };\n        }\n\n        try { obj[prop] = value; } catch (e1) { return { ok: false, reason: \"write failed\", error: s(e1 && e1.message ? e1.message : e1) }; }\n\n        if (prop === \"rotation\" && opt.keyframe) tryEnsureKeyframe(ed);\n        markDirty(ed);\n        tryRefreshSelectionWithoutDeselect(ed);\n\n        return { ok: true, mode: \"direct\", prop: prop, value: value, uuid: getObjUUID(obj), identifier: getObjIdentifier(obj) };\n    }\n\n    function editPropertyByInfo(info, prop, value, opts) {\n        var target = findObjectByInfo(info);\n        if (!target) return { ok: false, reason: \"target not found\", info: info };\n\n        return withTemporarySelection(target, function () {\n            return editPropertyOnSelection(prop, value, opts);\n        });\n    }\n\n    function rotateSelection(deltaDegrees, opts) {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!ed || !obj) return { ok: false, reason: \"nothing selected\" };\n\n        var cur = 0;\n        try { if (typeof obj.rotation === \"number\") cur = obj.rotation; } catch (e0) { cur = 0; }\n\n        var next = cur + Number(deltaDegrees || 0);\n        if (!isFinite(next)) next = cur;\n\n        var opt = opts || {};\n        if (opt.viaInspector) {\n            var r = setInspectorNumber(\"rotation\", next);\n            if (!r.ok) return { ok: false, reason: \"inspector failed\", detail: r };\n\n            if (opt.keyframe) tryEnsureKeyframe(ed);\n            markDirty(ed);\n            tryRefreshSelectionWithoutDeselect(ed);\n\n            return { ok: true, mode: \"inspector\", value: next, uuid: getObjUUID(obj), identifier: getObjIdentifier(obj) };\n        }\n\n        try { obj.rotation = next; } catch (e1) { return { ok: false, reason: \"write failed\", error: s(e1 && e1.message ? e1.message : e1) }; }\n\n        if (opt.keyframe) tryEnsureKeyframe(ed);\n        markDirty(ed);\n        tryRefreshSelectionWithoutDeselect(ed);\n\n        return { ok: true, mode: \"direct\", value: next, uuid: getObjUUID(obj), identifier: getObjIdentifier(obj) };\n    }\n\n    function rotateByInfo(info, deltaDegrees, opts) {\n        var target = findObjectByInfo(info);\n        if (!target) return { ok: false, reason: \"target not found\", info: info };\n        return withTemporarySelection(target, function () {\n            return rotateSelection(deltaDegrees, opts);\n        });\n    }\n\n    function getSelectedClipAsset() {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!obj) return null;\n        try { if (obj.clipAsset) return obj.clipAsset; } catch (e1) { }\n        return null;\n    }\n\n    function getSelectedTimeline() {\n        var ed = getEditor();\n        var project = ed ? ed.project : null;\n        if (!project) return null;\n        try { if (project.timeline) return project.timeline; } catch (e1) { }\n        try { if (project.activeTimeline) return project.activeTimeline; } catch (e2) { }\n        return null;\n    }\n\n    function isScriptable(obj) {\n        if (!obj) return false;\n        if (isFn(obj.addScript)) return true;\n        if (isFn(obj.getScript)) return true;\n        if (obj.scripts && typeof obj.scripts === \"object\") return true;\n        return false;\n    }\n\n    function resolveScriptTarget(obj) {\n        var cur = obj;\n        var guard = 0;\n        while (cur && guard < 80) {\n            if (isScriptable(cur)) return cur;\n            try { if (cur.clipAsset && isScriptable(cur.clipAsset)) return cur.clipAsset; } catch (e1) { }\n            cur = cur.parentClip || cur.parent || cur._parent || null;\n            guard += 1;\n        }\n        return null;\n    }\n\n    function readDefaultScriptFromTarget(target) {\n        if (!target) return \"\";\n        try {\n            if (isFn(target.getScript)) {\n                var gs = target.getScript(\"default\");\n                if (typeof gs === \"string\") return gs;\n                if (gs && typeof gs === \"object\") {\n                    if (typeof gs.source === \"string\") return gs.source;\n                    if (typeof gs.code === \"string\") return gs.code;\n                    if (typeof gs.text === \"string\") return gs.text;\n                    if (typeof gs.src === \"string\") return gs.src;\n                }\n            }\n        } catch (e1) { }\n\n        try {\n            var sc = target.scripts;\n            if (typeof sc === \"string\") return sc;\n            if (sc && typeof sc === \"object\") {\n                if (typeof sc.default === \"string\") return sc.default;\n                if (sc.default && typeof sc.default === \"object\") {\n                    if (typeof sc.default.source === \"string\") return sc.default.source;\n                    if (typeof sc.default.code === \"string\") return sc.default.code;\n                    if (typeof sc.default.text === \"string\") return sc.default.text;\n                    if (typeof sc.default.src === \"string\") return sc.default.src;\n                }\n                if (Array.isArray(sc)) {\n                    for (var i = 0; i < sc.length; i += 1) {\n                        var item = sc[i];\n                        if (!item) continue;\n                        if (item.name === \"default\") {\n                            if (typeof item.source === \"string\") return item.source;\n                            if (typeof item.code === \"string\") return item.code;\n                            if (typeof item.text === \"string\") return item.text;\n                            if (typeof item.src === \"string\") return item.src;\n                        }\n                    }\n                }\n            }\n        } catch (e2) { }\n\n        try {\n            if (typeof target.defaultScript === \"string\") return target.defaultScript;\n            if (typeof target.script === \"string\") return target.script;\n        } catch (e3) { }\n\n        return \"\";\n    }\n\n    function writeDefaultScriptToTarget(target, source, ed) {\n        var src = s(source);\n        if (!target) return { ok: false, reason: \"target missing\" };\n\n        try { if (isFn(target.removeScript)) target.removeScript(\"default\"); } catch (e1) { }\n\n        try {\n            if (isFn(target.addScript)) {\n                target.addScript(\"default\", src);\n                markDirty(ed);\n                return { ok: true, mode: \"addScript\" };\n            }\n        } catch (e2) { return { ok: false, reason: \"addScript failed\", error: s(e2 && e2.message ? e2.message : e2) }; }\n\n        try {\n            if (target.scripts && typeof target.scripts === \"object\") {\n                target.scripts.default = src;\n                markDirty(ed);\n                return { ok: true, mode: \"scripts.default\" };\n            }\n        } catch (e3) { return { ok: false, reason: \"scripts.default failed\", error: s(e3 && e3.message ? e3.message : e3) }; }\n\n        try {\n            target.defaultScript = src;\n            markDirty(ed);\n            return { ok: true, mode: \"defaultScript\" };\n        } catch (e4) { }\n\n        return { ok: false, reason: \"no supported script api\" };\n    }\n\n    function getDefaultScriptOnSelection() {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!ed || !obj) return \"\";\n        var target = resolveScriptTarget(obj);\n        if (!target) return \"\";\n        return s(readDefaultScriptFromTarget(target));\n    }\n\n    function setDefaultScriptOnSelection(source) {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!ed || !obj) return { ok: false, reason: \"nothing selected\" };\n        var target = resolveScriptTarget(obj);\n        if (!target) return { ok: false, reason: \"selection not scriptable\" };\n        return writeDefaultScriptToTarget(target, source, ed);\n    }\n\n    function getDefaultScriptByInfo(info) {\n        var targetObj = findObjectByInfo(info);\n        if (!targetObj) return \"\";\n        var target = resolveScriptTarget(targetObj);\n        if (!target) return \"\";\n        return s(readDefaultScriptFromTarget(target));\n    }\n\n    function setDefaultScriptByInfo(info, source) {\n        var targetObj = findObjectByInfo(info);\n        if (!targetObj) return { ok: false, reason: \"target not found\", info: info };\n        var ed = getEditor();\n        var target = resolveScriptTarget(targetObj);\n        if (!target) return { ok: false, reason: \"target not scriptable\" };\n        return writeDefaultScriptToTarget(target, source, ed);\n    }\n\n    \n    // FIX: Added Update Script support (read/write \"update\" script type)\n    function readUpdateScriptFromTarget(target) {\n        if (!target) return \"\";\n        // 1) Preferred API: getScript(\"update\")\n        try {\n            if (isFn(target.getScript)) {\n                var gs = target.getScript(\"update\");\n                if (typeof gs === \"string\") return gs;\n                if (gs && typeof gs === \"object\") {\n                    if (typeof gs.source === \"string\") return gs.source;\n                    if (typeof gs.code === \"string\") return gs.code;\n                    if (typeof gs.text === \"string\") return gs.text;\n                    if (typeof gs.src === \"string\") return gs.src;\n                }\n            }\n        } catch (e1) { }\n\n        // 2) Direct property access\n        try {\n            var sc = target.scripts;\n            if (sc && typeof sc === \"object\") {\n                if (typeof sc.update === \"string\") return sc.update;\n                if (sc.update && typeof sc.update === \"object\") {\n                    if (typeof sc.update.source === \"string\") return sc.update.source;\n                    if (typeof sc.update.code === \"string\") return sc.update.code;\n                    if (typeof sc.update.text === \"string\") return sc.update.text;\n                    if (typeof sc.update.src === \"string\") return sc.update.src;\n                }\n                if (Array.isArray(sc)) {\n                    for (var i = 0; i < sc.length; i += 1) {\n                        var item = sc[i];\n                        if (!item) continue;\n                        if (item.name === \"update\") {\n                            if (typeof item.source === \"string\") return item.source;\n                            if (typeof item.code === \"string\") return item.code;\n                            if (typeof item.text === \"string\") return item.text;\n                            if (typeof item.src === \"string\") return item.src;\n                        }\n                    }\n                }\n            }\n        } catch (e2) { }\n\n        try {\n            if (typeof target.updateScript === \"string\") return target.updateScript;\n        } catch (e3) { }\n\n        return \"\";\n    }\n\n    function writeUpdateScriptToTarget(target, source, ed) {\n        var src = s(source);\n        if (!target) return { ok: false, reason: \"target missing\" };\n\n        // Remove existing update script if supported\n        try { if (isFn(target.removeScript)) target.removeScript(\"update\"); } catch (e0) { }\n\n        // 1) Signature: addScript(\"update\", source)\n        try {\n            if (isFn(target.addScript)) {\n                try {\n                    target.addScript(\"update\", src);\n                    markDirty(ed);\n                    return { ok: true, mode: \"addScript(name,src)\" };\n                } catch (e1) { }\n                // 2) Signature: addScript({ name:\"update\", source:\"...\" })\n                try {\n                    target.addScript({ name: \"update\", source: src });\n                    markDirty(ed);\n                    return { ok: true, mode: \"addScript(obj)\" };\n                } catch (e2) { }\n                // 3) Signature: addScript({ name:\"update\", code:\"...\" })\n                try {\n                    target.addScript({ name: \"update\", code: src });\n                    markDirty(ed);\n                    return { ok: true, mode: \"addScript(objCode)\" };\n                } catch (e3) { }\n            }\n        } catch (e4) { }\n\n        // 4) Signature: setScript(\"update\", src)\n        try {\n            if (isFn(target.setScript)) {\n                target.setScript(\"update\", src);\n                markDirty(ed);\n                return { ok: true, mode: \"setScript(update)\" };\n            }\n        } catch (e5) { }\n\n        // 5) Property set\n        try {\n            if (target.scripts && typeof target.scripts === \"object\") {\n                target.scripts.update = src;\n                markDirty(ed);\n                return { ok: true, mode: \"scripts.update\" };\n            }\n        } catch (e6) { }\n\n        try {\n            target.updateScript = src;\n            markDirty(ed);\n            return { ok: true, mode: \"updateScript\" };\n        } catch (e7) { }\n\n        return { ok: false, reason: \"no supported update script api\" };\n    }\n\n    function getUpdateScriptOnSelection() {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!ed || !obj) return \"\";\n        var target = resolveScriptTarget(obj);\n        if (!target) return \"\";\n        return s(readUpdateScriptFromTarget(target));\n    }\n\n    function setUpdateScriptOnSelection(source) {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!ed || !obj) return { ok: false, reason: \"nothing selected\" };\n        var target = resolveScriptTarget(obj);\n        if (!target) return { ok: false, reason: \"selection not scriptable\" };\n        return writeUpdateScriptToTarget(target, source, ed);\n    }\n\n    function getUpdateScriptByInfo(info) {\n        var targetObj = findObjectByInfo(info);\n        if (!targetObj) return \"\";\n        var target = resolveScriptTarget(targetObj);\n        if (!target) return \"\";\n        return s(readUpdateScriptFromTarget(target));\n    }\n\n    function setUpdateScriptByInfo(info, source) {\n        var targetObj = findObjectByInfo(info);\n        if (!targetObj) return { ok: false, reason: \"target not found\", info: info };\n        var ed = getEditor();\n        var target = resolveScriptTarget(targetObj);\n        if (!target) return { ok: false, reason: \"target not scriptable\" };\n        return writeUpdateScriptToTarget(target, source, ed);\n    }\n\n\nfunction createClipFromSelection(name) {\n        var ed = getEditor();\n        var project = ed ? ed.project : null;\n        if (!ed || !project) return { ok: false, reason: \"editor or project missing\" };\n\n        var label = s(name).trim();\n        if (!label) label = \"Clip\";\n\n        // 1) Best: Wick engine signature (expects args object)\n        try {\n            if (project && typeof project.createClipFromSelection === \"function\") {\n                project.createClipFromSelection({ identifier: label, type: \"Clip\" });\n                markDirty(ed);\n                return { ok: true, via: \"project.createClipFromSelection(args)\" };\n            }\n        } catch (e1) { }\n\n        // 2) Editor wrappers (varies by build)\n        try {\n            if (ed && typeof ed.createClipFromSelection === \"function\") {\n                // Some builds accept (identifier, toggleExisting=true)\n                ed.createClipFromSelection(label, true);\n                markDirty(ed);\n                return { ok: true, via: \"ed.createClipFromSelection\" };\n            }\n        } catch (e2) { }\n\n        // 3) Older names\n        try {\n            if (ed && typeof ed.convertSelectionToClip === \"function\") {\n                ed.convertSelectionToClip(label);\n                markDirty(ed);\n                return { ok: true, via: \"ed.convertSelectionToClip\" };\n            }\n        } catch (e3) { }\n        try {\n            if (project && typeof project.convertSelectionToClip === \"function\") {\n                project.convertSelectionToClip(label);\n                markDirty(ed);\n                return { ok: true, via: \"project.convertSelectionToClip\" };\n            }\n        } catch (e4) { }\n        try {\n            if (ed && typeof ed.groupSelectionIntoClip === \"function\") {\n                ed.groupSelectionIntoClip(label);\n                markDirty(ed);\n                return { ok: true, via: \"ed.groupSelectionIntoClip\" };\n            }\n        } catch (e5) { }\n        try {\n            if (project && typeof project.groupSelectionIntoClip === \"function\") {\n                project.groupSelectionIntoClip(label);\n                markDirty(ed);\n                return { ok: true, via: \"project.groupSelectionIntoClip\" };\n            }\n        } catch (e6) { }\n\n        // 4) Action manager (React editor)\n        try {\n            if (ed && ed.actionManager && typeof ed.actionManager.doAction === \"function\") {\n                // Newer builds\n                try {\n                    ed.actionManager.doAction([\"createClipFromSelection\"], [label]);\n                    markDirty(ed);\n                    return { ok: true, via: \"actionManager.createClipFromSelection\" };\n                } catch (e7) { }\n                // Older builds\n                try {\n                    ed.actionManager.doAction([\"convertSelectionIntoClip\"], [label]);\n                    markDirty(ed);\n                    return { ok: true, via: \"actionManager.convertSelectionIntoClip\" };\n                } catch (e8) { }\n            }\n        } catch (e9) { }\n\n        return { ok: false, reason: \"no clip creation api found\" };\n    }\n\n    function listKeys(obj, limit) {\n        var out = [];\n        try {\n            var keys = Object.keys(obj || {});\n            for (var i = 0; i < keys.length && i < (limit || 80); i += 1) out.push(keys[i]);\n        } catch (e) { }\n        return out;\n    }\n\n    function getEditorInfo() {\n        var ed = getEditor();\n        var project = getProject();\n        var tl = getSelectedTimeline();\n        return {\n            ok: !!ed,\n            hasProject: !!project,\n            editorKeys: ed ? listKeys(ed, 60) : [],\n            projectKeys: project ? listKeys(project, 60) : [],\n            timelineKeys: tl ? listKeys(tl, 60) : []\n        };\n    }\n\n    var Bridge = window.LukeToolsBridge || {};\n    window.LukeToolsBridge = Bridge;\n\n    Bridge.getEditor = getEditor;\n        Bridge.clearSelectionNow = clearSelectionNow; // FIX\n        Bridge.openGameSpritePanel = openGameSpritePanel; // FIX\n        Bridge.closeGameSpritePanel = closeGameSpritePanel; // FIX\n\n    Bridge.getProject = getProject;\n    Bridge.getEditorInfo = getEditorInfo;\n\n    Bridge.getSelectionInfo = selectionInfo;\n\n    Bridge.captureSelectionNow = function () {\n        try {\n            var info = selectionInfo();\n            if (!info || !info.ok) {\n                try { localStorage.removeItem(STORAGE_SEL_NAME); } catch (e1) { }\n                try { localStorage.removeItem(STORAGE_SEL_UUID); } catch (e2) { }\n                try { localStorage.removeItem(STORAGE_SEL_IDENTIFIER); } catch (e3) { }\n                return { ok: false, reason: \"nothing selected\" };\n            }\n\n            try { localStorage.setItem(STORAGE_SEL_NAME, s(info.name)); } catch (e4) { }\n            try { localStorage.setItem(STORAGE_SEL_UUID, s(info.uuid)); } catch (e5) { }\n            try { localStorage.setItem(STORAGE_SEL_IDENTIFIER, s(info.identifier)); } catch (e6) { }\n\n            return { ok: true, name: s(info.name), uuid: s(info.uuid), identifier: s(info.identifier) };\n        } catch (e7) {\n            return { ok: false, reason: \"capture failed\", error: s(e7 && e7.message ? e7.message : e7) };\n        }\n    };\n\n    Bridge.getSelectedClipName = function () {\n        try { return s(localStorage.getItem(STORAGE_SEL_NAME)); } catch (e1) { return \"\"; }\n    };\n\n    Bridge.getSelectedClipUUID = function () {\n        try { return s(localStorage.getItem(STORAGE_SEL_UUID)); } catch (e2) { return \"\"; }\n    };\n\n    Bridge.getSelectedClipIdentifier = function () {\n        try { return s(localStorage.getItem(STORAGE_SEL_IDENTIFIER)); } catch (e3) { return \"\"; }\n    };\n\n    Bridge.getSelectedObject = function () { return getSelectedObject(getEditor()); };\n    Bridge.getSelectedObjects = function () { return getSelectedObjects(getEditor()); };\n    Bridge.findObjectByUUID = findObjectByUUID;\n    Bridge.findObjectByIdentifier = findObjectByIdentifier;\n    Bridge.findObjectByInfo = findObjectByInfo;\n    Bridge.selectObjectByInfo = function (info) {\n        var ed = getEditor();\n        var o = findObjectByInfo(info);\n        if (!o) return { ok: false, reason: \"target not found\", info: info };\n        return selectObjects(ed, [o]);\n    };\n\n    Bridge.editPropertyOnSelection = editPropertyOnSelection;\n    Bridge.editPropertyByInfo = editPropertyByInfo;\n\n    Bridge.rotateSelection = rotateSelection;\n    Bridge.rotateByInfo = rotateByInfo;\n\n    Bridge.getSelectedClipAsset = getSelectedClipAsset;\n    Bridge.getSelectedTimeline = getSelectedTimeline;\n\n    Bridge.getDefaultScriptOnSelection = getDefaultScriptOnSelection;\n    Bridge.setDefaultScriptOnSelection = function (source) {\n        return setDefaultScriptOnSelection(source);\n    };\n\n    Bridge.getDefaultScriptByInfo = getDefaultScriptByInfo;\n    Bridge.setDefaultScriptByInfo = setDefaultScriptByInfo;\n\n    Bridge.getUpdateScriptOnSelection = getUpdateScriptOnSelection; // FIX\n    Bridge.setUpdateScriptOnSelection = function (source) { // FIX\n        return setUpdateScriptOnSelection(source); // FIX\n    }; // FIX\n\n    Bridge.getUpdateScriptByInfo = getUpdateScriptByInfo; // FIX\n    Bridge.setUpdateScriptByInfo = setUpdateScriptByInfo; // FIX\n\n\n    Bridge.createClipFromSelection = createClipFromSelection;\n\n\n    // Added bridge functions for the full Luke Tools feature set\n\n    function getObjXYLoose(obj) {\n        if (!obj) return { ok: false, x: 0, y: 0 };\n        try { if (typeof obj.x === \"number\" && typeof obj.y === \"number\") return { ok: true, x: obj.x, y: obj.y }; } catch (e1) { }\n        try { if (obj.position && typeof obj.position.x === \"number\" && typeof obj.position.y === \"number\") return { ok: true, x: obj.position.x, y: obj.position.y }; } catch (e2) { }\n        try { if (obj.translation && typeof obj.translation.x === \"number\" && typeof obj.translation.y === \"number\") return { ok: true, x: obj.translation.x, y: obj.translation.y }; } catch (e3) { }\n        return { ok: false, x: 0, y: 0 };\n    }\n\n    function setObjXYLoose(obj, x, y) {\n        if (!obj) return false;\n        var nx = Number(x || 0);\n        var ny = Number(y || 0);\n        if (!isFinite(nx) || !isFinite(ny)) return false;\n\n        var did = false;\n        try {\n            if (typeof obj.x === \"number\" && typeof obj.y === \"number\") {\n                obj.x = nx;\n                obj.y = ny;\n                did = true;\n            }\n        } catch (e1) { }\n\n        try {\n            if (!did && obj.position && typeof obj.position.x === \"number\" && typeof obj.position.y === \"number\") {\n                obj.position.x = nx;\n                obj.position.y = ny;\n                did = true;\n            }\n        } catch (e2) { }\n\n        try {\n            if (!did && obj.translation && typeof obj.translation.x === \"number\" && typeof obj.translation.y === \"number\") {\n                obj.translation.x = nx;\n                obj.translation.y = ny;\n                did = true;\n            }\n        } catch (e3) { }\n\n        return did;\n    }\n\n    function iterateClipAssetChildrenAllFrames(clipAsset, visitor) {\n        if (!clipAsset || !clipAsset.timeline || !clipAsset.timeline.layers) return;\n        var layers = clipAsset.timeline.layers;\n        for (var i = 0; i < layers.length; i += 1) {\n            var layer = layers[i];\n            if (!layer || !layer.frames) continue;\n            for (var j = 0; j < layer.frames.length; j += 1) {\n                var fr = layer.frames[j];\n                if (!fr || !fr.children) continue;\n                for (var k = 0; k < fr.children.length; k += 1) {\n                    var child = fr.children[k];\n                    if (!child) continue;\n                    visitor(child, fr, layer, clipAsset);\n                }\n            }\n        }\n    }\n\n    function getApproxBoundsLoose(obj) {\n        if (!obj) return null;\n\n        try {\n            if (obj.bounds && typeof obj.bounds.x === \"number\") {\n                return { x: obj.bounds.x, y: obj.bounds.y, w: obj.bounds.width || 0, h: obj.bounds.height || 0 };\n            }\n        } catch (e1) { }\n\n        try {\n            if (typeof obj.getBounds === \"function\") {\n                var b = obj.getBounds();\n                if (b && typeof b.x === \"number\") {\n                    return { x: b.x, y: b.y, w: b.width || 0, h: b.height || 0 };\n                }\n            }\n        } catch (e2) { }\n\n        try {\n            if (typeof obj.getBoundingBox === \"function\") {\n                var bb = obj.getBoundingBox();\n                if (bb && typeof bb.x === \"number\") {\n                    return { x: bb.x, y: bb.y, w: bb.width || 0, h: bb.height || 0 };\n                }\n            }\n        } catch (e3) { }\n\n        var xy = getObjXYLoose(obj);\n        if (xy.ok) return { x: xy.x, y: xy.y, w: 0, h: 0 };\n        return null;\n    }\n\n    function computePivotForClipAsset(clipAsset) {\n        if (!clipAsset) return { ok: false, x: 0, y: 0, mode: \"none\" };\n\n        var minX = Infinity;\n        var minY = Infinity;\n        var maxX = -Infinity;\n        var maxY = -Infinity;\n        var any = false;\n\n        iterateClipAssetChildrenAllFrames(clipAsset, function (o) {\n            var b = getApproxBoundsLoose(o);\n            if (!b) return;\n            any = true;\n            var x1 = b.x;\n            var y1 = b.y;\n            var x2 = b.x + (b.w || 0);\n            var y2 = b.y + (b.h || 0);\n            if (x1 < minX) minX = x1;\n            if (y1 < minY) minY = y1;\n            if (x2 > maxX) maxX = x2;\n            if (y2 > maxY) maxY = y2;\n        });\n\n        if (!any) return { ok: false, x: 0, y: 0, mode: \"empty\" };\n\n        // A rig friendly pivot: left edge, vertical center\n        var cx = minX;\n        var cy = (minY + maxY) / 2;\n\n        if (!isFinite(cx)) cx = 0;\n        if (!isFinite(cy)) cy = 0;\n\n        return { ok: true, x: cx, y: cy, mode: \"bounds_left_center\" };\n    }\n\n    function offsetClipAssetAllFrames(clipAsset, dx, dy) {\n        if (!clipAsset) return { ok: false, reason: \"no clipAsset\" };\n        var odx = Number(dx || 0);\n        var ody = Number(dy || 0);\n        if (!isFinite(odx) || !isFinite(ody)) return { ok: false, reason: \"bad delta\" };\n\n        var moved = 0;\n        iterateClipAssetChildrenAllFrames(clipAsset, function (o) {\n            var xy = getObjXYLoose(o);\n            if (!xy.ok) return;\n            if (setObjXYLoose(o, xy.x + odx, xy.y + ody)) moved += 1;\n        });\n\n        return { ok: true, moved: moved, dx: odx, dy: ody };\n    }\n\n    function recenterClipInstanceToPivot(instance, pivotInfo) {\n        if (!instance) return { ok: false, reason: \"no instance\" };\n        var clipAsset = null;\n        try { clipAsset = instance.clipAsset || null; } catch (e1) { clipAsset = null; }\n        if (!clipAsset) return { ok: false, reason: \"instance has no clipAsset\" };\n\n        var p = pivotInfo || computePivotForClipAsset(clipAsset);\n        if (!p || !p.ok) return { ok: false, reason: \"pivot not found\" };\n\n        var inner = offsetClipAssetAllFrames(clipAsset, -p.x, -p.y);\n\n        var ixy = getObjXYLoose(instance);\n        if (ixy.ok) setObjXYLoose(instance, ixy.x + p.x, ixy.y + p.y);\n\n        return { ok: true, pivot: p, inner: inner };\n    }\n\n    function findFirstByIdentifierInClipAsset(clipAsset, wantIdentifier) {\n        var want = s(wantIdentifier).trim();\n        if (!want) return null;\n        var found = null;\n\n        iterateClipAssetChildrenAllFrames(clipAsset, function (o) {\n            if (found) return;\n            var id = \"\";\n            try { id = getObjIdentifier(o); } catch (e1) { id = \"\"; }\n            if (id && id === want) found = o;\n        });\n\n        return found;\n    }\n\n    function resetLukeTools() {\n        try {\n            var rt = ensureRuntime();\n            if (rt && typeof rt.kill === \"function\") rt.kill();\n            else if (rt) rt.killed = true;\n        } catch (e0) { }\n\n        // Remove UI\n        var ids = [PANEL_ID, LAUNCHER_ID, OVERLAY_ID];\n        for (var i = 0; i < ids.length; i += 1) {\n            var el = document.getElementById(ids[i]);\n            if (el && el.parentNode) {\n                try { el.parentNode.removeChild(el); } catch (e1) { }\n            }\n        }\n\n        // Clear LukeTools localStorage keys\n        try {\n            var killKeys = [];\n            for (var j = 0; j < localStorage.length; j += 1) {\n                var k = localStorage.key(j);\n                if (!k) continue;\n                if (String(k).indexOf(\"LukeTools\") === 0) killKeys.push(k);\n            }\n            for (var m = 0; m < killKeys.length; m += 1) {\n                try { localStorage.removeItem(killKeys[m]); } catch (e2) { }\n            }\n        } catch (e3) { }\n\n        // Clear guard flags that might block reinit\n        try {\n            for (var n = 0; n < 40; n += 1) {\n                var g = \"LukeToolsLocalPanelBridgeLoaded_\" + String(n);\n                try { delete window[g]; } catch (e4) { }\n            }\n        } catch (e5) { }\n\n        // Remove bridge references\n        try { delete window.LukeToolsBridge; } catch (e6) { }\n        try { delete window[RUNTIME_KEY]; } catch (e7) { }\n\n        return { ok: true };\n    }\n\n    Bridge.closeFullscreenTool = function () {\n        closeFullscreen();\n        return { ok: true };\n    };\n\n    Bridge.openToolFromUrl = function (url, opts) {\n        return openToolFromUrl(url, opts);\n    };\n\n    Bridge.openToolFromUrlInPanel = function (url) {\n        return openToolFromUrl(url, { target: \"panel\" });\n    };\n\n    Bridge.openToolFromUrlFullscreen = function (url) {\n        return openToolFromUrl(url, { target: \"fullscreen\" });\n    };\n\n    Bridge.resetLukeTools = function () {\n        return resetLukeTools();\n    };\n\n    // Repair broken scripts across the whole project (most importantly \"default\")\n    // This is a recovery tool for when a clip/frame script gets polluted with invalid JS.\n    Bridge.repairProjectDefaultScripts = function (opts) {\n        opts = opts || {};\n\n        var onlyDefault = (opts.onlyDefault !== false); // default true\n        var clearBroken = (opts.clearBroken !== false); // default true\n        var reportOnly = !!opts.reportOnly; // default false\n        var doBackup = (opts.backup !== false); // default true\n        var backupPrefix = String(opts.backupPrefix || \"LukeToolsBrokenScriptBackup\");\n        var maxOwners = (typeof opts.maxOwners === \"number\") ? opts.maxOwners : 200000;\n\n        var ed = null;\n        var project = null;\n\n        try { ed = Bridge.getEditor(); } catch (e1) { ed = null; }\n        try { project = Bridge.getProject(); } catch (e2) { project = null; }\n\n        if (!project) {\n            return { ok: false, reason: \"No project available\" };\n        }\n\n        function z(n) { return (n < 10 ? \"0\" : \"\") + String(n); }\n        function stamp() {\n            try {\n                var d = new Date();\n                return d.getFullYear() + \"-\" + z(d.getMonth() + 1) + \"-\" + z(d.getDate()) + \"_\" + z(d.getHours()) + \"-\" + z(d.getMinutes()) + \"-\" + z(d.getSeconds());\n            } catch (e) {\n                return String(Date.now());\n            }\n        }\n\n        function ownerKey(owner, idx) {\n            try {\n                if (owner && (owner.uuid || owner.id)) return String(owner.uuid || owner.id);\n            } catch (e) { }\n            try {\n                return String((owner && owner.classname) ? owner.classname : \"obj\") + \":\" +\n                    String((owner && (owner.identifier || owner.name)) ? (owner.identifier || owner.name) : \"\") + \":\" +\n                    String(idx);\n            } catch (e2) { }\n            return \"obj:\" + String(idx);\n        }\n\n        function safeGetScripts(owner) {\n            try {\n                if (owner && owner.scripts && Array.isArray(owner.scripts)) return owner.scripts;\n            } catch (e1) { }\n            try {\n                if (owner && typeof owner.getScripts === \"function\") return owner.getScripts();\n            } catch (e2) { }\n            return null;\n        }\n\n        function tryCompile(src) {\n            try {\n                /* eslint-disable no-new-func */\n                new Function(String(src || \"\"));\n                /* eslint-enable no-new-func */\n                return { ok: true };\n            } catch (err) {\n                return { ok: false, err: err };\n            }\n        }\n\n        function backupScript(owner, scriptName, src) {\n            if (!doBackup) return false;\n            try {\n                var key = backupPrefix + \"_\" + stamp() + \"_\" + ownerKey(owner, 0) + \"_\" + String(scriptName || \"default\");\n                localStorage.setItem(key, String(src || \"\"));\n                return true;\n            } catch (e) {\n                return false;\n            }\n        }\n\n        function clearScript(scriptObj) {\n            try {\n                scriptObj.src = \"\";\n                return true;\n            } catch (e) {\n                return false;\n            }\n        }\n\n        // --- Collect candidates (DEEP) ---\n        var owners = [];\n        try { owners.push(project); } catch (e0) { }\n        try { if (project.root) owners.push(project.root); } catch (e1) { }\n\n        try {\n            if (typeof project.getAllFrames === \"function\") {\n                owners = owners.concat(project.getAllFrames());\n            }\n        } catch (e2) { }\n\n        try {\n            if (typeof project.getChildrenRecursive === \"function\") {\n                var kids = project.getChildrenRecursive(0, true);\n                if (kids && kids.length) owners = owners.concat(kids);\n            }\n        } catch (e3) { }\n\n        // Deduplicate\n        var seen = {};\n        var uniq = [];\n        for (var i = 0; i < owners.length && uniq.length < maxOwners; i++) {\n            var o = owners[i];\n            if (!o) continue;\n            var k = ownerKey(o, i);\n            if (seen[k]) continue;\n            seen[k] = true;\n            uniq.push(o);\n        }\n        owners = uniq;\n\n        var result = {\n            ok: true,\n            owners: owners.length,\n            scriptsChecked: 0,\n            badScripts: 0,\n            cleared: 0,\n            backedUp: 0,\n            details: []\n        };\n\n        // --- Scan + fix ---\n        for (var oi = 0; oi < owners.length; oi++) {\n            var owner = owners[oi];\n            var scripts = safeGetScripts(owner);\n            if (!scripts || !scripts.length) continue;\n\n            for (var si = 0; si < scripts.length; si++) {\n                var sc = scripts[si];\n                if (!sc) continue;\n                if (onlyDefault && sc.name !== \"default\") continue;\n\n                var src = \"\";\n                try { src = String(sc.src || \"\"); } catch (eS) { src = \"\"; }\n                if (!src.trim()) continue;\n\n                result.scriptsChecked++;\n\n                var compiled = tryCompile(src);\n                if (compiled.ok) continue;\n\n                result.badScripts++;\n\n                var ownerName = \"\";\n                try { ownerName = String(owner.identifier || owner.name || owner.classname || \"\"); } catch (eN) { ownerName = \"\"; }\n\n                var info = {\n                    owner: ownerName,\n                    ownerUUID: (owner && (owner.uuid || owner.id)) ? String(owner.uuid || owner.id) : \"\",\n                    script: String(sc.name || \"default\"),\n                    message: (compiled.err && compiled.err.message) ? String(compiled.err.message) : \"Unknown error\"\n                };\n\n                if (clearBroken && !reportOnly) {\n                    if (backupScript(owner, sc.name, src)) result.backedUp++;\n                    if (clearScript(sc)) result.cleared++;\n                    info.action = \"cleared\";\n                } else {\n                    info.action = \"reported\";\n                }\n\n                result.details.push(info);\n            }\n        }\n\n        // Refresh editor UI\n        try { if (ed && typeof ed.projectDidChange === \"function\") ed.projectDidChange(); } catch (e4) { }\n        try { if (ed && typeof ed.syncInterfaces === \"function\") ed.syncInterfaces(); } catch (e5) { }\n        try { if (ed && typeof ed.updateUI === \"function\") ed.updateUI(); } catch (e6) { }\n        try { if (ed && typeof ed.refresh === \"function\") ed.refresh(); } catch (e7) { }\n\n        return result;\n    };\n\n\n    Bridge.recenterClipContentsOnSelection = function () {\n        var ed = getEditor();\n        var obj = getSelectedObject(ed);\n        if (!obj) return { ok: false, reason: \"nothing selected\" };\n\n        var r = recenterClipInstanceToPivot(obj, null);\n        if (!r.ok) return r;\n\n        markDirty(ed);\n        tryRefreshSelectionWithoutDeselect(ed);\n\n        return r;\n    };\n\n    Bridge.arrangeArmRigOnSelection = function () {\n        var ed = getEditor();\n        var selected = getSelectedObject(ed);\n        if (!selected) return { ok: false, reason: \"nothing selected\" };\n\n        var arm = null;\n        var selId = getObjIdentifier(selected);\n        if (selId === \"Arm_R\") arm = selected;\n\n        if (!arm) {\n            try {\n                if (selected.clipAsset) arm = findFirstByIdentifierInClipAsset(selected.clipAsset, \"Arm_R\");\n            } catch (e1) { }\n        }\n\n        if (!arm) {\n            arm = findObjectByIdentifier(\"Arm_R\");\n            if (!arm) arm = findObjectByInfo({ identifier: \"Arm_R\" });\n        }\n\n        if (!arm) return { ok: false, reason: \"Arm_R not found\" };\n\n        var shoulder = null;\n        var elbow = null;\n\n        try {\n            if (arm.clipAsset) shoulder = findFirstByIdentifierInClipAsset(arm.clipAsset, \"Shoulder_R\");\n            if (shoulder && shoulder.clipAsset) elbow = findFirstByIdentifierInClipAsset(shoulder.clipAsset, \"Elbow_R\");\n        } catch (e2) { }\n\n        var out = { ok: true, steps: [] };\n\n        if (elbow) out.steps.push({ name: \"Elbow_R\", result: recenterClipInstanceToPivot(elbow, null) });\n        if (shoulder) out.steps.push({ name: \"Shoulder_R\", result: recenterClipInstanceToPivot(shoulder, null) });\n        out.steps.push({ name: \"Arm_R\", result: recenterClipInstanceToPivot(arm, null) });\n\n        markDirty(ed);\n        tryRefreshSelectionWithoutDeselect(ed);\n\n        return out;\n    };\n\n    Bridge._debug = {\n        walkProjectChildren: walkProjectChildren,\n        listKeys: listKeys,\n        nowMs: nowMs\n    };\n\n    function toolCssAndBridgeInject() {\n        var css =\n            \"<style>\" +\n            \"html,body{margin:0;padding:0;background:transparent;font-family:Arial, sans serif;}\" +\n            \"body{color:#eaeaea;}\" +\n            \"</style>\";\n\n        var script =\n            \"<script>\" +\n            \"try{window.LukeToolsBridge=parent.LukeToolsBridge;}catch(e1){}try{window.LukeToolsRuntime=parent.LukeToolsRuntime;}catch(e2){}\" +\n            \"(function(){function h(){try{var d=document.documentElement;var b=document.body;\" +\n            \"var v=Math.max(d?d.scrollHeight:0,b?b.scrollHeight:0,d?d.offsetHeight:0,b?b.offsetHeight:0);\" +\n            \"parent.postMessage({type:'LukeToolsToolHeight',h:v},'*');}catch(e){}}\" +\n            \"window.addEventListener('load',h);\" +\n            \"try{new ResizeObserver(h).observe(document.documentElement);}catch(e){}\" +\n            \"setInterval(h,300);\" +\n\"})();\" +\n            \"</script>\";\n\n        return css + script;\n    }\n\n    function ensureHtmlDocument(htmlText) {\n        var txt = s(htmlText);\n        var inject = toolCssAndBridgeInject();\n\n        if (/<html[\\s>]/i.test(txt)) {\n            if (/<head[\\s>]/i.test(txt)) {\n                txt = txt.replace(/<head[^>]*>/i, function (m) {\n                    return m + \"<meta charset=\\\"utf-8\\\">\" + inject;\n                });\n            } else {\n                txt = txt.replace(/<html[^>]*>/i, function (m) {\n                    return m + \"<head><meta charset=\\\"utf-8\\\">\" + inject + \"</head>\";\n                });\n            }\n            return txt;\n        }\n\n        return (\n            \"<!doctype html>\" +\n            \"<html>\" +\n            \"<head>\" +\n            \"<meta charset=\\\"utf-8\\\">\" +\n            inject +\n            \"</head>\" +\n            \"<body>\" +\n            txt +\n            \"</body>\" +\n            \"</html>\"\n        );\n    }\n\n    function __LT_wrapJsToolAsHtml(jsText) { // FIX: sandbox import JS runner\n        var js = s(jsText || \"\");\n        // Prevent accidental closing of the script tag\n        try { js = js.replace(/<\\/script/gi, \"<\\\\/script\"); } catch (e) { }\n        return \"<!doctype html><html><head><meta charset=\\\"utf-8\\\"></head><body style=\\\"margin:0;background:#111;color:#eee;font-family:Arial,sans-serif\\\">\"\n            + \"<script>\\n\" + js + \"\\n<\\/script></body></html>\";\n    }\n\n\n\n    function getDockNode() { // FIX: dock launcher inside wick-canvas-container to remove gap and prevent drifting\n        try {\n            var c = document.getElementById(\"wick-canvas-container\"); // FIX\n            if (c) return c; // FIX\n        } catch (e0) { }\n        try { return document.body; } catch (e1) { return null; }\n    }\n\n    function __LT_getOutlinerToggleButton() { // FIX: locate the Outliner toggle so Luke Tools can stack directly under it\n        // FIX: Prefer id based lookup first to avoid matching the Luke Tools launcher which shares the same class names\n        try {\n            var byId = document.getElementById(\"action-button-tooltip-outliner-toggle\"); // FIX\n            if (byId && String(byId.tagName || \"\").toLowerCase() === \"button\" && byId.getBoundingClientRect) { // FIX\n                var ir = byId.getBoundingClientRect(); // FIX\n                if (ir && ir.width > 0 && ir.height > 0) return byId; // FIX\n            }\n        } catch (e0) { }\n\n        // Prefer the actual Outliner expand button in the canvas UI, but never return the Luke Tools launcher\n        try {\n            var exactAll = document.querySelectorAll(\"button.wick-button.action-button-tool.action-button.outliner-expand-button\"); // FIX\n            for (var ei = 0; ei < exactAll.length; ei++) { // FIX\n                var exact = exactAll[ei]; // FIX\n                if (!exact) continue; // FIX\n                if (exact.id && exact.id === LAUNCHER_ID) continue; // FIX\n                if (exact.getAttribute && exact.getAttribute(\"data-lt-launcher\") === \"1\") continue; // FIX\n                if (exact.getBoundingClientRect) { // FIX\n                    var er = exact.getBoundingClientRect(); // FIX\n                    if (er && er.width > 0 && er.height > 0) return exact; // FIX\n                }\n            }\n        } catch (e00) { }\n\n        // Fallback: scan candidates and pick the first visible button\n        try {\n            var buttons = document.querySelectorAll(\"button.outliner-expand-button\"); // FIX\n            for (var i = 0; i < buttons.length; i++) {\n                var b = buttons[i];\n                if (!b) continue;\n                if (b.id && b.id === LAUNCHER_ID) continue;\n                if (b.getAttribute && b.getAttribute(\"data-lt-launcher\") === \"1\") continue; // FIX\n                if (!b.getBoundingClientRect) continue;\n                var r = b.getBoundingClientRect();\n                if (!r || r.width <= 0 || r.height <= 0) continue; // FIX: skip hidden\n                // Prefer the one that actually contains the outliner icon\n                try {\n                    var img = b.querySelector && b.querySelector(\"img.outliner-toggle-icon\");\n                    if (img) return b;\n                } catch (e2) { }\n                return b; // FIX: visible candidate\n            }\n        } catch (e) { }\n        return null;\n    }\n\n    function __LT_getVisibleSplashZIndex() { // FIX: keep LT toggle behind any splash or modal overlay when present\n        try {\n            var candidates = [];\n            var overlayCandidates = [];\n\n            // ---- Splash candidates (existing behavior) ----\n            try { var a = document.getElementById(\"splash-screen\"); if (a) candidates.push(a); } catch (e0) { }\n            try { var b = document.getElementById(\"wick-splash-screen\"); if (b) candidates.push(b); } catch (e1) { }\n            try { var c = document.getElementById(\"wick-editor-splash\"); if (c) candidates.push(c); } catch (e2) { }\n\n            try {\n                var list = document.querySelectorAll(\"[class*='splash'], [id*='splash']\");\n                for (var i = 0; i < list.length; i++) candidates.push(list[i]);\n            } catch (e3) { }\n\n            // ---- Modal and overlay candidates (new) ----\n            try {\n                var ol = document.querySelectorAll(\n                    \".ReactModal__Overlay, [class*='modal-backdrop'], [class*='modal-overlay'], [class*='overlay'], [id*='overlay'], [class*='backdrop']\"\n                );\n                for (var j = 0; j < ol.length; j++) overlayCandidates.push(ol[j]);\n            } catch (e4) { }\n\n            try {\n                var dlg = document.querySelectorAll(\n                    \".ReactModal__Content, [role='dialog'], [class*='modal'], [class*='dialog']\"\n                );\n                for (var k = 0; k < dlg.length; k++) candidates.push(dlg[k]);\n            } catch (e5) { }\n\n            function isVisibleBlocking(el) {\n                try {\n                    if (!el) return false;\n                    // Never treat the LT launcher as a blocker\n                    try {\n                        if (el.getAttribute && el.getAttribute(\"data-lt-launcher\") === \"1\") return false;\n                    } catch (eA) { }\n\n                    if (el === document.body || el === document.documentElement) return false;\n\n                    var cs = getComputedStyle(el);\n                    if (!cs) return false;\n                    if (cs.display === \"none\" || cs.visibility === \"hidden\") return false;\n                    if (parseFloat(cs.opacity || \"1\") === 0) return false;\n\n                    // Must be positioned overlay-like, or be a ReactModal overlay/content\n                    var pos = String(cs.position || \"\");\n                    var looksOverlay = (pos === \"fixed\" || pos === \"absolute\");\n                    var cls = \"\";\n                    try { cls = (el.className && String(el.className)) ? String(el.className) : \"\"; } catch (eB) { cls = \"\"; }\n                    if (!looksOverlay && cls.indexOf(\"ReactModal\") === -1) return false;\n\n                    // Must have real size (avoid tiny icons)\n                    var r = el.getBoundingClientRect ? el.getBoundingClientRect() : null;\n                    if (!r) return false;\n                    if (r.width < 50 || r.height < 50) return false;\n\n                    // If it's an overlay/backdrop, it should cover a big portion of the viewport\n                    if (cls.indexOf(\"Overlay\") !== -1 || cls.indexOf(\"backdrop\") !== -1 || cls.indexOf(\"overlay\") !== -1) {\n                        if (r.width < (window.innerWidth * 0.4) || r.height < (window.innerHeight * 0.4)) return false;\n                    }\n\n                    return true;\n                } catch (e) {\n                    return false;\n                }\n            }\n\n            function bestZ(list) {\n                var best = null;\n                for (var i = 0; i < list.length; i++) {\n                    var el = list[i];\n                    if (!isVisibleBlocking(el)) continue;\n                    try {\n                        var cs = getComputedStyle(el);\n                        var z = parseInt(cs && cs.zIndex ? cs.zIndex : \"\", 10);\n                        if (!isFinite(z)) continue;\n                        if (best === null || z > best) best = z;\n                    } catch (e) { }\n                }\n                return best;\n            }\n\n            var bestOverlay = bestZ(overlayCandidates);\n            var bestAny = bestZ(candidates);\n\n            // Prefer overlay/backdrop z-index when available so we go under the greyed-out layer\n            if (bestOverlay !== null && bestOverlay !== undefined) return bestOverlay;\n            return bestAny;\n        } catch (e) {\n            return null;\n        }\n    }\n\n\n\n    function __LT_isBlockingOverlayVisible() { // FIX: detect greyed-out modal overlay even if z-index is 'auto'\n        try {\n            var ol = document.querySelectorAll(\n                \".ReactModal__Overlay, [class*='modal-backdrop'], [class*='modal-overlay'], [class*='overlay'], [id*='overlay'], [class*='backdrop']\"\n            );\n            for (var i = 0; i < ol.length; i++) {\n                var el = ol[i];\n                if (!el) continue;\n                try {\n                    if (el.getAttribute && el.getAttribute(\"data-lt-launcher\") === \"1\") continue;\n                } catch (eA) { }\n                var cs = getComputedStyle(el);\n                if (!cs) continue;\n                if (cs.display === \"none\" || cs.visibility === \"hidden\") continue;\n                if (parseFloat(cs.opacity || \"1\") === 0) continue;\n                var r = el.getBoundingClientRect ? el.getBoundingClientRect() : null;\n                if (!r) continue;\n                if (r.width < (window.innerWidth * 0.4) || r.height < (window.innerHeight * 0.4)) continue;\n                var pos = String(cs.position || \"\");\n                if (pos !== \"fixed\" && pos !== \"absolute\") continue;\n                return true;\n            }\n        } catch (e) { }\n        return false;\n    }\n\n\n\n    // --- NEW: launcher layout from JSON (same folder as script) ---\n    var LAUNCHER_CONFIG_FILENAME = \"launcher-config.json\";\n    var LAUNCHER_CONFIG_LS_KEY = \"LukeToolsLauncherLayoutJSON\";\n\n    function computeFileUrlSameFolder(filename) {\n        try {\n            var cs = document.currentScript;\n            if (cs && cs.src) return new URL(filename, cs.src).href;\n        } catch (e1) { }\n\n        try {\n            var scripts = document.getElementsByTagName(\"script\");\n            var bestSrc = \"\";\n            for (var i = 0; i < scripts.length; i += 1) {\n                var src = \"\";\n                try { src = scripts[i] && scripts[i].src ? String(scripts[i].src) : \"\"; } catch (e2) { src = \"\"; }\n                if (!src) continue;\n                if (src.indexOf(\"BridgeTool\") !== -1) { bestSrc = src; break; }\n                if (!bestSrc && src.indexOf(\"LukeTools\") !== -1) bestSrc = src;\n            }\n            if (bestSrc) return new URL(filename, bestSrc).href;\n        } catch (e3) { }\n\n        return LT_GITHUB_RAW_BASE + filename.replace(/^\\//, \"\"); // FIX\n    }\n\n    function loadLauncherLayoutConfig() { // FIX\n        // Never fetch launcher config from the host site. Only use cached JSON if present.\n        return new Promise(function (resolve) {\n            try {\n                var ls = localStorage.getItem(LAUNCHER_CONFIG_LS_KEY);\n                if (ls) {\n                    try {\n                        var j = JSON.parse(ls);\n                        window.__LT_launcherLayoutCfg = j;\n                        return resolve(j);\n                    } catch (e1) { }\n                }\n            } catch (e2) { }\n            resolve(null); // FIX\n        });\n    }\n\n    // computeFileUrlSameFolder remains for other callers, but loadLauncherLayoutConfig will not use it. // FIX\n\nfunction applyLauncherLayout(btn, cfg) {\n        cfg = cfg || window.__LT_launcherLayoutCfg || {};\n        try {\n            var absLeft = (typeof cfg.left === \"number\") ? cfg.left : null;\n            var absRight = (typeof cfg.right === \"number\") ? cfg.right : null;\n            var absTop = (typeof cfg.top === \"number\") ? cfg.top : null;\n\n            if (absLeft !== null || absRight !== null) {\n                if (absLeft !== null) {\n                    btn.style.left = Math.max(0, Math.round(absLeft)) + \"px\";\n                    btn.style.right = \"auto\";\n                } else {\n                    btn.style.right = Math.max(0, Math.round(absRight)) + \"px\";\n                    btn.style.left = \"auto\";\n                }\n                if (absTop !== null) btn.style.top = Math.max(0, Math.round(absTop)) + \"px\";\n                return;\n            }\n\n            var align = (cfg.alignToOutliner === undefined) ? true : !!cfg.alignToOutliner;\n            if (!align) {\n                btn.style.left = (typeof cfg.offsetX === \"number\" ? cfg.offsetX : 8) + \"px\";\n                btn.style.top = (typeof cfg.offsetY === \"number\" ? cfg.offsetY : 8) + \"px\";\n                return;\n            }\n\n            try {\n                var outBtn = __LT_getOutlinerToggleButton();\n                if (!outBtn) {\n                    btn.style.left = (typeof cfg.offsetX === \"number\" ? cfg.offsetX : 8) + \"px\";\n                    btn.style.top = (typeof cfg.offsetY === \"number\" ? cfg.offsetY : 8) + \"px\";\n                    return;\n                }\n\n                var r = outBtn.getBoundingClientRect();\n                if (!r) {\n                    btn.style.left = (typeof cfg.offsetX === \"number\" ? cfg.offsetX : 8) + \"px\";\n                    btn.style.top = (typeof cfg.offsetY === \"number\" ? cfg.offsetY : 8) + \"px\";\n                    return;\n                }\n\n                var anchor = String(cfg.anchor || \"left\").toLowerCase();\n                var offsetX = Number(cfg.offsetX || 0);\n                var offsetY = Number(cfg.offsetY || 6);\n\n                // FIX: compute positioning relative to wick-canvas-container when docked\n                var dock = getDockNode(); // FIX\n                var dockRect = null; // FIX\n                try { if (dock && dock.getBoundingClientRect) dockRect = dock.getBoundingClientRect(); } catch (eDock) { dockRect = null; } // FIX\n                var docked = !!(dock && dockRect && dock.id === \"wick-canvas-container\" && dock.contains(outBtn)); // FIX: only use container relative coords when the anchor is inside the container\n\n                var left = 0; // FIX\n                var top = 0;  // FIX\n\n                if (docked) { // FIX\n                    left = Math.max(0, Math.round((r.left - dockRect.left) + (anchor === \"left\" ? 0 : (r.width - (btn.offsetWidth || 24))) + offsetX)); // FIX\n                    top = Math.max(0, Math.round((r.top - dockRect.top) + r.height + offsetY)); // FIX\n                    btn.style.position = \"absolute\"; // FIX\n                } else {\n                    left = Math.max(0, Math.round(r.left + (anchor === \"left\" ? 0 : (r.width - (btn.offsetWidth || 24))) + offsetX));\n                    top = Math.max(0, Math.round(r.top + r.height + offsetY));\n                    btn.style.position = \"fixed\"; // FIX\n                }\n// FIX: clamp launcher inside wick-canvas-container so it never goes offscreen\n            if (docked) { // FIX\n                try {\n                    var bw = btn.offsetWidth || 36;\n                    var bh = btn.offsetHeight || 36;\n                    var maxLeft = Math.max(0, Math.round(dockRect.width - bw));\n                    var maxTop = Math.max(0, Math.round(dockRect.height - bh));\n                    if (left > maxLeft) left = maxLeft;\n                    if (top > maxTop) top = maxTop;\n                    if (left < 0) left = 0;\n                    if (top < 0) top = 0;\n                } catch (eClamp) { }\n            }\n            btn.style.left = left + \"px\";\n                btn.style.right = \"auto\";\n                btn.style.top = top + \"px\";\n            } catch (e) {\n                // ignore and use defaults\n            }\n        } catch (e) { }\n    }\n\n    // --- REPLACED: __LT_syncLauncherPosition to consult config offsets if present ---\n    function __LT_syncLauncherPosition(btn) { // FIX: keep launcher aligned under Outliner toggle with no gap\n        try {\n            var cfg = window.__LT_launcherLayoutCfg || {};\n            var outBtn = __LT_getOutlinerToggleButton();\n            if (!outBtn) {\n                if (cfg && (typeof cfg.left === \"number\" || typeof cfg.top === \"number\")) {\n                    applyLauncherLayout(btn, cfg);\n                }\n                return;\n            }\n\n            var r = outBtn.getBoundingClientRect();\n            if (!r) return;\n            try {\n                var splashZ = __LT_getVisibleSplashZIndex(); // FIX\n                var overlayVisible = __LT_isBlockingOverlayVisible(); // FIX\n                if (overlayVisible && (splashZ === null || splashZ === undefined)) { // FIX: overlay present but no numeric z-index found\n                    btn.style.zIndex = \"0\"; // FIX: keep it under overlay that uses z-index 'auto'\n                    btn.style.pointerEvents = \"none\"; // FIX\n                    btn.style.opacity = \"1\"; // FIX\n                } else if (splashZ !== null && splashZ !== undefined) {\n                    var zBelow = splashZ - 1;\n                    if (zBelow < 1) zBelow = 1;\n                    btn.style.zIndex = String(zBelow);\n                    btn.style.pointerEvents = overlayVisible ? \"none\" : \"auto\"; // FIX\n                    btn.style.opacity = \"1\"; // FIX\n                } else {\n                    btn.style.zIndex = \"2000\"; // FIX: normal LT toggle z-index below panels, above canvas, but not extreme\n                    btn.style.pointerEvents = \"auto\"; // FIX\n                    btn.style.opacity = \"1\"; // FIX\n                }\n// FIX: removed stray brace that broke try/catch\n            } catch (eZ) { }\n\n\n            var dock = getDockNode(); // FIX\n            var dockRect = null; // FIX\n            try { if (dock && dock.getBoundingClientRect) dockRect = dock.getBoundingClientRect(); } catch (e0) { dockRect = null; } // FIX\n            var docked = !!(dock && dockRect && dock.id === \"wick-canvas-container\" && dock.contains(outBtn)); // FIX: only use container relative coords when the anchor is inside the container\n\n            var offX = (typeof cfg.offsetX === \"number\") ? cfg.offsetX : 0;\n            var offY = (typeof cfg.offsetY === \"number\") ? cfg.offsetY : 0; // FIX: default no gap\n\n            var left = 0;\n            var top = 0;\n\n            if (docked) { // FIX\n                // Position relative to wick-canvas-container\n                left = Math.max(0, Math.round((r.left - dockRect.left) + offX)); // FIX\n                top = Math.max(0, Math.round((r.top - dockRect.top) + r.height + offY)); // FIX\n                btn.style.position = \"absolute\"; // FIX\n            } else {\n                // Fallback to viewport positioning\n                left = Math.max(0, Math.round(r.left + offX));\n                top = Math.max(0, Math.round(r.top + r.height + offY));\n                btn.style.position = \"fixed\"; // FIX\n            }\n\n            if (cfg && String(cfg.anchor || \"left\").toLowerCase() === \"right\") {\n                if (docked) { // FIX\n                    left = Math.max(0, Math.round((r.left - dockRect.left) + r.width - (btn.offsetWidth || 36) + offX)); // FIX\n                } else {\n                    left = Math.max(0, Math.round(r.left + r.width - (btn.offsetWidth || 36) + offX));\n                }\n            }\n\n            btn.style.left = left + \"px\";\n            btn.style.top = top + \"px\";\n        } catch (e) { }\n    }\n\n\n    function __LT_syncGameSpriteLauncherPosition(btn) { // FIX\n        try {\n            var main = document.getElementById(LAUNCHER_ID);\n            if (!main || !btn) return;\n\n            var r = main.getBoundingClientRect();\n            if (!r) return;\n\n            // FIX: compute the gap above LT (Outliner -> LT) by sampling the element directly above LT on screen\n            var gap = 6; // FIX fallback\n            try {\n                var cx = Math.round(r.left + (r.width / 2));\n                var sampleY = Math.round(r.top - 2);\n                var el = null;\n                try { el = document.elementFromPoint(cx, sampleY); } catch (eP0) { el = null; }\n\n                // walk up to a clickable-ish container\n                var steps = 0;\n                while (el && steps < 6) {\n                    if (el === main) { el = null; break; }\n                    if (el.tagName === \"BUTTON\") break;\n                    var cs = null;\n                    try { cs = window.getComputedStyle(el); } catch (eP1) { cs = null; }\n                    if (cs && cs.cursor === \"pointer\") break;\n                    el = el.parentElement;\n                    steps += 1;\n                }\n\n                if (el) {\n                    var er = el.getBoundingClientRect();\n                    if (er && er.height > 0 && er.width > 0 && er.bottom <= r.top + 2) {\n                        var g = Math.round(r.top - er.bottom);\n                        if (g >= 0 && g <= 40) gap = g; // FIX\n                    }\n                }\n            } catch (eP2) { }\n\n            // FIX: always position relative to viewport so it never docks into left toolbar\n            var left = Math.max(0, Math.round(r.left));\n            var top = Math.max(0, Math.round(r.top + r.height + gap)); // FIX\n\n            btn.style.position = \"fixed\"; // FIX\n            btn.style.left = left + \"px\"; // FIX\n            btn.style.top = top + \"px\"; // FIX\n        } catch (e) { }\n    }\n\n    function __LT_projectHasGameSprite() { // FIX\n        try {\n            var found = false;\n            walkProjectChildren(function (child) {\n                if (found) return;\n                try {\n                    var t = resolveScriptTarget(child);\n                    if (!t) return;\n                    var src = s(readUpdateScriptFromTarget(t));\n                    if (!src) return;\n                    if (src.indexOf(\"LT_GAME_SPRITE\") !== -1) { found = true; return; } // FIX\n                } catch (e1) { }\n            });\n            return found;\n        } catch (e0) { }\n        return false;\n    }\n\n    function __LT_updateGameSpriteToggleVisibility() { // FIX\n        try {\n            var btn = document.getElementById(GAMESPRITE_LAUNCHER_ID);\n            if (!btn) return;\n\n            var show = false;\n\n            // FIX: only show when a clip is selected AND it is a game element (has one of our markers)\n            try {\n                var ed = getEditor();\n                var so = getSelectedObject(ed);\n                if (so) {\n                    var t = resolveScriptTarget(so);\n                    var ss = t ? s(readUpdateScriptFromTarget(t)) : \"\";\n                    if (ss) {\n                        if (ss.indexOf(\"LT_GAME_SPRITE\") !== -1) show = true;\n                        if (ss.indexOf(\"LT_SOLID\") !== -1) show = true;\n                        if (ss.indexOf(\"LT_JUMPTHROUGH\") !== -1) show = true;\n                    }\n                }\n            } catch (e0) { }\n\n            if (show) {\n                try { __LT_syncLauncherPosition(document.getElementById(LAUNCHER_ID)); } catch (eS0) { } // FIX\n                try { __LT_syncGameSpriteLauncherPosition(btn); } catch (eS1) { } // FIX\n                try { __LT_updateGameSpriteToggleIcon(); } catch (eS2) { } // FIX\n                if (btn.style.display !== \"\") btn.style.display = \"\";\n            } else {\n                if (btn.style.display !== \"none\") btn.style.display = \"none\";\n                try { closeGameSpritePanel(); } catch (e1) { } // FIX: hide panel if selection is not a game element\n                try {\n                    var img0 = __LT_getGameSpriteToggleImg();\n                    if (img0) { img0.setAttribute(\"data-lt-src\", LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"); // FIX\n                        img0.src = LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n                    } // FIX\n                } catch (e2) { } // FIX\n            }\n        } catch (e) { }\n    }\n\n\n\n    \n    function __LT_getGameSpriteToggleImg() { // FIX\n        try {\n            var btn = document.getElementById(GAMESPRITE_LAUNCHER_ID);\n            if (!btn) return null;\n            var imgs = btn.getElementsByTagName(\"img\");\n            return (imgs && imgs.length) ? imgs[0] : null;\n        } catch (e) { }\n        return null;\n    }\n\n    \n    function __LT_getPanelConfigObjSync() { // FIX\n        try {\n            if (window.__LT_panelCfgObj && typeof window.__LT_panelCfgObj === \"object\") return window.__LT_panelCfgObj;\n            var raw = \"\";\n            try { raw = localStorage.getItem(STORAGE_PANEL_JSON) || \"\"; } catch (e0) { raw = \"\"; }\n            if (!raw.trim()) return null;\n            try { window.__LT_panelCfgObj = JSON.parse(raw); } catch (e1) { window.__LT_panelCfgObj = null; return null; }\n            return window.__LT_panelCfgObj;\n        } catch (e) { }\n        return null;\n    }\n\n    function __LT_tryFetchPanelConfigOnce() { // FIX\n        try {\n            if (window.__LT_panelCfgFetchStarted) return;\n            window.__LT_panelCfgFetchStarted = true;\n\n            try {\n                fetchText(DEFAULT_PANEL_JSON_URL).then(function (t) {\n                    try { if (t && t.trim()) localStorage.setItem(STORAGE_PANEL_JSON, t); } catch (e2) { }\n                    try { window.__LT_panelCfgObj = null; } catch (e3) { }\n                    try { __LT_updateGameSpriteToggleIcon(); } catch (e4) { }\n                }).catch(function () { });\n            } catch (e1) { }\n        } catch (e) { }\n    }\n\n    function __LT_svgToDataUrl(svgText) { // FIX\n        try {\n            var s0 = String(svgText || \"\");\n            if (!s0.trim()) return \"\";\n            return \"data:image/svg+xml;charset=utf-8,\" + encodeURIComponent(s0);\n        } catch (e) { }\n        return \"\";\n    }\n\n    function __LT_findIconFromPanelConfig(keys) { // FIX\n        try {\n            var cfg = __LT_getPanelConfigObjSync();\n            if (!cfg) {\n                __LT_tryFetchPanelConfigOnce(); // FIX\n                return \"\";\n            }\n\n            var groups = [];\n            if (cfg.groups && Array.isArray(cfg.groups)) groups = cfg.groups;\n            else if (cfg.tabs && Array.isArray(cfg.tabs)) groups = cfg.tabs;\n            else if (cfg.items && Array.isArray(cfg.items)) groups = [{ items: cfg.items }];\n\n            var want = [];\n            for (var i = 0; i < (keys ? keys.length : 0); i += 1) want.push(String(keys[i] || \"\").toLowerCase());\n\n            function matchItem(item) {\n                if (!item) return false;\n                var id = String(item.id || item.key || item.name || \"\").toLowerCase();\n                var label = String(item.label || item.title || \"\").toLowerCase();\n                for (var k = 0; k < want.length; k += 1) {\n                    if (!want[k]) continue;\n                    if (id === want[k] || label === want[k]) return true;\n                    if (id.indexOf(want[k]) !== -1 || label.indexOf(want[k]) !== -1) return true;\n                }\n                return false;\n            }\n\n            for (var g = 0; g < groups.length; g += 1) {\n                var items = (groups[g] && groups[g].items && Array.isArray(groups[g].items)) ? groups[g].items : [];\n                for (var j = 0; j < items.length; j += 1) {\n                    var it = items[j];\n                    if (!matchItem(it)) continue;\n\n                    var url = String(it.iconUrl || \"\").trim();\n                    if (url) return url;\n\n                    var svg = String(it.iconSvg || \"\").trim();\n                    if (svg) {\n                        var du = __LT_svgToDataUrl(svg);\n                        if (du) return du;\n                    }\n                }\n            }\n        } catch (e) { }\n        return \"\";\n    }\n\nfunction __LT_iconForSelectedType() { // FIX\n        try {\n            var ed = getEditor();\n            var so = getSelectedObject(ed);\n            if (!so) return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n            var t = resolveScriptTarget(so);\n            if (!t) return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n\n            var src = s(readUpdateScriptFromTarget(t));\n            if (!src) return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n\n            // FIX: only switch icon if this selection is a game element\n            var isSolid = (src.indexOf(\"LT_SOLID\") !== -1);\n            var isJump = (src.indexOf(\"LT_JUMPTHROUGH\") !== -1);\n            var isSprite = (src.indexOf(\"LT_GAME_SPRITE\") !== -1);\n\n            if (!(isSolid || isJump || isSprite)) return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n\n            // FIX: try to resolve icon from LukeTools panel config first (same config that drives the LT icon panel)\n            try {\n                var keyList = [];\n                if (isSolid) keyList = [\"Solid\", \"LT_SOLID\", \"solid\"];\n                else if (isJump) keyList = [\"JumpThrough\", \"Jump Through\", \"LT_JUMPTHROUGH\", \"jumpthrough\"];\n                else if (isSprite) keyList = [\"SideRunner\", \"Side Runner\", \"GameCharacter\", \"LT_GAME_SPRITE\"];\n\n                var icon = __LT_findIconFromPanelConfig(keyList);\n                if (icon) return icon;\n            } catch (e0) { }\n\n            // FIX: fallback hard map\n            if (isSolid) return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/Solid.svg\"; // FIX\n            if (isJump) return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/JumpThrough.svg\"; // FIX\n            return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n        } catch (e) { }\n        return LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n    }\n\n    function __LT_updateGameSpriteToggleIcon() { // FIX\n        try {\n            var img = __LT_getGameSpriteToggleImg();\n            if (!img) return;\n            var desired = __LT_iconForSelectedType();\n            if (img.getAttribute(\"data-lt-src\") !== desired) {\n                img.setAttribute(\"data-lt-src\", desired);\n                img.src = desired;\n                img.onerror = function () { // FIX\n                    try { img.onerror = null; } catch (e0) { }\n                    try { img.src = desired.replace(/^\\//, \"\"); } catch (e1) { }\n                };\n            }\n        } catch (e) { }\n    }\n\n    function clearSelectionNow() { // FIX\n        try {\n            var ed = getEditor();\n            var sel = getSelectionApi(ed);\n            if (!sel) return false;\n\n            var fns = [\"clear\", \"clearSelection\", \"deselectAll\", \"selectNone\"];\n            for (var i = 0; i < fns.length; i += 1) {\n                var fn = sel[fns[i]];\n                if (isFn(fn)) { try { fn.call(sel); return true; } catch (e0) { } }\n            }\n\n            var fns2 = [\"setSelectedObjects\", \"selectObjects\", \"select\"];\n            for (var j = 0; j < fns2.length; j += 1) {\n                var fn2 = sel[fns2[j]];\n                if (isFn(fn2)) { try { fn2.call(sel, []); return true; } catch (e1) { } }\n            }\n        } catch (e2) { }\n        return false;\n    }\n\n    \n    function __LT_enablePanelDrag(panel, handle) { // FIX\n        try {\n            if (!panel || !handle) return;\n            if (panel.__LT_dragEnabled) return;\n            panel.__LT_dragEnabled = true;\n\n            var dragging = false;\n            var ox = 0;\n            var oy = 0;\n\n            function onDown(e) { // FIX\n                try {\n                    if (!e) return;\n                    dragging = true;\n                    var r = panel.getBoundingClientRect();\n                    ox = (e.clientX || 0) - r.left;\n                    oy = (e.clientY || 0) - r.top;\n                    try { e.preventDefault(); } catch (e0) { }\n                    try { e.stopPropagation(); } catch (e1) { }\n                    document.addEventListener(\"mousemove\", onMove, true);\n                    document.addEventListener(\"mouseup\", onUp, true);\n                } catch (e2) { }\n            }\n\n            function onMove(e) { // FIX\n                try {\n                    if (!dragging) return;\n                    var x = (e.clientX || 0) - ox;\n                    var y = (e.clientY || 0) - oy;\n\n                    var vw = Math.max(320, window.innerWidth || 0);\n                    var vh = Math.max(240, window.innerHeight || 0);\n                    var pw = panel.offsetWidth || 340;\n                    var ph = panel.offsetHeight || 360;\n\n                    if (x + pw > vw - 8) x = vw - pw - 8;\n                    if (y + ph > vh - 8) y = vh - ph - 8;\n                    if (x < 8) x = 8;\n                    if (y < 8) y = 8;\n\n                    panel.style.position = \"fixed\"; // FIX\n                    panel.style.left = Math.round(x) + \"px\"; // FIX\n                    panel.style.top = Math.round(y) + \"px\"; // FIX\n\n                    try { localStorage.setItem(\"LT_GAMESPRITE_PANEL_POS\", JSON.stringify({ x: Math.round(x), y: Math.round(y) })); } catch (e0) { }\n                } catch (e3) { }\n            }\n\n            function onUp(e) { // FIX\n                try {\n                    dragging = false;\n                    document.removeEventListener(\"mousemove\", onMove, true);\n                    document.removeEventListener(\"mouseup\", onUp, true);\n                } catch (e4) { }\n            }\n\n            handle.addEventListener(\"mousedown\", onDown, true); // FIX\n        } catch (e) { }\n    }\n\nfunction __LT_createGameSpritePanelIfMissing() { // FIX\n        try {\n            var existing = document.getElementById(GAMESPRITE_PANEL_ID);\n            if (existing) return existing;\n\n            var dock = getDockNode();\n            if (!dock) return null;\n\n            var panel = document.createElement(\"div\"); // FIX\n            panel.id = GAMESPRITE_PANEL_ID; // FIX\n            panel.style.position = \"absolute\"; // FIX\n            panel.style.zIndex = \"2001\"; // FIX\n            panel.style.width = \"340px\"; // FIX\n            panel.style.height = \"360px\"; // FIX\n            panel.style.display = \"none\"; // FIX\n            panel.style.borderRadius = \"0px\"; // FIX\n            panel.style.overflow = \"hidden\"; // FIX\n            panel.style.boxShadow = \"0 10px 24px rgba(0,0,0,0.45)\"; // FIX\n            panel.style.border = \"1px solid rgba(255,255,255,0.10)\"; // FIX\n            panel.style.background = \"#111\"; // FIX\n\n            \n            var header = document.createElement(\"div\"); // FIX\n            header.id = GAMESPRITE_PANEL_ID + \"_header\"; // FIX\n            header.style.height = \"28px\"; // FIX\n            header.style.display = \"flex\"; // FIX\n            header.style.alignItems = \"center\"; // FIX\n            header.style.justifyContent = \"space-between\"; // FIX\n            header.style.padding = \"0 10px\"; // FIX\n            header.style.cursor = \"move\"; // FIX\n            header.style.userSelect = \"none\"; // FIX\n            header.style.background = \"#1a1a1a\"; // FIX\n            header.style.borderBottom = \"1px solid rgba(255,255,255,0.10)\"; // FIX\n            header.style.fontFamily = \"Arial, Helvetica, sans-serif\"; // FIX\n            header.style.fontSize = \"12px\"; // FIX\n            header.style.color = \"#eee\"; // FIX\n\n            var title = document.createElement(\"div\"); // FIX\n            title.textContent = \"Sprite Settings\"; // FIX\n            title.style.pointerEvents = \"none\"; // FIX\n\n            var closeBtn = document.createElement(\"button\"); // FIX\n            closeBtn.textContent = \"x\"; // FIX\n            closeBtn.style.width = \"26px\"; // FIX\n            closeBtn.style.height = \"22px\"; // FIX\n            closeBtn.style.border = \"1px solid rgba(255,255,255,0.14)\"; // FIX\n            closeBtn.style.background = \"rgba(255,255,255,0.08)\"; // FIX\n            closeBtn.style.color = \"#eee\"; // FIX\n            closeBtn.style.cursor = \"pointer\"; // FIX\n            closeBtn.style.borderRadius = \"0px\"; // FIX\n            closeBtn.addEventListener(\"click\", function (e) { // FIX\n                try { e.preventDefault(); e.stopPropagation(); } catch (e0) { }\n                try { closeGameSpritePanel(); } catch (e1) { }\n            }); // FIX\n\n            header.appendChild(title); // FIX\n            header.appendChild(closeBtn); // FIX\n            panel.appendChild(header); // FIX\n\n            // FIX: draggable panel via header (iframe does not pass mouse events)\n            __LT_enablePanelDrag(panel, header); // FIX\nvar iframe = document.createElement(\"iframe\"); // FIX\n            iframe.id = GAMESPRITE_PANEL_IFRAME_ID; // FIX\n            iframe.style.width = \"100%\"; // FIX\n            iframe.style.height = \"calc(100% - 28px)\"; // FIX\n            iframe.style.border = \"0\"; // FIX\n            iframe.setAttribute(\"sandbox\", \"allow-scripts allow-same-origin\"); // FIX\n            iframe.srcdoc = \"<!doctype html>\\n<html>\\n<head>\\n  <meta charset=\\\"utf-8\\\">\\n  <title>Sprite Settings</title>\\n  <style>\\n    html, body { margin:0; padding:0; font-family: Arial, Helvetica, sans-serif; background:#111; color:#eee; overflow-x:hidden; }\\n    .wrap { padding:12px; }\\n    .card { background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.10); border-radius:0px; padding:12px; box-shadow:0 10px 22px rgba(0,0,0,0.35); }\\n    h1 { font-size:14px; margin:0 0 8px 0; letter-spacing:0.3px; }\\n    .small { font-size:12px; opacity:0.9; line-height:1.35; }\\n    .row { display:flex; flex-direction:column; gap:6px; align-items:stretch; margin:10px 0; }\\n    .row label { width:auto; font-size:12px; opacity:0.95; }\\n    .row input[type=\\\"range\\\"] { width:100%; flex:none; }\\n    .row input[type=\\\"number\\\"] { display:none; }\\n    .btnrow { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }\\n    button { background: rgba(255,255,255,0.10); color:#eee; border:1px solid rgba(255,255,255,0.14); border-radius:0px; padding:8px 10px; cursor:pointer; font-size:12px; }\\n    button:hover { background: rgba(255,255,255,0.14); }\\n    .status { margin-top:8px; font-size:12px; white-space:pre-wrap; opacity:0.95; }\\n    .pill { display:inline-block; padding:3px 8px; border-radius:0px; background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12); font-size:12px; margin-top:6px; max-width:100%; overflow:hidden; text-overflow:ellipsis; vertical-align:middle; }\\n  </style>\\n</head>\\n<body>\\n  <div class=\\\"wrap\\\">\\n    <div class=\\\"card\\\">\\n      <h1>Sprite Settings</h1>\\n      <div class=\\\"small\\\">\\n        Updates LT_CFG in the selected clip update script\\n        <div id=\\\"sel\\\" class=\\\"pill\\\">No selection\\n      <div id=\\\"behMsg\\\" class=\\\"small\\\" style=\\\"margin:8px 0 6px 0; display:none;\\\">No behaviours</div> <!-- FIX -->\\n\\n      <div id=\\\"controls\\\"> <!-- FIX -->\\n</div>\\n      </div>\\n\\n      <div class=\\\"row\\\">\\n        <label for=\\\"gravity\\\">Gravity</label>\\n        <input id=\\\"gravity\\\" type=\\\"range\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"50\\\">\\n        <input id=\\\"gravity_n\\\" type=\\\"number\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"50\\\">\\n      </div>\\n\\n      <div class=\\\"row\\\">\\n        <label for=\\\"maxFall\\\">Fall</label>\\n        <input id=\\\"maxFall\\\" type=\\\"range\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"40\\\">\\n        <input id=\\\"maxFall_n\\\" type=\\\"number\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"40\\\">\\n      </div>\\n\\n      <div class=\\\"row\\\">\\n        <label for=\\\"speed\\\">Speed</label>\\n        <input id=\\\"speed\\\" type=\\\"range\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"20\\\">\\n        <input id=\\\"speed_n\\\" type=\\\"number\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"20\\\">\\n      </div>\\n\\n      <div class=\\\"row\\\">\\n        <label for=\\\"jump\\\">Jump</label>\\n        <input id=\\\"jump\\\" type=\\\"range\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"40\\\">\\n        <input id=\\\"jump_n\\\" type=\\\"number\\\" min=\\\"0\\\" max=\\\"100\\\" step=\\\"1\\\" value=\\\"40\\\">\\n      </div>\\n\\n      \\n      </div> <!-- FIX -->\\n\\n      <div class=\\\"btnrow\\\">\\n        <button id=\\\"btnRefresh\\\" type=\\\"button\\\">Refresh</button>\\n        <button id=\\\"btnApply\\\" type=\\\"button\\\">Apply</button>\\n        <button id=\\\"btnClose\\\" type=\\\"button\\\">Close</button>\\n      </div>\\n\\n      <div id=\\\"status\\\" class=\\\"status\\\"></div>\\n    </div>\\n  </div>\\n\\n  <script>\\n    function $(id){ return document.getElementById(id); }\\n    function B(){ try { return window.parent && window.parent.LukeToolsBridge ? window.parent.LukeToolsBridge : null; } catch(e){ return null; } }\\n    function setStatus(msg){ try { $(\\\"status\\\").textContent = String(msg || \\\"\\\"); } catch(e){} }\\n\\n    function syncPair(rangeId, numId){\\n      var r = $(rangeId), n = $(numId);\\n      if(!r || !n) return;\\n      r.addEventListener(\\\"input\\\", function(){ n.value = r.value; });\\n      n.addEventListener(\\\"input\\\", function(){\\n        var v = Number(n.value);\\n        if(!isFinite(v)) return;\\n        r.value = String(v);\\n      });\\n    }\\n    syncPair(\\\"gravity\\\",\\\"gravity_n\\\");\\n    syncPair(\\\"maxFall\\\",\\\"maxFall_n\\\");\\n    syncPair(\\\"speed\\\",\\\"speed_n\\\");\\n    syncPair(\\\"jump\\\",\\\"jump_n\\\");\\n\\n    function readLTcfg(src){\\n      src = String(src || \\\"\\\");\\n      var m = src.match(/var\\\\s+LT_CFG\\\\s*=\\\\s*(\\\\{.*?\\\\});/);\\n      if(!m) return null;\\n      try { return JSON.parse(m[1]); } catch(e){ return null; }\\n    }\\n    function writeLTcfg(src, obj){\\n      src = String(src || \\\"\\\");\\n      var m = src.match(/var\\\\s+LT_CFG\\\\s*=\\\\s*(\\\\{.*?\\\\});/);\\n      if(!m) return null;\\n      return src.replace(/var\\\\s+LT_CFG\\\\s*=\\\\s*(\\\\{.*?\\\\});/, \\\"var LT_CFG = \\\" + JSON.stringify(obj) + \\\";\\\");\\n    }\\n\\n    function refresh(){\\n      var br = B();\\n      if(!br){ setStatus(\\\"Bridge not found\\\"); return; }\\n      try { if (br.captureSelectionNow) br.captureSelectionNow(); } catch(e0){}\\n      var name = \\\"\\\";\\n      try { name = br.getSelectedClipName ? br.getSelectedClipName() : \\\"\\\"; } catch(e1){}\\n      if(!name){ $(\\\"sel\\\").textContent = \\\"No selection\\\"; setStatus(\\\"Select a game sprite clip then Refresh\\\"); return; }\\n      try { if ($(\\\"behMsg\\\")) $(\\\"behMsg\\\").style.display = \\\"none\\\"; if ($(\\\"controls\\\")) $(\\\"controls\\\").style.display = \\\"none\\\"; try { $(\\\"btnApply\\\").disabled = true; } catch(e0){} } catch(e1){} // FIX\\n      $(\\\"sel\\\").textContent = name;\\n      var src = \\\"\\\";\\n      try { src = br.getUpdateScriptOnSelection ? br.getUpdateScriptOnSelection() : \\\"\\\"; } catch(e2){}\\n      // FIX: do not apply to non game sprites\\n      if (src && src.indexOf(\\\"LT_GAME_SPRITE\\\") === -1) { setStatus(\\\"No behaviours\\\"); return; }\\n\\n      if(!src){ setStatus(\\\"Selected clip has no update script\\\"); return; }\\n      // FIX: only show controls for game sprites\\n      var isSprite = (src.indexOf(\\\"LT_GAME_SPRITE\\\") !== -1);\\n      var behMsg = $(\\\"behMsg\\\");\\n      var controls = $(\\\"controls\\\");\\n      try {\\n        if (!isSprite) {\\n          if (behMsg) { behMsg.style.display = \\\"block\\\"; behMsg.textContent = \\\"No behaviours\\\"; }\\n          if (controls) controls.style.display = \\\"none\\\";\\n          try { $(\\\"btnApply\\\").disabled = true; } catch(eD0){}\\n          setStatus(\\\"No behaviours\\\");\\n          return;\\n        } else {\\n          if (behMsg) behMsg.style.display = \\\"none\\\";\\n          if (controls) controls.style.display = \\\"block\\\";\\n          try { $(\\\"btnApply\\\").disabled = false; } catch(eD1){}\\n        }\\n      } catch(eD2) {}\\n\\n      var cfg = readLTcfg(src);\\n      if(!cfg){ setStatus(\\\"No LT_CFG found\\\"); return; }\\n      if(typeof cfg.gravity===\\\"number\\\"){ $(\\\"gravity\\\").value = cfg.gravity; $(\\\"gravity_n\\\").value = cfg.gravity; }\\n      if(typeof cfg.maxFall===\\\"number\\\"){ $(\\\"maxFall\\\").value = cfg.maxFall; $(\\\"maxFall_n\\\").value = cfg.maxFall; }\\n      if(typeof cfg.speed===\\\"number\\\"){ $(\\\"speed\\\").value = cfg.speed; $(\\\"speed_n\\\").value = cfg.speed; }\\n      if(typeof cfg.jump===\\\"number\\\"){ $(\\\"jump\\\").value = cfg.jump; $(\\\"jump_n\\\").value = cfg.jump; }\\n      setStatus(\\\"Loaded\\\");\\n    }\\n\\n    function apply(){\\n      var br = B();\\n      if(!br){ setStatus(\\\"Bridge not found\\\"); return; }\\n      try { if (br.captureSelectionNow) br.captureSelectionNow(); } catch(e0){}\\n      var src = \\\"\\\";\\n      try { src = br.getUpdateScriptOnSelection ? br.getUpdateScriptOnSelection() : \\\"\\\"; } catch(e2){}\\n      if(!src){ setStatus(\\\"Selected clip has no update script\\\"); return; }\\n      var cfg = readLTcfg(src);\\n      if(!cfg){ setStatus(\\\"No LT_CFG found\\\"); return; }\\n      cfg.gravity = Number($(\\\"gravity_n\\\").value);\\n      cfg.maxFall = Number($(\\\"maxFall_n\\\").value);\\n      cfg.speed = Number($(\\\"speed_n\\\").value);\\n      cfg.jump = Number($(\\\"jump_n\\\").value);\\n      if(!isFinite(cfg.gravity)) cfg.gravity = 50;\\n      if(!isFinite(cfg.maxFall)) cfg.maxFall = 40;\\n      if(!isFinite(cfg.speed)) cfg.speed = 20;\\n      if(!isFinite(cfg.jump)) cfg.jump = 40;\\n      var updated = writeLTcfg(src, cfg);\\n      if(!updated){ setStatus(\\\"Failed to update LT_CFG\\\"); return; }\\n      try { if (br.setUpdateScriptOnSelection) br.setUpdateScriptOnSelection(updated); } catch(e3){}\\n      try { if (br.clearSelectionNow) br.clearSelectionNow(); } catch(e4){}\\n      try { if (br.closeGameSpritePanel) br.closeGameSpritePanel(); } catch(e5){}\\n    }\\n\\n    function closePanel(){ var br = B(); try { if (br && br.closeGameSpritePanel) br.closeGameSpritePanel(); } catch(e0){} }\\n\\n    $(\\\"btnRefresh\\\").addEventListener(\\\"click\\\", refresh);\\n    $(\\\"btnApply\\\").addEventListener(\\\"click\\\", apply);\\n    $(\\\"btnClose\\\").addEventListener(\\\"click\\\", closePanel);\\n\\n    refresh();\\n  </script>\\n</body>\\n</html>\\n\"; // FIX\n            panel.appendChild(iframe); // FIX\n\n            dock.appendChild(panel); // FIX\n            return panel; // FIX\n        } catch (e) { }\n        return null;\n    }\n\n    function __LT_positionGameSpritePanel() { // FIX\n        try {\n            var panel = document.getElementById(GAMESPRITE_PANEL_ID);\n            var btn = document.getElementById(GAMESPRITE_LAUNCHER_ID);\n            if (!panel || !btn) return;\n\n            // FIX: restore last position if user dragged it\n            try {\n                var saved = localStorage.getItem(\"LT_GAMESPRITE_PANEL_POS\") || \"\";\n                if (saved) {\n                    var o = JSON.parse(saved);\n                    if (o && typeof o.x === \"number\" && typeof o.y === \"number\") {\n                        panel.style.position = \"fixed\"; // FIX\n                        panel.style.left = Math.round(o.x) + \"px\"; // FIX\n                        panel.style.top = Math.round(o.y) + \"px\"; // FIX\n                        return; // FIX\n                    }\n                }\n            } catch (e0) { }\n\n            var r = btn.getBoundingClientRect();\n\n            // FIX: prefer opening to the LEFT of the toggle so it never sits under the toggles\n            var pw = panel.offsetWidth || 340;\n            var ph = panel.offsetHeight || 360;\n\n            var left = Math.round(r.left - pw - 10); // FIX\n            var top = Math.round(r.top); // FIX\n\n            var vw = Math.max(320, window.innerWidth || 0);\n            var vh = Math.max(240, window.innerHeight || 0);\n\n            if (left < 8) left = Math.round(r.left + 44); // FIX fallback to right\n            if (left + pw > vw - 8) left = Math.max(8, vw - pw - 8);\n            if (top + ph > vh - 8) top = Math.max(8, vh - ph - 8);\n            if (left < 8) left = 8;\n            if (top < 8) top = 8;\n\n            panel.style.left = left + \"px\";\n            panel.style.top = top + \"px\";\n            panel.style.position = \"fixed\"; // FIX\n        } catch (e) { }\n    }\n\n    function openGameSpritePanel() { // FIX\n        try {\n            // FIX: only open when a clip is selected and it is a game element\n            var ok = false;\n            try {\n                var ed = getEditor();\n                var so = getSelectedObject(ed);\n                if (so) {\n                    var t = resolveScriptTarget(so);\n                    var ss = t ? s(readUpdateScriptFromTarget(t)) : \"\";\n                    if (ss) {\n                        if (ss.indexOf(\"LT_GAME_SPRITE\") !== -1) ok = true;\n                        if (ss.indexOf(\"LT_SOLID\") !== -1) ok = true;\n                        if (ss.indexOf(\"LT_JUMPTHROUGH\") !== -1) ok = true;\n                    }\n                }\n            } catch (e0) { }\n\n            if (!ok) return; // FIX\n\n            var panel = __LT_createGameSpritePanelIfMissing();\n            if (!panel) return;\n            panel.style.display = \"block\";\n            __LT_positionGameSpritePanel();\n        } catch (e) { }\n    }\n\n    function closeGameSpritePanel() { // FIX\n        try {\n            var panel = document.getElementById(GAMESPRITE_PANEL_ID);\n            if (panel) panel.style.display = \"none\";\n        } catch (e) { }\n    }\n\n\nfunction removeLauncher() {\n        try {\n            var old = document.getElementById(LAUNCHER_ID);\n            var oldGS = document.getElementById(GAMESPRITE_LAUNCHER_ID); // FIX\n            var oldGSP = document.getElementById(GAMESPRITE_PANEL_ID); // FIX\n            if (old && old.parentNode) old.parentNode.removeChild(old);\n            if (oldGS && oldGS.parentNode) oldGS.parentNode.removeChild(oldGS); // FIX\n            if (oldGSP && oldGSP.parentNode) oldGSP.parentNode.removeChild(oldGSP); // FIX\n        } catch (e1) { }\n    }\n\n    // --- REPLACED: ensureLauncher to apply loaded config on creation ---\n    function ensureLauncher(showFn) {\n        if (document.getElementById(LAUNCHER_ID)) return;\n\n        var dock = getDockNode();\n        if (!dock) return;\n\n        var btn = document.createElement(\"button\");\n        btn.id = LAUNCHER_ID;\n        btn.setAttribute(\"data-lt-launcher\",\"1\"); // FIX: mark launcher so outliner lookup never returns it\n        btn.type = \"button\";\n        btn.title = \"Luke Tools\";\n        btn.className = \"wick-button  action-button-tool action-button outliner-expand-button\"; // FIX: match Outliner toggle styling\n        btn.style.position = \"absolute\"; // FIX: injected into wick-canvas-container\n        btn.style.zIndex = \"999998\"; // FIX: lower z-index so splash screens can appear above\n        btn.style.right = \"auto\"; // FIX\n        btn.style.left = \"0px\"; // FIX: positioned by sync function\n        btn.style.top = \"0px\"; // FIX: positioned by sync function\n        btn.style.transform = \"none\"; // FIX\n        btn.style.transition = \"none\"; // FIX: prevent animated drift when repositioning\n        try {\n            var csDock = window.getComputedStyle ? window.getComputedStyle(dock) : null;\n            if (csDock && csDock.position === \"static\") dock.style.position = \"relative\"; // FIX: anchor absolute positioning inside wick-canvas-container\n        } catch (eDockPos) { }\n\n        var ltSvg = \"<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'>\" +\n            \"<rect x='2' y='2' width='20' height='20' rx='4' ry='4' fill='none' stroke='white' stroke-width='2'/>\" +\n            \"<path d='M7 7v10h3' fill='none' stroke='white' stroke-width='2' stroke-linecap='round'/>\" +\n            \"<path d='M13 7h4' fill='none' stroke='white' stroke-width='2' stroke-linecap='round'/>\" +\n            \"<path d='M15 7v10' fill='none' stroke='white' stroke-width='2' stroke-linecap='round'/>\" +\n            \"</svg>\";\n        var img = document.createElement(\"img\");\n        img.className = \"img-tool-icon action-button-single-icon outliner-toggle-icon\"; // FIX\n        img.alt = \"Luke Tools\";\n        img.src = \"data:image/svg+xml;utf8,\" + encodeURIComponent(ltSvg); // FIX: inline icon (no external deps)\n        btn.appendChild(img);\n\n        btn.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            try { showFn(); } catch (e0) { }\n        });\n\n        dock.appendChild(btn);\n\n        // FIX: GameSprite toggle under LT toggle\n        var btnGS = document.createElement(\"button\"); // FIX\n        btnGS.id = GAMESPRITE_LAUNCHER_ID; // FIX\n        btnGS.setAttribute(\"data-lt-launcher\",\"1\"); // FIX\n        btnGS.type = \"button\"; // FIX\n        btnGS.title = \"GameSprite\"; // FIX\n        btnGS.className = btn.className; // FIX: match LT toggle classes\n\n        // FIX: match LT toggle styling\n        btnGS.style.position = \"fixed\"; // FIX\n        btnGS.style.zIndex = btn.style.zIndex; // FIX\n        btnGS.style.right = \"auto\"; // FIX\n        btnGS.style.left = \"0px\"; // FIX: positioned by sync function\n        btnGS.style.top = \"0px\"; // FIX: positioned by sync function\n\n        btnGS.style.margin = \"0\"; // FIX\n        btnGS.style.padding = btn.style.padding; // FIX\n        btnGS.style.transform = \"none\"; // FIX\n        btnGS.style.transition = \"none\"; // FIX\n        btnGS.style.display = \"none\"; // FIX: only show when a game element clip is selected\n\n        // FIX: use the same icon classnames as LT toggle\n        var imgGS = document.createElement(\"img\"); // FIX\n        imgGS.className = \"img-tool-icon action-button-single-icon outliner-toggle-icon\"; // FIX\n        imgGS.alt = \"GameSprite\"; // FIX\n\n        // FIX: load svg from your public/scripts path (with a fallback if absolute path fails)\n        imgGS.src = LT_GITHUB_RAW_BASE + \"scripts/Panel_SVG/GameCharacter.svg\"; // FIX\n        imgGS.onerror = function () { // FIX\n            try { imgGS.onerror = null; } catch (e0) { }\n            try { imgGS.src = \"scripts/Panel_SVG/GameCharacter.svg\"; } catch (e1) { } // FIX\n        }; // FIX\n\n        btnGS.appendChild(imgGS); // FIX\n\n        btnGS.addEventListener(\"click\", function (e) { // FIX\n            e.preventDefault();\n            e.stopPropagation();\n            try {\n                var pnl = document.getElementById(GAMESPRITE_PANEL_ID);\n                if (pnl && pnl.style && pnl.style.display === \"block\") {\n                    closeGameSpritePanel(); // FIX\n                } else {\n                    openGameSpritePanel(); // FIX\n                }\n            } catch (e1) { }\n        }); // FIX\n\n        dock.appendChild(btnGS); // FIX\n\n        // Load layout from json (localStorage override -> file) and apply\n        loadLauncherLayoutConfig().then(function (cfg) {\n            try { applyLauncherLayout(btn, cfg); } catch (e) { }\n        }).catch(function () { /* ignore */ });\n\n        __LT_syncLauncherPosition(btn); // initial placement\n        __LT_syncGameSpriteLauncherPosition(btnGS); // FIX\n        __LT_updateGameSpriteToggleVisibility(); // FIX\n        if (!window.__LT_launcherPosBound) { // FIX\n            window.__LT_launcherPosBound = true; // FIX\n            window.addEventListener(\"resize\", function () { // FIX\n                var b = document.getElementById(LAUNCHER_ID);\n                if (b) __LT_syncLauncherPosition(b);\n                __LT_updateGameSpriteToggleVisibility(); // FIX\n                __LT_positionGameSpritePanel(); // FIX\n            });\n            setInterval(function () { // FIX: keep aligned even when layout changes\n                var b2 = document.getElementById(LAUNCHER_ID);\n                if (b2) __LT_syncLauncherPosition(b2);\n                __LT_updateGameSpriteToggleVisibility(); // FIX\n                __LT_positionGameSpritePanel(); // FIX\n            }, 250);\n        }\n    }\n\n\n    function ensureOverlay() { // FIX\n        var existing = document.getElementById(OVERLAY_ID);\n        if (existing) return existing;\n\n        var overlay = document.createElement(\"div\");\n        overlay.id = OVERLAY_ID;\n        overlay.style.position = \"fixed\";\n        overlay.style.left = \"0\";\n        overlay.style.top = \"0\";\n        overlay.style.width = \"100vw\";\n        overlay.style.height = \"100vh\";\n        overlay.style.zIndex = \"9999999\";\n        overlay.style.background = \"rgba(0,0,0,0.35)\";\n        overlay.style.display = \"none\";\n\n        var bar = document.createElement(\"div\"); // FIX: fullscreen toolbar\n        bar.style.position = \"absolute\";\n        bar.style.left = \"0\";\n        bar.style.top = \"0\";\n        bar.style.width = \"100%\";\n        bar.style.height = \"48px\";\n        bar.style.display = \"flex\";\n        bar.style.alignItems = \"center\";\n        bar.style.justifyContent = \"space-between\";\n        bar.style.padding = \"8px 10px\";\n        bar.style.boxSizing = \"border-box\";\n        bar.style.background = \"rgba(0,0,0,0.65)\";\n        bar.style.display = \"none\"; // FIX: hide fullscreen toolbar (no top back or close)\n\n        var barLeft = document.createElement(\"div\"); // FIX\n        barLeft.style.display = \"flex\";\n        barLeft.style.gap = \"8px\";\n        barLeft.style.alignItems = \"center\";\n\n        var backBtn = document.createElement(\"button\"); // FIX\n        backBtn.type = \"button\";\n        backBtn.textContent = \"Back\";\n        backBtn.style.padding = \"8px 12px\";\n        backBtn.style.border = \"0\";\n        backBtn.style.borderRadius = \"10px\";\n        backBtn.style.cursor = \"pointer\";\n        backBtn.style.fontFamily = \"Arial, sans-serif\";\n        backBtn.style.fontSize = \"14px\";\n        backBtn.style.background = \"rgba(255,255,255,0.12)\";\n        backBtn.style.color = \"white\";\n\n        var barRight = document.createElement(\"div\"); // FIX\n        barRight.style.display = \"flex\";\n        barRight.style.gap = \"8px\";\n        barRight.style.alignItems = \"center\";\n\n        var closeBtn = document.createElement(\"button\"); // FIX: avoid using global name close\n        closeBtn.type = \"button\";\n        closeBtn.textContent = \"Close\";\n        closeBtn.style.padding = \"8px 12px\";\n        closeBtn.style.border = \"0\";\n        closeBtn.style.borderRadius = \"10px\";\n        closeBtn.style.cursor = \"pointer\";\n        closeBtn.style.fontFamily = \"Arial, sans-serif\";\n        closeBtn.style.fontSize = \"14px\";\n        closeBtn.style.background = \"rgba(255,255,255,0.18)\";\n        closeBtn.style.color = \"white\";\n\n        var frame = document.createElement(\"iframe\");\n        frame.id = OVERLAY_IFRAME_ID;\n        frame.style.position = \"absolute\";\n        frame.style.left = \"0\";\n        frame.style.top = \"0\"; // FIX: fullscreen iframe starts at top (toolbar hidden)\n        frame.style.width = \"100%\";\n        frame.style.height = \"100%\"; // FIX: fullscreen iframe uses full height (toolbar hidden)\n        frame.style.border = \"0\";\n        frame.style.backgroundColor = \"white\";\n\n        backBtn.addEventListener(\"click\", function (e) { // FIX\n            e.preventDefault();\n            e.stopPropagation();\n            try { closeFullscreen(); } catch (e0) { }\n            try { showPanel(); } catch (e1) { }\n            try { if (window.__LT_showIconPanelNow) window.__LT_showIconPanelNow(); } catch (e2) { }\n        });\n\n        closeBtn.addEventListener(\"click\", function (e) { // FIX\n            e.preventDefault();\n            e.stopPropagation();\n            try { closeFullscreen(); } catch (e0) { }\n        });\n\n        barLeft.appendChild(backBtn);\n        barRight.appendChild(closeBtn);\n        bar.appendChild(barLeft);\n        bar.appendChild(barRight);\n\n        overlay.appendChild(bar); // FIX\n        overlay.appendChild(frame);\n\n        // FIX: close button bottom right for fullscreen tools\n        var closeBR = document.createElement(\"button\");\n        closeBR.type = \"button\";\n        closeBR.textContent = \"Close\"; // FIX: bottom close button label\n        closeBR.title = \"Close\";\n        closeBR.style.position = \"absolute\";\n        closeBR.style.left = \"50%\"; // FIX: center bottom close button\n        closeBR.style.transform = \"translateX(-50%)\"; // FIX: center bottom close button\n        closeBR.style.bottom = \"18px\";\n        closeBR.style.width = \"88px\"; // FIX: fit Close label\n        closeBR.style.height = \"42px\";\n        closeBR.style.borderRadius = \"14px\";\n        closeBR.style.border = \"1px solid rgba(255,255,255,0.18)\";\n        closeBR.style.background = \"rgba(0,0,0,0.35)\";\n        closeBR.style.color = \"white\";\n        closeBR.style.cursor = \"pointer\";\n        closeBR.style.fontSize = \"14px\";\n        closeBR.style.fontWeight = \"700\";\n        closeBR.style.zIndex = \"1000001\";\n\n        closeBR.addEventListener(\"pointerdown\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n        });\n\n        closeBR.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            try { closeFullscreen(); } catch (e0) { }\n            try { showPanel(); } catch (e1) { }\n            try { if (window.__LT_showIconPanelNow) window.__LT_showIconPanelNow(); } catch (e2) { }\n        });\n\n        overlay.appendChild(closeBR); // FIX\n\n        document.body.appendChild(overlay);\n        return overlay;\n    }\n\n\n    function openFullscreen(htmlDoc) {\n        var overlay = ensureOverlay();\n        var frame = document.getElementById(OVERLAY_IFRAME_ID);\n        if (!overlay || !frame) return;\n        try { frame.srcdoc = htmlDoc; } catch (e1) { frame.srcdoc = \"\"; }\n        overlay.style.display = \"block\";\n    }\n\n    function closeFullscreen() {\n        var overlay = document.getElementById(OVERLAY_ID);\n        var frame = document.getElementById(OVERLAY_IFRAME_ID);\n        if (frame) {\n            try { frame.srcdoc = \"\"; } catch (e1) { }\n        }\n        if (overlay) {\n            overlay.style.display = \"none\";\n        }\n    }\n\n    function fetchText(url) {\n        var u = s(url);\n        if (!u) return Promise.reject(new Error(\"missing url\"));\n\n        // FIX: Do not append cache bust to blob or data URLs\n        if (u.indexOf(\"blob:\") === 0 || u.indexOf(\"data:\") === 0) {\n            if (window.fetch) {\n                return fetch(u, { cache: \"no-store\" }).then(function (r) { return r.text(); });\n            }\n            return new Promise(function (resolve, reject) {\n                try {\n                    var xhrb = new XMLHttpRequest();\n                    xhrb.open(\"GET\", u, true);\n                    xhrb.onreadystatechange = function () {\n                        if (xhrb.readyState !== 4) return;\n                        if (xhrb.status >= 200 && xhrb.status < 300) resolve(xhrb.responseText || \"\");\n                        else reject(new Error(\"http \" + String(xhrb.status)));\n                    };\n                    xhrb.send();\n                } catch (eb) {\n                    reject(eb);\n                }\n            });\n        }\n        var sep = (u.indexOf(\"?\") === -1) ? \"?\" : \"&\";\n        u = u + sep + \"t=\" + String(nowMs());\n\n        if (window.fetch) {\n            return fetch(u, { cache: \"no-store\" }).then(function (r) { return r.text(); });\n        }\n\n        return new Promise(function (resolve, reject) {\n            try {\n                var xhr = new XMLHttpRequest();\n                xhr.open(\"GET\", u, true);\n                xhr.onreadystatechange = function () {\n                    if (xhr.readyState !== 4) return;\n                    if (xhr.status >= 200 && xhr.status < 300) resolve(xhr.responseText || \"\");\n                    else reject(new Error(\"http \" + String(xhr.status)));\n                };\n                xhr.send();\n            } catch (e) {\n                reject(e);\n            }\n        });\n    }\n\n    function setPanelToolHtml(htmlDoc) {\n        showPanel();\n        var fr = document.getElementById(PANEL_IFRAME_ID);\n        if (!fr) return { ok: false, reason: \"panel iframe missing\" };\n        try { fr.srcdoc = htmlDoc; } catch (e) { fr.srcdoc = \"\"; }\n        return { ok: true };\n    }\n\n    function openToolFromUrl(url, opts) {\n        if (isKilled()) return Promise.resolve({ ok: false, reason: \"killed\" });\n\n        var o = opts || {};\n        var target = s(o.target || \"panel\").toLowerCase();\n\n        return fetchText(url).then(function (raw) {\n            var htmlDoc = ensureHtmlDocument(raw);\n            try { lastLoaded.name = s(url); } catch (e1) { }\n            try { lastLoaded.htmlDoc = htmlDoc; } catch (e2) { }\n\n            if (target === \"fullscreen\") {\n                openFullscreen(htmlDoc);\n                return { ok: true, target: \"fullscreen\" };\n            }\n\n            return setPanelToolHtml(htmlDoc);\n        }).catch(function (e) {\n            return { ok: false, reason: \"fetch failed\", error: s(e && e.message ? e.message : e) };\n        });\n    }\n\n    var panel = null;\n    var lastLoaded = { name: \"\", htmlDoc: \"\" };\n\n    function setPanelPos(x, y) {\n        if (!panel) return;\n        panel.style.left = x + \"px\";\n        panel.style.top = y + \"px\";\n        try { localStorage.setItem(STORAGE_X, String(x)); } catch (e1) { }\n        try { localStorage.setItem(STORAGE_Y, String(y)); } catch (e2) { }\n    }\n\n    function clampPanelToView() {\n        if (!panel) return;\n\n        var w = panel.offsetWidth || 560;\n        var h = panel.offsetHeight || 420;\n\n        var x = 10;\n        var y = 90;\n\n        try {\n            var sx = localStorage.getItem(STORAGE_X);\n            var sy = localStorage.getItem(STORAGE_Y);\n            if (sx !== null && sx !== \"\") x = parseInt(sx, 10);\n            if (sy !== null && sy !== \"\") y = parseInt(sy, 10);\n        } catch (e) { }\n\n        if (isNaN(x)) x = 10;\n        if (isNaN(y)) y = 90;\n\n        var maxX = Math.max(0, window.innerWidth - w);\n        var maxY = Math.max(0, window.innerHeight - h);\n\n        if (x < 0) x = 0;\n        if (y < 0) y = 0;\n        if (x > maxX) x = maxX;\n        if (y > maxY) y = maxY;\n\n        setPanelPos(x, y);\n    }\n\n    function hidePanel() {\n        if (!panel) return;\n        panel.style.display = \"none\";\n        try { var lb2 = document.getElementById(LAUNCHER_ID); if (lb2) lb2.style.display = \"block\"; } catch (e0) { } // FIX: show launcher when panel is hidden\n        ensureLauncher(showPanel);\n    }\n\n    function showPanel() {\n        var p = ensurePanel(); // FIX: use returned panel reference\n        p.style.display = \"block\";\n        ensureLauncher(showPanel);\n\n        try { var lb = document.getElementById(LAUNCHER_ID); if (lb) lb.style.display = \"none\"; } catch (e0) { } // FIX: hide launcher while panel is open\n        try { if (window.__LT_showIconPanelNow) window.__LT_showIconPanelNow(); } catch (e1) { } // FIX: always show icon panel on open\n        try { setTimeout(function () { try { if (window.__LT_showIconPanelNow) window.__LT_showIconPanelNow(); } catch (e2) { } }, 50); } catch (e3) { } // FIX: retry after config auto load\n\n        // FIX: first open should position the panel next to the Outliner toggle\n        try {\n            var hasX = window.localStorage.getItem(STORAGE_X);\n            var hasY = window.localStorage.getItem(STORAGE_Y);\n            if (!hasX && !hasY) {\n                var ob = __LT_getOutlinerToggleButton();\n                if (ob) {\n                    var r = ob.getBoundingClientRect();\n                    var x = Math.max(8, Math.round(r.left - p.offsetWidth - 10));\n                    var y = Math.max(8, Math.round(r.top));\n                    p.style.left = x + \"px\";\n                    p.style.top = y + \"px\";\n                }\n            }\n        } catch (e) { }\n\n        clampPanelToView();\n    }\n\n    function ensurePanel() {\n        if (panel) return panel; // FIX\n\n        var existing = document.getElementById(PANEL_ID);\n        if (existing) {\n            panel = existing;\n            return panel; // FIX\n        }\n\n        panel = document.createElement(\"div\");\n        panel.id = PANEL_ID;\n        panel.style.position = \"fixed\";\n        panel.style.zIndex = \"999999\";\n        panel.style.width = \"300px\"; // FIX: requested floating panel width\n        panel.style.height = \"600px\"; // FIX: requested floating panel height\n        panel.style.maxHeight = \"600px\"; // FIX\n        panel.style.overflow = \"hidden\";\n        panel.style.borderRadius = \"0px\"; // FIX\n        panel.style.border = \"2px solid rgba(255,255,255,0.12)\";\n        panel.style.boxShadow = \"0 10px 30px rgba(0,0,0,0.65)\";\n        panel.style.background = \"rgba(18,18,18,0.98)\";\n        panel.style.color = \"white\";\n        panel.style.fontFamily = \"Arial, sans-serif\"; // FIX\n        panel.style.display = \"block\";\n\n        var header = document.createElement(\"div\");\n        header.style.display = \"flex\";\n        header.style.alignItems = \"center\";\n        header.style.justifyContent = \"space-between\";\n        header.style.padding = \"10px 10px\";\n        header.style.borderBottom = \"1px solid rgba(255,255,255,0.08)\";\n        header.style.userSelect = \"none\";\n        header.style.cursor = \"grab\";\n\n        var left = document.createElement(\"div\");\n        left.style.display = \"flex\";\n        left.style.alignItems = \"center\";\n        left.style.gap = \"10px\";\n\n        var brandImg = document.createElement(\"img\");\n        brandImg.src = BRAND_ICON_URL;\n        brandImg.alt = \"Luke Tools\";\n        brandImg.style.width = \"26px\";\n        brandImg.style.height = \"26px\";\n        brandImg.style.borderRadius = \"0px\";\n        brandImg.style.objectFit = \"cover\";\n\n        var title = document.createElement(\"div\");\n        title.textContent = \"Luke Tools\";\n        title.style.fontWeight = \"700\";\n        title.style.fontSize = \"14px\";\n\n        left.appendChild(brandImg);\n        left.appendChild(title);\n\n        var closeBtn = document.createElement(\"button\");\n        closeBtn.type = \"button\";\n        closeBtn.textContent = \"X\";\n        closeBtn.title = \"Close\";\n        closeBtn.style.width = \"34px\";\n        closeBtn.style.height = \"34px\";\n        closeBtn.style.borderRadius = \"10px\";\n        closeBtn.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        closeBtn.style.background = \"rgba(255,255,255,0.08)\";\n        closeBtn.style.color = \"white\";\n        closeBtn.style.cursor = \"pointer\";\n        closeBtn.style.fontSize = \"13px\";\n        closeBtn.style.fontWeight = \"700\";\n\n        closeBtn.addEventListener(\"pointerdown\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n        });\n\n        closeBtn.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            hidePanel();\n        });\n\n        header.appendChild(left);\n        header.appendChild(closeBtn);\n\n        var body = document.createElement(\"div\");\n        body.style.padding = \"0\"; // FIX: launcher panel uses iframe layout\n        body.style.overflow = \"hidden\"; // FIX: hide legacy picker UI container\n        body.style.maxHeight = \"calc(90vh - 54px)\";\n\n        var topBox = document.createElement(\"div\");\n        topBox.style.display = \"flex\";\n        topBox.style.flexDirection = \"column\";\n        topBox.style.gap = \"8px\";\n        topBox.style.padding = \"10px\";\n        topBox.style.borderRadius = \"10px\";\n        topBox.style.border = \"1px solid rgba(255,255,255,0.08)\";\n        topBox.style.background = \"rgba(255,255,255,0.03)\";\n\n        if (ICON_PANEL_ONLY) { topBox.style.display = \"none\"; } // FIX\n\n        var fileRow = document.createElement(\"div\");\n        fileRow.style.display = \"flex\";\n        fileRow.style.alignItems = \"center\";\n        fileRow.style.gap = \"10px\";\n\n        var fileInput = document.createElement(\"input\");\n        fileInput.type = \"file\";\n        fileInput.accept = \".html,.txt\";\n        fileInput.style.flex = \"1\";\n        fileInput.style.fontSize = \"12px\";\n        fileInput.style.color = \"#ccc\";\n\n        var reloadBtn = document.createElement(\"button\");\n        reloadBtn.type = \"button\";\n        reloadBtn.textContent = \"Reload\";\n        reloadBtn.style.padding = \"10px\";\n        reloadBtn.style.borderRadius = \"10px\";\n        reloadBtn.style.border = \"0\";\n        reloadBtn.style.background = \"rgba(255,255,255,0.12)\";\n        reloadBtn.style.color = \"white\";\n        reloadBtn.style.cursor = \"pointer\";\n        reloadBtn.style.fontSize = \"13px\";\n        reloadBtn.style.fontWeight = \"700\";\n\n        fileRow.appendChild(fileInput);\n        fileRow.appendChild(reloadBtn);\n\n\n        // --- Folder Picker + Dropdown (loads .txt/.html tools into panel) ---\n        var folderRow = document.createElement(\"div\");\n        folderRow.style.display = \"flex\";\n        folderRow.style.alignItems = \"center\";\n        folderRow.style.gap = \"10px\";\n\n        // Hidden native directory input (browser button label cannot be changed)\n        var folderInput = document.createElement(\"input\");\n        folderInput.type = \"file\";\n        folderInput.accept = \".html,.htm,.txt\";\n        folderInput.multiple = true;\n        folderInput.style.display = \"none\";\n        folderInput.title = \"Choose a folder to list tools (.txt/.html)\";\n\n        try { folderInput.setAttribute(\"webkitdirectory\", \"\"); } catch (e0) { }\n        try { folderInput.setAttribute(\"directory\", \"\"); } catch (e1) { }\n\n        // Visible button: \"Choose folder\"\n        var folderBtn = document.createElement(\"button\");\n        folderBtn.type = \"button\";\n        folderBtn.textContent = \"Choose folder\";\n        folderBtn.style.padding = \"10px\";\n        folderBtn.style.borderRadius = \"10px\";\n        folderBtn.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        folderBtn.style.background = \"rgba(255,255,255,0.06)\";\n        folderBtn.style.color = \"white\";\n        folderBtn.style.fontWeight = \"bold\";\n        folderBtn.style.cursor = \"pointer\";\n\n        var folderMeta = document.createElement(\"div\");\n        folderMeta.style.fontSize = \"12px\";\n        folderMeta.style.color = \"#bbb\";\n        folderMeta.style.minWidth = \"120px\";\n        folderMeta.textContent = \"No folder chosen\";\n\n        var folderSelect = document.createElement(\"select\");\n        folderSelect.style.flex = \"1\";\n        folderSelect.style.fontSize = \"12px\";\n        folderSelect.style.padding = \"10px\";\n        folderSelect.style.borderRadius = \"10px\";\n        folderSelect.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        folderSelect.style.background = \"rgba(255,255,255,0.06)\";\n        folderSelect.style.color = \"white\";\n\n        // Force dark select styling (Wick CSS may set select background white !important)\n        try {\n            folderSelect.style.setProperty(\"background\", \"#111\", \"important\");\n            folderSelect.style.setProperty(\"color\", \"#eaeaea\", \"important\");\n            folderSelect.style.setProperty(\"border\", \"1px solid rgba(255,255,255,0.18)\", \"important\");\n        } catch (e) { }\n\n\n        var folderFiles = [];\n\n        function clearSelectOptions(sel) {\n            while (sel.firstChild) sel.removeChild(sel.firstChild);\n        }\n\n        function stripExt(name) {\n            var n = s(name || \"\");\n            var dot = n.lastIndexOf(\".\");\n            return (dot > 0) ? n.slice(0, dot) : n;\n        }\n\n        function rebuildFolderDropdown() {\n            try {\n                // Clear\n                while (folderSelect.firstChild) folderSelect.removeChild(folderSelect.firstChild);\n\n                // Placeholder\n                var ph = document.createElement(\"option\");\n                ph.value = \"\";\n                ph.textContent = \"Choose a script\";\n                ph.selected = true;\n                folderSelect.appendChild(ph);\n\n                // Populate\n                for (var i = 0; i < folderFiles.length; i++) {\n                    var f = folderFiles[i];\n                    if (!f) continue;\n\n                    var nm = (f.name || (\"Script_\" + i));\n                    // show just base name without extension\n                    nm = nm.replace(/\\.[^/.]+$/, \"\");\n\n                    var opt = document.createElement(\"option\");\n                    opt.value = String(i);\n                    opt.textContent = nm;\n                    folderSelect.appendChild(opt);\n                }\n\n                // Force empty selection visible\n                folderSelect.value = \"\";\n            } catch (err) { }\n        }\n\n        folderRow.appendChild(folderInput);\n        folderRow.appendChild(folderBtn);\n        folderRow.appendChild(folderMeta);\n        folderRow.appendChild(folderSelect);\n\n        // --- /Folder Picker + Dropdown ---\n\n        var loadedLabel = document.createElement(\"div\");\n        loadedLabel.textContent = \"\";\n        loadedLabel.style.fontSize = \"12px\";\n        loadedLabel.style.color = \"#bbb\";\n\n        // FIX: JSON driven icon and script loader\n        var configBox = document.createElement(\"div\");\n        configBox.style.display = \"flex\";\n        configBox.style.flexDirection = \"column\";\n        configBox.style.gap = \"8px\";\n\n        var jsonControls = document.createElement(\"div\");\n        jsonControls.style.display = \"flex\";\n        jsonControls.style.flexDirection = \"column\";\n        jsonControls.style.gap = \"6px\";\n\n        var jsonRow1 = document.createElement(\"div\");\n        jsonRow1.style.display = \"flex\";\n        jsonRow1.style.alignItems = \"center\";\n        jsonRow1.style.gap = \"8px\";\n\n        var jsonFileInput = document.createElement(\"input\");\n        jsonFileInput.type = \"file\";\n        jsonFileInput.accept = \".json,application/json\";\n        jsonFileInput.style.display = \"none\";\n\n        var jsonChooseBtn = document.createElement(\"button\");\n        jsonChooseBtn.type = \"button\";\n        jsonChooseBtn.textContent = \"Load json\";\n        jsonChooseBtn.style.padding = \"8px 10px\";\n        jsonChooseBtn.style.borderRadius = \"10px\";\n        jsonChooseBtn.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        jsonChooseBtn.style.background = \"rgba(255,255,255,0.06)\";\n        jsonChooseBtn.style.color = \"white\";\n        jsonChooseBtn.style.fontWeight = \"700\";\n        jsonChooseBtn.style.cursor = \"pointer\";\n\n        var jsonUrlInput = document.createElement(\"input\");\n        jsonUrlInput.type = \"text\";\n        jsonUrlInput.placeholder = \"json url\";\n        jsonUrlInput.style.flex = \"1\";\n        jsonUrlInput.style.padding = \"8px 10px\";\n        jsonUrlInput.style.borderRadius = \"10px\";\n        jsonUrlInput.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        jsonUrlInput.style.background = \"rgba(0,0,0,0.25)\";\n        jsonUrlInput.style.color = \"white\";\n\n        var jsonLoadUrlBtn = document.createElement(\"button\");\n        jsonLoadUrlBtn.type = \"button\";\n        jsonLoadUrlBtn.textContent = \"Load\";\n        jsonLoadUrlBtn.style.padding = \"8px 10px\";\n        jsonLoadUrlBtn.style.borderRadius = \"10px\";\n        jsonLoadUrlBtn.style.border = \"0\";\n        jsonLoadUrlBtn.style.background = \"#21b26b\";\n        jsonLoadUrlBtn.style.color = \"white\";\n        jsonLoadUrlBtn.style.cursor = \"pointer\";\n        jsonLoadUrlBtn.style.fontSize = \"12px\";\n        jsonLoadUrlBtn.style.fontWeight = \"800\";\n\n        var jsonClearBtn = document.createElement(\"button\");\n        jsonClearBtn.type = \"button\";\n        jsonClearBtn.textContent = \"Clear\";\n        jsonClearBtn.style.padding = \"8px 10px\";\n        jsonClearBtn.style.borderRadius = \"10px\";\n        jsonClearBtn.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        jsonClearBtn.style.background = \"rgba(255,255,255,0.06)\";\n        jsonClearBtn.style.color = \"white\";\n        jsonClearBtn.style.fontWeight = \"700\";\n        jsonClearBtn.style.cursor = \"pointer\";\n\n        // FIX: Show the JSON icon panel again\n        var jsonShowPanelBtn = document.createElement(\"button\");\n        jsonShowPanelBtn.type = \"button\";\n        jsonShowPanelBtn.textContent = \"Panel\";\n        jsonShowPanelBtn.style.padding = \"8px 10px\";\n        jsonShowPanelBtn.style.borderRadius = \"10px\";\n        jsonShowPanelBtn.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        jsonShowPanelBtn.style.background = \"rgba(255,255,255,0.06)\";\n        jsonShowPanelBtn.style.color = \"white\";\n        jsonShowPanelBtn.style.fontWeight = \"700\";\n        jsonShowPanelBtn.style.cursor = \"pointer\";\n\n        jsonRow1.appendChild(jsonChooseBtn);\n        jsonRow1.appendChild(jsonUrlInput);\n        jsonRow1.appendChild(jsonLoadUrlBtn);\n        jsonRow1.appendChild(jsonShowPanelBtn); // FIX\n        jsonRow1.appendChild(jsonClearBtn);\n        jsonControls.appendChild(jsonRow1);\n\n        var jsonHint = document.createElement(\"div\");\n        jsonHint.textContent = \"Json can build icon buttons that open tools or set scripts\";\n        jsonHint.style.fontSize = \"11px\";\n        jsonHint.style.color = \"#9aa\";\n        jsonControls.appendChild(jsonHint);\n\n        var iconsHost = document.createElement(\"div\");\n        iconsHost.style.display = \"flex\";\n        iconsHost.style.flexDirection = \"column\";\n        iconsHost.style.gap = \"10px\";\n        iconsHost.style.paddingTop = \"6px\";\n\n        configBox.appendChild(jsonFileInput);\n        configBox.appendChild(jsonControls);\n        configBox.appendChild(iconsHost);\n\n        function getStoredPanelConfigText() { // FIX\n            try { return localStorage.getItem(STORAGE_PANEL_JSON) || \"\"; } catch (e) { return \"\"; }\n        }\n\n        function setStoredPanelConfigText(txt) { // FIX\n            try { localStorage.setItem(STORAGE_PANEL_JSON, s(txt || \"\")); } catch (e) { }\n        }\n\n        function clearStoredPanelConfig() { // FIX\n            try { localStorage.removeItem(STORAGE_PANEL_JSON); } catch (e) { }\n        }\n\n        function parsePanelConfig(txt) { // FIX\n            var raw = s(txt || \"\");\n            if (!raw.trim()) return null;\n            var cfg = null;\n            try { cfg = JSON.parse(raw); } catch (e1) { throw new Error(\"Bad json\"); }\n            if (!cfg || typeof cfg !== \"object\") throw new Error(\"Bad json\");\n            // FIX: Accept { tabs: [tab objects] } and convert to groups for the icon panel\n            if (!cfg.groups && cfg.tabs && Array.isArray(cfg.tabs)) {\n                cfg.groups = [];\n                for (var ti = 0; ti < cfg.tabs.length; ti += 1) {\n                    var t = cfg.tabs[ti] || {};\n                    cfg.groups.push({\n                        id: (typeof t.id === \"string\" ? t.id : \"\"),\n                        name: (typeof t.label === \"string\" ? t.label : (typeof t.name === \"string\" ? t.name : \"\")),\n                        label: (typeof t.label === \"string\" ? t.label : (typeof t.name === \"string\" ? t.name : (\"Tab \" + (ti + 1)))),\n                        tabIcon: (typeof t.tabIcon === \"string\" ? t.tabIcon : \"\"),\n                        items: (t.items && Array.isArray(t.items)) ? t.items : []\n                    });\n                }\n            }\n\n            // Accept either { groups: [items] } or { items: [items] }\n            if (!cfg.groups && cfg.items && Array.isArray(cfg.items)) {\n                cfg.groups = [{ name: \"Tools\", items: cfg.items }];\n            }\n            if (!cfg.groups || !Array.isArray(cfg.groups)) throw new Error(\"Missing groups\");\n            return cfg;\n        }\n\n        function clearIconsHost() { // FIX\n            while (iconsHost.firstChild) iconsHost.removeChild(iconsHost.firstChild);\n        }\n\n        function makeIconEl(item) { // FIX\n            var wrap = document.createElement(\"div\");\n            wrap.style.width = \"28px\";\n            wrap.style.height = \"28px\";\n            wrap.style.display = \"flex\";\n            wrap.style.alignItems = \"center\";\n            wrap.style.justifyContent = \"center\";\n            wrap.style.borderRadius = \"8px\";\n            wrap.style.overflow = \"hidden\";\n\n            var svg = item && item.iconSvg ? s(item.iconSvg) : \"\";\n            var url = item && item.iconUrl ? s(item.iconUrl) : \"\";\n\n            if (svg) {\n                try {\n                    wrap.innerHTML = svg;\n                    var s0 = wrap.querySelector(\"svg\");\n                    if (s0) {\n                        s0.setAttribute(\"width\", \"22\");\n                        s0.setAttribute(\"height\", \"22\");\n                        s0.style.display = \"block\";\n                    }\n                } catch (e1) { wrap.textContent = \"\"; }\n                return wrap;\n            }\n\n            if (url) {\n                var img = document.createElement(\"img\");\n                img.src = url;\n                img.alt = s(item && item.label ? item.label : \"\");\n                img.style.width = \"22px\";\n                img.style.height = \"22px\";\n                img.style.objectFit = \"contain\";\n                wrap.appendChild(img);\n                return wrap;\n            }\n\n            wrap.textContent = \"\";\n            return wrap;\n        }\n\n        function resolveActionTarget(action) { // FIX\n            var t = s(action && action.target ? action.target : \"\");\n            if (t === \"panel\" || t === \"fullscreen\") return t;\n            return fullscreenCheck && fullscreenCheck.checked ? \"fullscreen\" : \"panel\";\n        }\n\n        function runPanelConfigAction(item) { // FIX\n            var action = item && item.action ? item.action : null;\n            if (!action || typeof action !== \"object\") return;\n\n            var type = s(action.type || \"\");\n\n            if (type === \"openUrl\") {\n                var url = s(action.url || item.url || \"\");\n                if (!url) return;\n                openToolFromUrl(url, { target: resolveActionTarget(action) });\n                return;\n            }\n\n            if (type === \"setDefaultScriptOnSelection\") {\n                var src = s(action.source || \"\");\n                var srcUrl = s(action.sourceUrl || \"\");\n                if (srcUrl) {\n                    fetchText(srcUrl).then(function (t) {\n                        Bridge.setDefaultScriptOnSelection(s(t));\n                        alert(\"Script set on selection\");\n                    }).catch(function (e) {\n                        alert(\"Script load failed\\n\" + s(e && e.message ? e.message : e));\n                    });\n                    return;\n                }\n                Bridge.setDefaultScriptOnSelection(src);\n                alert(\"Script set on selection\");\n                return;\n            }\n\n            if (type === \"appendDefaultScriptOnSelection\") {\n                var add = s(action.source || \"\");\n                var addUrl = s(action.sourceUrl || \"\");\n                function doAppend(t) {\n                    var cur = \"\";\n                    try { cur = s(Bridge.getDefaultScriptOnSelection()); } catch (e1) { cur = \"\"; }\n                    var next = cur ? (cur + \"\\n\\n\" + s(t)) : s(t);\n                    Bridge.setDefaultScriptOnSelection(next);\n                    alert(\"Script updated on selection\");\n                }\n                if (addUrl) {\n                    fetchText(addUrl).then(doAppend).catch(function (e) { alert(\"Script load failed\\n\" + s(e && e.message ? e.message : e)); });\n                    return;\n                }\n                doAppend(add);\n                return;\n            }\n\n            if (type === \"callBridge\") {\n                var fn = s(action.fn || \"\");\n                if (!fn || !Bridge || !isFn(Bridge[fn])) {\n                    alert(\"Bridge fn missing\");\n                    return;\n                }\n                var args = action.args;\n                if (!Array.isArray(args)) args = [];\n                try {\n                    var r = Bridge[fn].apply(Bridge, args);\n                    if (r && typeof r.then === \"function\") {\n                        r.then(function (x) { console.log(\"[LukeTools] callBridge result\", x); });\n                    } else {\n                        console.log(\"[LukeTools] callBridge result\", r);\n                    }\n                } catch (e2) {\n                    alert(\"Bridge call failed\\n\" + s(e2 && e2.message ? e2.message : e2));\n                }\n                return;\n            }\n\n            if (type === \"alert\") {\n                alert(s(action.message || \"\"));\n                return;\n            }\n\n            alert(\"Unknown action\");\n        }\n\n        function buildJsonIconPanelHtml(cfg) { // FIX\n            // Build the Luke Tools icon panel inside the iframe, driven by JSON config\n            var safeCfg = cfg || {};\n            var title = s(safeCfg.title || \"Luke Tools\");\n            var groups = (safeCfg.groups && safeCfg.groups.length) ? safeCfg.groups : [];\n\n            function escHtml(str) {\n                str = s(str);\n                return str.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\").replace(/\"/g, \"&quot;\").replace(/'/g, \"&#39;\");\n            }\n\n            function normUrl(u) {\n                u = s(u || \"\");\n                if (!u) return \"\";\n                // If relative, keep as is. If starts with // or http(s) or data, keep. If starts with / keep.\n                return u;\n            }\n            // FIX: Added pick helper used by icon panel renderer\n            function pick(obj, keys, fallback) {\n                obj = obj || {};\n                keys = keys || [];\n                for (var i = 0; i < keys.length; i++) {\n                    var k = keys[i];\n                    if (k && Object.prototype.hasOwnProperty.call(obj, k)) {\n                        var v = obj[k];\n                        if (v !== undefined && v !== null && String(v) !== \"\") return v;\n                    }\n                }\n                return fallback;\n            }\n            // FIX: no placeholder tiles, only render real tools found in JSON\n\n            function makeToolButton(it) {\n                it = it || {};\n                var idHint = pick(it, [\"id\"], \"\"); // FIX: id hover hint\n                var toolUrl = pick(it, [\"toolUrl\", \"url\", \"scriptUrl\", \"path\"], \"\");\n                var name = pick(it, [\"label\", \"name\", \"id\"], \"\");\n                var icon = pick(it, [\"iconUrl\", \"icon\", \"iconPath\"], \"\");\n                var fs = (it && (it.F_Screen === 0 || it.F_Screen === 1)) ? String(it.F_Screen) : \"\";\n                var pw = (it && it.panelWidth !== undefined && it.panelWidth !== null) ? String(it.panelWidth) : \"\";\n                var ph = (it && it.panelHeight !== undefined && it.panelHeight !== null) ? String(it.panelHeight) : \"\";\n                var css = pick(it, [\"cssUrl\"], \"\");\n\n                var btn =\n                    \"<button class=\\\"tool-btn\\\" type=\\\"button\\\"\" +\n                    \" title=\\\"\" + escHtml(idHint || name) + \"\\\"\" + // FIX: show id on hover\n                    \" data-url=\\\"\" + escHtml(toolUrl) + \"\\\"\" +\n                    \" data-name=\\\"\" + escHtml(name) + \"\\\"\" +\n                    \" data-id=\\\"\" + escHtml(idHint || \"\") + \"\\\"\" + // FIX: store id\n\n                    \" data-fs=\\\"\" + escHtml(fs) + \"\\\"\" +\n                    \" data-pw=\\\"\" + escHtml(pw) + \"\\\"\" +\n                    \" data-ph=\\\"\" + escHtml(ph) + \"\\\"\" +\n                    \" data-css=\\\"\" + escHtml(css) + \"\\\"\" +\n                    \">\";\n                if (icon) {\n                    btn += \"<img class=\\\"tool-icon\\\" alt=\\\"\" + escHtml(name) + \"\\\" src=\\\"\" + escHtml(normUrl(icon)) + \"\\\">\";\n                }\n                btn += \"</button>\";\n                return btn;\n            }\n\n            function makeTabButton(g, idx, active) {\n                var label = s(g && (g.label || g.name || g.id) ? (g.label || g.name || g.id) : (\"Tab \" + (idx + 1)));\n                var icon = s(g && (g.tabIcon || g.iconUrl || g.icon) ? (g.tabIcon || g.iconUrl || g.icon) : \"\");\n                return (\n                    \"<button class=\\\"tab-btn\" + (active ? \" active\" : \"\") + \"\\\" type=\\\"button\\\" data-tab=\\\"\" + idx + \"\\\" title=\\\"\" + escHtml(label) + \"\\\">\" +\n                    (icon ? (\"<img class=\\\"tab-icon\\\" alt=\\\"\" + escHtml(label) + \"\\\" src=\\\"\" + escHtml(normUrl(icon)) + \"\\\">\") : \"\") +\n                    \"</button>\"\n                );\n            }\n\n            function makePane(g, idx, active) {\n                var items = (g && g.items && g.items.length) ? g.items : [];\n                var html = \"<div class=\\\"pane\" + (active ? \" active\" : \"\") + \"\\\" data-tab=\\\"\" + idx + \"\\\">\";\n                if (items.length) {\n                    html += \"<div class=\\\"grid\\\">\";\n                    for (var i = 0; i < items.length; i += 1) {\n                        html += makeToolButton(items[i]);\n                    }\n                    html += \"</div>\";\n                } else {\n                    html += \"<div class=\\\"empty\\\">No tools</div>\"; // FIX: hide unused slots when tab has no items\n                }\n                html += \"</div>\";\n                return html;\n            }\n\n            var firstLabel = groups.length ? s(groups[0].label || groups[0].name || groups[0].id || \"\") : \"\";\n            var groupMetaJson = \"[]\"; // FIX: sandbox import button group metadata\n            try {\n                groupMetaJson = JSON.stringify(groups.map(function (g) {\n                    return { id: s(g && g.id ? g.id : \"\"), label: s(g && (g.label || g.name) ? (g.label || g.name) : \"\") };\n                }));\n            } catch (e) { groupMetaJson = \"[]\"; }\n\n            var tabsHtml = \"\";\n            var panesHtml = \"\";\n\n            for (var gi = 0; gi < groups.length; gi += 1) {\n                tabsHtml += makeTabButton(groups[gi], gi, gi === 0);\n                panesHtml += makePane(groups[gi], gi, gi === 0);\n            }\n            // FIX: If no groups, show no unused slots\n\n            var html =\n                \"<!doctype html>\" +\n                \"<html>\" +\n                \"<head>\" +\n                \"<meta charset=\\\"utf-8\\\">\" +\n                \"<style>\" +\n                \"html,body{margin:0;padding:0;background:transparent;color:#eaeaea;font-family:Arial, sans-serif;overflow-x:hidden;}body{overflow-y:auto;}\" + // FIX: prevent horizontal overflow in icon panel iframe\n                \n                \".wrap{padding:10px 10px 12px 10px;}\" +\n                \".topbar{display:flex;flex-direction:column;align-items:stretch;justify-content:flex-start;gap:8px;background:rgba(0,0,0,0.18);border-radius:0;padding:8px 10px 8px 10px;}\" + // FIX: group name above tabs\n                \".labelrow{display:flex;align-items:center;justify-content:flex-start;}\" + // FIX\n                \".tabsrow{display:flex;align-items:center;justify-content:center;}\"+ // FIX: center tabs row\n\n                \".label{font-size:14px;font-weight:700;opacity:0.95;}\" +\n                \".tabs{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:nowrap;padding:0 12px;}\"+ // FIX: centered tabs with side padding\n\n                \".right{display:flex;gap:10px;align-items:center;}\" + // FIX: sandbox import button container\n                \".sandboxbar{display:none;align-items:center;gap:10px;margin-top:8px;}\" + // FIX: sandbox import row\n                \".import-btn{height:28px;border:0;background:rgba(255,255,255,0.08);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0 10px;font-size:12px;color:#eaeaea;}\" + // FIX: sandbox import button\n                \".import-btn:hover{background:rgba(255,255,255,0.16);}\" + // FIX\n                \".import-icon{width:18px;height:18px;display:block;}\" + // FIX\n                \".tab-btn{width:35px;height:35px;border:0;background:rgba(255,255,255,0.08);border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;}\" + // FIX: smaller tab buttons\n                \".tab-btn.active{background:rgba(255,255,255,0.16);}\" +\n                \".tab-icon{width:19px;height:19px;display:block;filter:brightness(2);}\"+ // FIX: smaller tab icons\n\n                \".panes{margin-top:10px;}\" +\n                \".pane{display:none;}\" +\n                \".pane.active{display:block;}\" +\n                \".grid{display:grid;grid-template-columns:repeat(auto-fill, 42px);column-gap:8px;row-gap:8px;justify-content:center;align-content:start;grid-auto-flow:row;padding:2px 6px 0 6px;box-sizing:border-box;}\"+ // FIX: tighter centered tool grid no horizontal scroll\n\n                \".empty{opacity:0.6;font-size:12px;padding:10px;}\" + // FIX: empty tab message\n\n                \".tool-btn,.tool-tile{width:100%;aspect-ratio:1/1;border-radius:8px;border:2px solid rgba(255,255,255,0.20);background:rgba(255,255,255,0.05);display:flex;align-items:center;justify-content:center;}\"+ // FIX: slightly smaller rounding for smaller tiles\n\n                \".tool-btn{cursor:pointer;}\" +\n                \".tool-btn:hover{background:rgba(255,255,255,0.08);}\" +\n                \".tool-icon{width:22px;height:22px;display:block;filter:brightness(2);}\"+ // FIX: smaller tool icons\n\n                \".placeholder{opacity:0.55;cursor:default;}\" +\n                \"</style>\" +\n                \"</head>\" +\n                \"<body>\" +\n                \"<div class=\\\"wrap\\\">\" +\n                \"<div class=\\\"topbar\\\">\" +\n                \"<div class=\\\"labelrow\\\"><div id=\\\"lt_label\\\" class=\\\"label\\\">\" + escHtml(firstLabel) + \"</div></div>\" + // FIX: group name above tabs\n                \"<div class=\\\"tabsrow\\\"><div class=\\\"tabs\\\">\" + tabsHtml + \"</div></div>\" + // FIX\n                \"</div>\" +\n                \"<div id=\\\"lt_sandboxbar\\\" class=\\\"sandboxbar\\\">\" + // FIX: sandbox import row\n                \"<button id=\\\"lt_import\\\" class=\\\"import-btn\\\" type=\\\"button\\\" title=\\\"Import\\\">Import</button>\" + // FIX: sandbox import button\n                \"<input id=\\\"lt_file\\\" type=\\\"file\\\" multiple style=\\\"display:none\\\" accept=\\\".js,.html,.htm,.txt\\\">\" + // FIX: hidden file input\n                \"</div>\" +\n                \"</div>\" +\n                \"<div class=\\\"panes\\\">\" + panesHtml + \"</div>\" +\n                \"</div>\" +\n                \"<script>\" +\n                \"(function(){\" +\n                \"function qsa(s,p){return Array.prototype.slice.call((p||document).querySelectorAll(s));}\" +\n                \"var labelEl=document.getElementById('lt_label');\" +\n                \"var tabs=qsa('.tab-btn');\" +\n                \"var panes=qsa('.pane');\" +\n                \"var sandboxBar=document.getElementById('lt_sandboxbar');\" + // FIX: sandbox import row\n                \"var importBtn=document.getElementById('lt_import');\" + // FIX: sandbox import button\n                \"var fileInput=document.getElementById('lt_file');\" + // FIX\n                \"var groupMeta=\" + groupMetaJson + \";\" + // FIX: group metadata for sandbox detection\n                \"function setActive(i){\" +\n                \"  for(var t=0;t<tabs.length;t++){tabs[t].classList.toggle('active', String(tabs[t].getAttribute('data-tab'))===String(i));}\" +\n                \"  for(var p=0;p<panes.length;p++){panes[p].classList.toggle('active', String(panes[p].getAttribute('data-tab'))===String(i));}\" +\n                \"  try{var a=tabs.filter(function(b){return String(b.getAttribute('data-tab'))===String(i);})[0]; if(a && a.title){labelEl.textContent=a.title;}}\" +\n                \"  catch(e){}\" +\n                \"  try{var meta=groupMeta&&groupMeta[Number(i)]?groupMeta[Number(i)]:null;var id=(meta&&meta.id?String(meta.id):'').toLowerCase();var lab=(meta&&meta.label?String(meta.label):'').toLowerCase();var isSb=(id==='sandbox'||lab==='sandbox');if(importBtn) importBtn.style.display=isSb?'flex':'none';if(sandboxBar) sandboxBar.style.display=isSb?'flex':'none';}catch(e1){}\" + // FIX: show import only on Sandbox tab\n\n                \"}\" +\n                \"tabs.forEach(function(tb){tb.addEventListener('click', function(e){e.preventDefault();e.stopPropagation();setActive(tb.getAttribute('data-tab'));});});\" +\n                \"try{setActive(0);}catch(einit){}\" + // FIX: init active tab state\n                \"if(importBtn && fileInput){importBtn.addEventListener('click', function(e){e.preventDefault();e.stopPropagation();try{fileInput.value='';fileInput.click();}catch(e0){}});fileInput.addEventListener('change', function(e){try{var f=(fileInput.files&&fileInput.files.length)?fileInput.files[0]:null;if(!f) return;var r=new FileReader();r.onload=function(){try{var txt=String(r.result||'');var lower=String(f.name||'').toLowerCase();var t0=txt.trim();var isHtml=lower.endsWith('.html')||lower.endsWith('.htm')||t0.indexOf('<!doctype')===0||t0.indexOf('<html')===0;var payload={type:'LukeToolsRunJsonToolText',url:'',text:txt,isJs:(!isHtml),name:String(f.name||'Imported'),id:String(f.name||'Imported'),fs:'0',F_Screen:'0',panelWidth:'',panelHeight:'',cssUrl:''};try{parent.postMessage(payload,'*');}catch(ep){}}catch(e1){}};r.readAsText(f);}catch(e2){}});}\" +\"qsa('.tool-btn').forEach(function(btn){\" +\n                \"  btn.addEventListener('click', function(e){\" +\n                \"    e.preventDefault();e.stopPropagation();\" +\n                \"    var payload={type:'LukeToolsRunJsonTool',\" +\n                \"      url:btn.getAttribute('data-url')||'',\" +\n                \"      name:btn.getAttribute('data-name')||'',\" +\n                \"      id:btn.getAttribute('data-id')||'',\" + // FIX: send id\n                \"      fs:btn.getAttribute('data-fs')||'',\" + // FIX: normalized field for parent\n                \"      F_Screen:btn.getAttribute('data-fs')||'',\" + // FIX: keep legacy field\n                \"      panelWidth:btn.getAttribute('data-pw')||'',\" +\n                \"      panelHeight:btn.getAttribute('data-ph')||'',\" +\n                \"      cssUrl:btn.getAttribute('data-css')||''};\" +\n\n                \"    try{parent.postMessage(payload,'*');}catch(e0){}\" +\n                \"  });\" +\n                \"});\" +\n                \"})();\" +\n                \"</script>\" +\n                \"</body>\" +\n                \"</html>\";\n\n            return html;\n        }\n\n        function showJsonIconPanel(cfg) { // FIX\n            try {\n                var htmlDoc = buildJsonIconPanelHtml(cfg || null);\n                runToolInPanel(htmlDoc);\n                try { setPanelToolCloseVisible(false); } catch (e1) { } // FIX\n            } catch (e) { }\n        }\n\n        function setPanelToolCloseVisible(v) { // FIX\n            try {\n                var panel = document.getElementById(PANEL_ID);\n                if (!panel) return;\n                var b = panel.__LT_toolCloseBR;\n                if (b) b.style.display = v ? \"block\" : \"none\";\n            } catch (e) { }\n        }\n\n\n        function renderPanelConfig(cfg) { // FIX\n            // Keep the parsed config available and show the icon panel in the iframe\n            try { window.__LT_panelCfg = cfg; } catch (e0) { } // FIX: expose loaded panel config\n            try { showJsonIconPanel(cfg); } catch (e) { }\n            try {\n                if (!window.__LT_showIconPanelNow) {\n                    window.__LT_showIconPanelNow = function () { // FIX: allow showPanel to force icon panel\n                        try {\n                            var c = window.__LT_panelCfg || null;\n                            if (c) showJsonIconPanel(c);\n                            else autoLoadPanelConfig();\n                        } catch (e1) { }\n                    };\n                }\n            } catch (e2) { }\n        }\n\n        function applyPanelConfigText(txt) { // FIX\n            var cfg = null;\n            try { cfg = parsePanelConfig(txt); } catch (e1) { alert(\"Bad json\\n\" + s(e1 && e1.message ? e1.message : e1)); cfg = null; }\n            if (cfg) renderPanelConfig(cfg);\n            return cfg;\n        }\n\n        function loadStoredPanelConfig() { // FIX\n            var t = getStoredPanelConfigText();\n            if (!t) return;\n            applyPanelConfigText(t);\n        }\n\n        function getDefaultPanelConfigUrlCandidates() { // FIX: allow config.json name and local dev paths\n            var out = [];\n            try {\n                var u = window.LukeToolsPanelConfigUrl ? s(window.LukeToolsPanelConfigUrl) : \"\";\n                if (u && u.trim()) out.push(u.trim());\n            } catch (e0) { }\n\n            try {\n                var u2 = localStorage.getItem(\"LukeToolsPanelConfigUrl\") || \"\";\n                if (u2 && String(u2).trim()) out.push(String(u2).trim());\n            } catch (e1) { }\n\n            // Same folder as this BridgeTool script\n            try {\n                var same = computePanelConfigUrlSameFolder(); // FIX\n                if (same && String(same).trim()) out.push(String(same).trim()); // FIX\n            } catch (e0) { }\n\n            // Common local dev locations (served from public)\n            out.push(\"/LukeToolsPanelConfig.json\"); // FIX\n            out.push(\"/LukeTools/config.json\"); // FIX\n            out.push(\"/config.json\"); // FIX\n            out.push(LT_GITHUB_RAW_BASE + \"scripts/config.json\"); // FIX: public scripts folder\n            out.push(LT_GITHUB_RAW_BASE + \"scripts/tools.json\"); // FIX: alternate config name\n\n            // Fallback to the built in default\n            if (DEFAULT_PANEL_JSON_URL) out.push(String(DEFAULT_PANEL_JSON_URL).trim()); // FIX\n\n            // De dupe while preserving order\n            var seen = {};\n            var uniq = [];\n            for (var i = 0; i < out.length; i += 1) {\n                var k = s(out[i]).trim();\n                if (!k) continue;\n                if (seen[k]) continue;\n                seen[k] = true;\n                uniq.push(k);\n            }\n            return uniq;\n        }\n\n        function autoLoadPanelConfig() { // FIX: try stored JSON, else try multiple candidate URLs\n            var existing = \"\";\n            try { existing = getStoredPanelConfigText(); } catch (e0) { existing = \"\"; }\n\n            if (existing && String(existing).trim()) {\n                try { applyPanelConfigText(String(existing)); } catch (e1) { }\n                return;\n            }\n\n            var candidates = [];\n            try { candidates = getDefaultPanelConfigUrlCandidates(); } catch (e2) { candidates = []; }\n\n            if (!candidates || !candidates.length) return;\n\n            var i = 0;\n\n            function tryNext() {\n                if (i >= candidates.length) {\n                    return;\n                }\n\n                var u = String(candidates[i] || \"\").trim();\n                i += 1;\n\n                if (!u) return tryNext();\n\n                fetchText(u).then(function (t) {\n                    // Validate JSON before storing\n                    try {\n                        applyPanelConfigText(String(t));\n                        setStoredPanelConfigText(String(t));\n                        try { localStorage.setItem(\"LukeToolsPanelConfigUrl\", u); } catch (e3) { }\n                    } catch (e4) {\n                        // Bad json, continue to next candidate\n                        tryNext();\n                    }\n                }).catch(function () {\n                    // Not found, continue to next candidate\n                    tryNext();\n                });\n            }\n\n            tryNext();\n        }\n\n        jsonChooseBtn.addEventListener(\"click\", function (e) { // FIX\n            e.preventDefault();\n            e.stopPropagation();\n            try { jsonFileInput.click(); } catch (e1) { }\n        });\n\n        jsonFileInput.addEventListener(\"change\", function () { // FIX\n            var f = jsonFileInput.files && jsonFileInput.files[0] ? jsonFileInput.files[0] : null;\n            if (!f) return;\n            var reader = new FileReader();\n            reader.onload = function () {\n                var txt = s(reader.result || \"\");\n                setStoredPanelConfigText(txt);\n                applyPanelConfigText(txt);\n                try { loadedLabel.textContent = \"Loaded json: \" + s(f.name || \"\"); } catch (e2) { }\n            };\n            reader.readAsText(f);\n        });\n\n        jsonLoadUrlBtn.addEventListener(\"click\", function (e) { // FIX\n            e.preventDefault();\n            e.stopPropagation();\n            var u = s(jsonUrlInput.value || \"\").trim();\n            if (!u) return;\n            fetchText(u).then(function (t) {\n                setStoredPanelConfigText(s(t));\n                applyPanelConfigText(s(t));\n                try { loadedLabel.textContent = \"Loaded json url\"; } catch (e2) { }\n            }).catch(function (err) {\n                alert(\"Json load failed\\n\" + s(err && err.message ? err.message : err));\n            });\n\n            jsonShowPanelBtn.addEventListener(\"click\", function (e) { // FIX\n                e.preventDefault();\n                e.stopPropagation();\n                try { loadStoredPanelConfig(); } catch (e1) { }\n            });\n        });\n\n        jsonClearBtn.addEventListener(\"click\", function (e) { // FIX\n            e.preventDefault();\n            e.stopPropagation();\n            clearStoredPanelConfig();\n            clearIconsHost();\n            try { clearPanelTool(); } catch (e3) { } // FIX\n            try { loadedLabel.textContent = \"\"; } catch (e2) { }\n        });\n\n        // Load any saved config on startup\n        try { loadStoredPanelConfig(); } catch (e) { }\n        try { autoLoadPanelConfig(); } catch (e2) { } // FIX\n\n        var optionsRow = document.createElement(\"div\");\n        optionsRow.style.display = \"flex\";\n        optionsRow.style.alignItems = \"center\";\n        optionsRow.style.justifyContent = \"space-between\";\n        optionsRow.style.gap = \"10px\";\n\n        var fullscreenWrap = document.createElement(\"label\");\n        fullscreenWrap.style.display = \"flex\";\n        fullscreenWrap.style.alignItems = \"center\";\n        fullscreenWrap.style.gap = \"8px\";\n        fullscreenWrap.style.fontSize = \"12px\";\n        fullscreenWrap.style.color = \"#bbb\";\n\n        var fullscreenCheck = document.createElement(\"input\");\n        fullscreenCheck.type = \"checkbox\";\n        fullscreenCheck.checked = false;\n\n        var fsTxt = document.createElement(\"span\");\n        fsTxt.textContent = \"Fullscreen\";\n\n        fullscreenWrap.appendChild(fullscreenCheck);\n        fullscreenWrap.appendChild(fsTxt);\n\n        var openFsBtn = document.createElement(\"button\");\n        openFsBtn.type = \"button\";\n        openFsBtn.textContent = \"Open fullscreen\";\n        openFsBtn.style.padding = \"10px\";\n        openFsBtn.style.borderRadius = \"10px\";\n        openFsBtn.style.border = \"0\";\n        openFsBtn.style.background = \"#21b26b\";\n        openFsBtn.style.color = \"white\";\n        openFsBtn.style.cursor = \"pointer\";\n        openFsBtn.style.fontSize = \"13px\";\n        openFsBtn.style.fontWeight = \"700\";\n\n        optionsRow.appendChild(fullscreenWrap);\n        optionsRow.appendChild(openFsBtn);\n\n        var repairBtn = document.createElement(\"button\");\n        repairBtn.textContent = \"Repair scripts\";\n        repairBtn.style.padding = \"10px 14px\";\n        repairBtn.style.borderRadius = \"10px\";\n        repairBtn.style.border = \"1px solid #333\";\n        repairBtn.style.background = \"#2a2a2a\";\n        repairBtn.style.color = \"#eee\";\n        repairBtn.style.cursor = \"pointer\";\n        repairBtn.style.fontWeight = \"700\";\n\n        repairBtn.addEventListener(\"click\", function () {\n            try {\n                var res = Bridge.repairProjectDefaultScripts({\n                    onlyDefault: true,\n                    clearBroken: true,\n                    reportOnly: false,\n                    backup: true\n                });\n\n                var msg = \"Repair complete\\n\" +\n                    \"Owners scanned: \" + String(res.owners) + \"\\n\" +\n                    \"Scripts checked: \" + String(res.scriptsChecked) + \"\\n\" +\n                    \"Bad scripts found: \" + String(res.badScripts) + \"\\n\" +\n                    \"Cleared: \" + String(res.cleared) + \"\\n\" +\n                    \"Backed up: \" + String(res.backedUp) + \"\\n\\n\" +\n                    \"Backups are stored in localStorage keys starting with \" + \"LukeToolsBrokenScriptBackup\";\n\n                console.log(\"[LukeTools] Repair result\", res);\n                alert(msg);\n            } catch (e) {\n                console.error(\"[LukeTools] Repair failed\", e);\n                alert(\"Repair failed\\n\" + (e && e.message ? e.message : String(e)));\n            }\n        });\n\n        optionsRow.appendChild(repairBtn);\n\n        topBox.appendChild(fileRow);\n        topBox.appendChild(folderRow);\n        topBox.appendChild(loadedLabel);\n        topBox.appendChild(configBox); // FIX: JSON config UI\n        topBox.appendChild(optionsRow);\n\n        var toolFrame = document.createElement(\"iframe\");\n        toolFrame.id = PANEL_IFRAME_ID;\n        toolFrame.style.width = \"100%\";\n        toolFrame.style.border = \"0\";\n        toolFrame.style.background = \"transparent\";\n        toolFrame.style.display = \"block\";\n        toolFrame.style.height = \"540px\"; // FIX: fill panel with icon launcher\n\n        body.appendChild(topBox);\n        body.appendChild(toolFrame);\n\n        // FIX: close button bottom right for panel tools\n        var toolCloseBR = document.createElement(\"button\");\n        toolCloseBR.type = \"button\";\n        toolCloseBR.textContent = \"Close\"; // FIX: label should read Close\n        toolCloseBR.title = \"Close\"; // FIX: match label\n        toolCloseBR.style.position = \"absolute\";\n        toolCloseBR.style.left = \"50%\"; // FIX: center bottom close button\n        toolCloseBR.style.transform = \"translateX(-50%)\"; // FIX: center bottom close button // FIX: move in from edge so it is never cut off\n        toolCloseBR.style.bottom = \"18px\"; // FIX: move in from edge so it is never cut off\n        toolCloseBR.style.width = \"88px\"; // FIX: fit Close label\n        toolCloseBR.style.height = \"42px\"; // FIX: larger tap target\n        toolCloseBR.style.borderRadius = \"14px\"; // FIX: match other rounded buttons\n        toolCloseBR.style.border = \"1px solid rgba(255,255,255,0.12)\";\n        toolCloseBR.style.background = \"rgba(255,255,255,0.08)\";\n        toolCloseBR.style.color = \"white\";\n        toolCloseBR.style.cursor = \"pointer\";\n        toolCloseBR.style.fontSize = \"14px\"; // FIX\n        toolCloseBR.style.fontWeight = \"700\";\n        toolCloseBR.style.zIndex = \"999999\"; // FIX: keep above iframe scrollbars\n        toolCloseBR.style.display = \"none\";\n\n        toolCloseBR.addEventListener(\"pointerdown\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n        });\n\n        toolCloseBR.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            try { resetPanelSizeToDefault(); } catch (e0) { }\n            try { showJsonIconPanel(window.__LT_panelCfg || null); } catch (e1) { }\n            try { setPanelToolCloseVisible(false); } catch (e2) { }\n        });\n\n        panel.__LT_toolCloseBR = toolCloseBR; // FIX: store reference\n        panel.appendChild(toolCloseBR); // FIX\n\n        panel.appendChild(header);\n        panel.appendChild(body);\n        document.body.appendChild(panel);\n\n        function setPanelToolHeight(h) {\n            var fr = document.getElementById(PANEL_IFRAME_ID);\n            if (!fr) return;\n\n            var minH = 140;\n            var maxH = Math.max(180, Math.floor(window.innerHeight * 0.78));\n            var v = parseInt(h, 10);\n            if (isNaN(v)) v = 220;\n            if (v < minH) v = minH;\n            if (v > maxH) v = maxH;\n\n            fr.style.height = v + \"px\";\n            clampPanelToView();\n        }\n\n        window.addEventListener(\"message\", function (evt) {\n            var fr = document.getElementById(PANEL_IFRAME_ID);\n            if (!fr || !fr.contentWindow) return;\n            if (evt.source !== fr.contentWindow) return;\n\n            var data = evt.data;\n            if (!data || typeof data !== \"object\") return;\n\n            if (data.type === \"LukeToolsToolHeight\") {\n                setPanelToolHeight(data.h);\n                return;\n            }\n\n            // FIX: Run tool selected from JSON icon panel\n            \n            // FIX: Run tool imported from Sandbox as raw text (no blob URLs from srcdoc origin)\n            if (data.type === \"LukeToolsRunJsonToolText\") { // FIX\n                try {\n                    var t0 = s(data.text || \"\");\n                    if (!t0) return;\n\n                    // FIX: if raw JS, wrap it in an HTML document so it executes\n                    if (data && data.isJs) { // FIX\n                        t0 = __LT_wrapJsToolAsHtml(t0); // FIX\n                    }\n\n                    var runFullscreen = true; // FIX: keep launcher visible, open tools fullscreen\n                    t0 = stripFScreenDirectives(t0);\n\n                    lastLoaded.name = s(data.name || \"Sandbox Import\");\n                    lastLoaded.htmlDoc = ensureHtmlDocument(t0);\n\n                    // FIX: inject cssUrl from JSON into the tool document\n                    try {\n                        var __cssUrlT = s(data && (data.cssUrl || data.css || data.css_url) ? (data.cssUrl || data.css || data.css_url) : \"\");\n                        if (!__cssUrlT) __cssUrlT = s(data && data.cssUrl !== undefined ? data.cssUrl : \"\");\n                        if (__cssUrlT) {\n                            var __uT = __cssUrlT;\n                            try { __uT = new URL(__cssUrlT, window.location.href).href; } catch (eUT0) { }\n                            lastLoaded.htmlDoc = lastLoaded.htmlDoc.replace(\"</head>\", \"<link rel=\\\"stylesheet\\\" href=\\\"\" + escapeAttr(__uT) + \"\\\"></head>\");\n                        }\n                    } catch (eCT0) { }\n\n                    loadedLabel.textContent = \"\"; // FIX\n\n                    // FIX: honor F_Screen from message and allow in-file override\n                    var __fsRawT = (data && (data.fs !== undefined && data.fs !== null)) ? data.fs : (data ? data.F_Screen : undefined); // FIX\n                    var __fsFromItemT = (__fsRawT !== undefined && __fsRawT !== null && String(__fsRawT).trim() !== \"\") ? parseInt(String(__fsRawT), 10) : NaN; // FIX\n                    var __fsInFileT = detectFScreenFlag(t0); // FIX\n                    var __finalFsT = (!isNaN(__fsFromItemT)) ? __fsFromItemT : 1; // FIX\n                    if (__fsInFileT === 0 || __fsInFileT === 1) __finalFsT = __fsInFileT; // FIX\n                    if (__finalFsT === 1) {\n                        try { resetPanelSizeToDefault(); } catch (eRT0) { } // FIX\n                        openFullscreen(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(false); } catch (eVT1) { } // FIX\n                    } else {\n                        try { applyPanelSizeFromMessage(data); } catch (eRT1) { } // FIX\n                        runToolInPanel(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(true); } catch (eVT0) { } // FIX\n                    }\n\n                    log(\"[LukeTools] loaded from sandbox text\", lastLoaded.name, \"fullscreen\", runFullscreen); // FIX\n                } catch (e) {\n                    alert(\"Sandbox import failed\\n\" + s(e && e.message ? e.message : e));\n                }\n                return;\n            }\n\nif (data.type === \"LukeToolsRunJsonTool\") {\n                var u = s(data.url || \"\").trim();\n                if (!u) return;\n\n                fetchText(u).then(function (raw) {\n                    var t = s(raw || \"\");\n                    var runFullscreen = true; // FIX: keep launcher visible, open tools fullscreen\n                    t = stripFScreenDirectives(t);\n\n                    lastLoaded.name = s(data.name || u);\n                    lastLoaded.htmlDoc = ensureHtmlDocument(t);\n\n\n                    // FIX: inject cssUrl from JSON into the tool document\n                    try {\n                        var __cssUrl = s(data && (data.cssUrl || data.css || data.css_url) ? (data.cssUrl || data.css || data.css_url) : \"\");\n                        if (!__cssUrl) __cssUrl = s(data && data.cssUrl !== undefined ? data.cssUrl : \"\");\n                        if (__cssUrl) {\n                            var __u = __cssUrl;\n                            try { __u = new URL(__cssUrl, window.location.href).href; } catch (eU0) { }\n                            lastLoaded.htmlDoc = lastLoaded.htmlDoc.replace(\"</head>\", \"<link rel=\\\"stylesheet\\\" href=\\\"\" + escapeAttr(__u) + \"\\\"></head>\");\n                        }\n                    } catch (eC0) { }\n\n\n                    loadedLabel.textContent = \"\"; // FIX\n\n                    // FIX: honor F_Screen from JSON and allow in-file override\n                    var __fsRaw = (data && (data.fs !== undefined && data.fs !== null)) ? data.fs : (data ? data.F_Screen : undefined); // FIX: accept fs or F_Screen\n                    var __fsFromItem = (__fsRaw !== undefined && __fsRaw !== null && String(__fsRaw).trim() !== \"\") ? parseInt(String(__fsRaw), 10) : NaN; // FIX\n                    var __fsInFile = detectFScreenFlag(t); // FIX\n                    var __finalFs = (!isNaN(__fsFromItem)) ? __fsFromItem : 1; // FIX\n                    if (__fsInFile === 0 || __fsInFile === 1) __finalFs = __fsInFile; // FIX\n                    if (__finalFs === 1) {\n                        try { resetPanelSizeToDefault(); } catch (eR0) { } // FIX\n                        openFullscreen(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(false); } catch (eV1) { } // FIX\n                    } else {\n                        try { applyPanelSizeFromMessage(data); } catch (eR1) { } // FIX\n                        runToolInPanel(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(true); } catch (eV0) { } // FIX\n                    }\n\n                    log(\"[LukeTools] loaded from json\", lastLoaded.name, \"fullscreen\", runFullscreen); // FIX\n                }).catch(function (err) {\n                    alert(\"Tool load failed\\n\" + s(err && err.message ? err.message : err));\n                });\n\n                return;\n            }\n        });\n\n        function runToolInPanel(htmlDoc) {\n            var fr = document.getElementById(PANEL_IFRAME_ID);\n            if (!fr) return;\n            try { fr.srcdoc = htmlDoc; } catch (e1) { fr.srcdoc = \"\"; }\n        }\n\n        function clearPanelTool() {\n            var fr = document.getElementById(PANEL_IFRAME_ID);\n            if (!fr) return;\n            try {\n                fr.srcdoc =\n                    \"<!doctype html><html><head><meta charset=\\\"utf-8\\\"><style>html,body{margin:0;background:transparent;font-family:Arial, sans serif;color:#eaeaea}body{padding:10px}</style></head><body>No tool loaded</body></html>\";\n            } catch (e) { }\n        }\n\n\n        function detectFScreenFlag(rawText) {\n            try {\n                var t = s(rawText || \"\");\n                // Prefer explicit variable declaration: var/let/const F_Screen = 1;\n                var m = t.match(/(?:^|\\n|\\r)\\s*(?:var|let|const)\\s+F_Screen\\s*=\\s*([01])\\s*;?/);\n                if (m && m[1] !== undefined) return parseInt(m[1], 10);\n\n                // Allow HTML meta: <meta name=\"F_Screen\" content=\"1\">\n                var mm = t.match(/<meta\\s+[^>]*name\\s*=\\s*[\"']F_Screen[\"'][^>]*content\\s*=\\s*[\"']([01])[\"'][^>]*>/i);\n                if (mm && mm[1] !== undefined) return parseInt(mm[1], 10);\n\n                // Allow data attribute: data-f_screen=\"1\" or data-f-screen=\"1\"\n                var md = t.match(/data-f[_-]screen\\s*=\\s*[\"']([01])[\"']/i);\n                if (md && md[1] !== undefined) return parseInt(md[1], 10);\n            } catch (e) { }\n            return null;\n        }\n\n\n        // F_Screen is a one-shot directive for THIS run only.\n        // It must NOT permanently toggle the fullscreen checkbox.\n        // We also strip the directive from the tool text before running.\n        function stripFScreenDirectives(rawText) {\n            var t = s(rawText || \"\");\n            try {\n                // Remove lines like: var/let/const F_Screen = 1;\n                t = t.replace(/(^|\\r?\\n)\\s*(?:var|let|const)\\s+F_Screen\\s*=\\s*[01]\\s*;?\\s*(?=\\r?\\n|$)/g, \"$1\");\n\n                // Remove meta directive: <meta name=\"F_Screen\" content=\"1\">\n                t = t.replace(/<meta\\s+[^>]*name\\s*=\\s*[\"']F_Screen[\"'][^>]*>\\s*/ig, \"\");\n            } catch (e) { }\n            return t;\n        }\n\n        function decideFullscreenForRun(rawText) {\n            try {\n                var v = detectFScreenFlag(rawText);\n                if (v === 1) return true;\n                if (v === 0) return false;\n            } catch (e) { }\n            return !!fullscreenCheck.checked;\n        }\n\n        function loadFile(file) {\n            if (!file) return;\n\n            var reader = new FileReader();\n            reader.onload = function (e) {\n                var raw = s(e.target.result || \"\");\n                var runFullscreen = decideFullscreenForRun(raw);\n                raw = stripFScreenDirectives(raw);\n                lastLoaded.name = s(file.name || \"\");\n                lastLoaded.htmlDoc = ensureHtmlDocument(raw);\n\n                loadedLabel.textContent = \"\";\n\n                if (runFullscreen) {\n                    openFullscreen(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(false); } catch (eV1) { } // FIX\n                    clearPanelTool();\n                } else {\n                    runToolInPanel(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(true); } catch (eV0) { } // FIX\n                }\n\n                log(\"[LukeTools] loaded\", lastLoaded.name, \"fullscreen\", runFullscreen);\n            };\n            reader.readAsText(file);\n        }\n\n        fileInput.addEventListener(\"change\", function () {\n            var f = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;\n            loadFile(f);\n        });\n\n        reloadBtn.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            var f = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;\n            if (f) loadFile(f);\n        });\n\n\n        // Folder picker: build dropdown from a chosen folder\n        folderInput.addEventListener(\"change\", function () {\n            try {\n                var all = folderInput.files ? Array.prototype.slice.call(folderInput.files) : [];\n                // Keep only .txt/.html/.htm\n                folderFiles = (all || []).filter(function (f) {\n                    var nm = s(f && f.name ? f.name : \"\").toLowerCase();\n                    if (nm.indexOf(\".user.\") !== -1) return false;\n                    return (nm.slice(-4) === \".txt\" || nm.slice(-5) === \".html\" || nm.slice(-4) === \".htm\");\n                });\n\n                folderFiles.sort(function (a, b) {\n                    var ap = s(a && (a.webkitRelativePath || a.name) ? (a.webkitRelativePath || a.name) : \"\");\n                    var bp = s(b && (b.webkitRelativePath || b.name) ? (b.webkitRelativePath || b.name) : \"\");\n                    return ap.localeCompare(bp, undefined, { numeric: true, sensitivity: \"base\" });\n                });\n\n                rebuildFolderDropdown();\n\n                // Do NOT auto-load. User must choose from dropdown.\n                folderMeta.textContent = folderFiles.length ? (folderFiles.length + \" files\") : \"No .txt/.html files\";\n                folderSelect.value = \"\";\n\n                log(\"[LukeTools] folder loaded\", folderFiles.length, \"files\");\n            } catch (err) {\n                log(\"[LukeTools] folder load error\", err && err.message ? err.message : String(err));\n            }\n        });\n\n        // Dropdown selection: load tool into panel/fullscreen like normal\n        folderSelect.addEventListener(\"change\", function () {\n            try {\n                if (!folderSelect.value) return;\n                var idx = parseInt(folderSelect.value, 10);\n                if (isNaN(idx) || !folderFiles[idx]) return;\n                loadFile(folderFiles[idx]);\n            } catch (err) {\n                log(\"[LukeTools] dropdown load error\", err && err.message ? err.message : String(err));\n            }\n        });\n\n\n        // Folder button -> open directory picker\n        folderBtn.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            try { folderInput.click(); } catch (err) { }\n        });\n\n        openFsBtn.addEventListener(\"click\", function (e) {\n            e.preventDefault();\n            e.stopPropagation();\n            if (!lastLoaded || !lastLoaded.htmlDoc) return;\n            openFullscreen(lastLoaded.htmlDoc);\n                        try { setPanelToolCloseVisible(false); } catch (eV1) { } // FIX\n        });\n\n        var dragging = false;\n        var startX = 0;\n        var startY = 0;\n        var startLeft = 0;\n        var startTop = 0;\n\n        function isInteractiveTarget(t) {\n            if (!t) return false;\n            var tag = (t.tagName || \"\").toLowerCase();\n            if (tag === \"button\" || tag === \"input\" || tag === \"select\" || tag === \"textarea\" || tag === \"a\") return true;\n            return false;\n        }\n\n        header.addEventListener(\"pointerdown\", function (e) {\n            if (isInteractiveTarget(e.target)) return;\n\n            dragging = true;\n            startX = e.clientX;\n            startY = e.clientY;\n\n            startLeft = parseInt(panel.style.left || \"10\", 10);\n            startTop = parseInt(panel.style.top || \"90\", 10);\n            if (isNaN(startLeft)) startLeft = 10;\n            if (isNaN(startTop)) startTop = 90;\n\n            header.style.cursor = \"grabbing\";\n            try { header.setPointerCapture(e.pointerId); } catch (e0) { }\n\n            e.preventDefault();\n            e.stopPropagation();\n        });\n\n        header.addEventListener(\"pointermove\", function (e) {\n            if (!dragging) return;\n\n            var dx = e.clientX - startX;\n            var dy = e.clientY - startY;\n\n            var nx = startLeft + dx;\n            var ny = startTop + dy;\n\n            var w = panel.offsetWidth || 620;\n            var h = panel.offsetHeight || 420;\n\n            var maxX = Math.max(0, window.innerWidth - w);\n            var maxY = Math.max(0, window.innerHeight - h);\n\n            if (nx < 0) nx = 0;\n            if (ny < 0) ny = 0;\n            if (nx > maxX) nx = maxX;\n            if (ny > maxY) ny = maxY;\n\n            setPanelPos(nx, ny);\n        });\n\n        function endDrag(e) {\n            if (!dragging) return;\n            dragging = false;\n            header.style.cursor = \"grab\";\n            try { header.releasePointerCapture(e.pointerId); } catch (e0) { }\n        }\n\n        header.addEventListener(\"pointerup\", endDrag);\n        header.addEventListener(\"pointercancel\", endDrag);\n\n        clearPanelTool();\n        clampPanelToView();\n\n        window.addEventListener(\"resize\", function () {\n            clampPanelToView();\n        });\n        return panel; // FIX\n    }\n\n    function mountLauncherOrObserve() {\n        if (getDockNode()) {\n            ensureLauncher(showPanel);\n            return;\n        }\n\n        var obs = new MutationObserver(function () {\n            if (getDockNode()) {\n                ensureLauncher(showPanel);\n                try { obs.disconnect(); } catch (e) { }\n            }\n        });\n\n        try { obs.observe(document.documentElement, { childList: true, subtree: true }); } catch (e2) { }\n    }\n\n    setTimeout(function () {\n        ensurePanel();\n        hidePanel();\n        mountLauncherOrObserve();\n        ensureOverlay();\n    }, 1200);\n\n})();\n"}],"cursor":"default","transformation":{"x":-54.53945,"y":178.36885,"scaleX":1,"scaleY":1,"rotation":0,"opacity":1},"animationType":"loop","singleFrameNumber":1,"assetSourceUUID":null,"isSynced":false},"children":[{"classname":"Timeline","identifier":null,"name":null,"uuid":"d435b44d-051f-4cc4-97a5-3ba7a093b3eb","children":["d9a86e7f-b738-4cfb-98c6-a8a816efcd62"],"playheadPosition":1,"activeLayerIndex":0},{"classname":"Layer","identifier":null,"name":"Layer","uuid":"d9a86e7f-b738-4cfb-98c6-a8a816efcd62","children":["db33bf83-04d3-466b-aa13-833cd4dc9c36"],"locked":false,"hidden":false},{"classname":"Frame","identifier":null,"name":null,"uuid":"db33bf83-04d3-466b-aa13-833cd4dc9c36","children":["8c787213-b88a-4f97-9857-6d087cba1257","6e038d15-4f30-4366-b318-94fb11787bff"],"scripts":[{"name":"default","src":""}],"cursor":"default","start":1,"end":1,"sound":null,"soundVolume":1,"soundLoop":false,"soundStart":0,"originalLayerIndex":0},{"classname":"Path","identifier":null,"name":null,"uuid":"8c787213-b88a-4f97-9857-6d087cba1257","children":[],"json":["Path",{"name":"8e6ccc06-4d27-4f95-9d7f-8b4b55a0745b","applyMatrix":true,"segments":[[[-31.54762,0],[0,17.42327],[0,-17.42327]],[[0,-31.54762],[-17.42327,0],[17.42327,0]],[[31.54762,0],[0,-17.42327],[0,17.42327]],[[0,31.54762],[17.42327,0],[-17.42327,0]]],"closed":true,"fillColor":[0,0,0],"strokeColor":[0,0.50196,1],"strokeWidth":8,"strokeCap":"round"}],"fontStyle":"normal","fontWeight":400},{"classname":"Path","identifier":null,"name":null,"uuid":"6e038d15-4f30-4366-b318-94fb11787bff","children":[],"json":["CompoundPath",{"name":"9b4497dc-840c-4a38-b6a8-6c4fc8b457e2","applyMatrix":true,"children":[["Path",{"applyMatrix":true,"segments":[[[11.36073,-18.63264],[0,0],[-0.75668,0.00201]],[[9.19857,-18.56314],[0.67115,-0.04479],[-3.17756,0.21196]],[[2.75049,-17.14834],[2.16063,-0.95905],[-2.22875,0.98928]],[[-1.52088,-16.64802],[1.34596,0.57064],[-3.05786,-1.29643]],[[-6.51884,-18.3348],[1.47738,0.2342],[-2.19573,-0.34808]],[[-16.68401,-18.32275],[2.2679,-0.35334],[-3.0706,0.47894]],[[-20.10319,-15.29594],[0,-2.23886],[0,1.16813]],[[-19.79386,-13.23445],[-0.24751,-0.48515],[0.16974,0.33271]],[[-19.02781,-10.26163],[-0.25178,-1.30268],[0.65844,3.4067]],[[-16.1785,-5.16192],[-1.7378,-0.88062],[0.67389,0.34149]],[[-13.22435,-4.27547],[-0.9789,-0.15446],[0.24941,0.03937]],[[-10.57953,-4.24955],[-1.20556,0.02491],[2.45504,-0.05081]],[[-5.24106,-5.42353],[-1.56209,0.83257],[1.60179,-0.85376]],[[-1.50012,-11.13046],[-0.9382,3.0206],[0.27117,-0.87301]],[[-0.85552,-12.91375],[-0.08292,0.10767],[0.09943,-0.12916]],[[0.12852,-13.0642],[-0.5497,-0.02953],[0.74101,0.03977]],[[1.07102,-12.64171],[-0.0974,-0.33611],[1.52659,5.26879]],[[7.00839,-4.69477],[-3.16275,-1.00786],[2.90588,0.92598]],[[16.72306,-5.42761],[-2.03625,1.29884],[1.34012,-0.85479]],[[19.11981,-10.45672],[-0.70084,3.42631],[0.28272,-1.38213]],[[19.90557,-13.3704],[-0.15039,0.2234],[0.2159,-0.32074]],[[20.18063,-15.23881],[-0.00158,1.15682],[0.00402,-2.10341]],[[17.65413,-18.16181],[2.19211,0.42839],[-1.55371,-0.30384]],[[11.36073,-18.63305],[2.2701,-0.00725],[0,0]]],"closed":true,"fillColor":[0,0,0,1]}],["Path",{"applyMatrix":true,"segments":[[[11.98769,-16.38848],[0,0],[0.76379,-0.00201]],[[13.91007,-16.28163],[-0.48784,-0.07552],[2.42714,0.37616]],[[17.05833,-12.63201],[-0.10451,-2.55917],[0.07051,1.72815]],[[16.29955,-8.54957],[0.6242,-1.24919],[-0.52341,1.04745]],[[13.69728,-6.53376],[1.31332,-0.37512],[-1.00308,0.28652]],[[9.15915,-6.29398],[1.3224,0.16371],[-1.30576,-0.1617]],[[5.4327,-8.06689],[0.69299,0.78925],[-0.57092,-0.65026]],[[3.64215,-11.73933],[0.22747,0.98703],[-0.08556,-0.37148]],[[3.48327,-13.57556],[0.00221,0.63831],[-0.00402,-1.07616]],[[3.8777,-15.04954],[-0.36974,0.29081],[0.21928,-0.17254]],[[5.04961,-15.59656],[-0.42507,0.12801],[1.51999,-0.45778]],[[11.98761,-16.38855],[-2.29138,0.00733],[0,0]]],"closed":true,"fillColor":[0,0,0,1]}],["Path",{"applyMatrix":true,"segments":[[[-11.66009,-16.35535],[0,0],[0.59785,0.00177]],[[-9.80412,-16.29207],[-0.63064,-0.04137],[2.70578,0.17818]],[[-4.34735,-15.26965],[-1.02805,-0.52097],[0.99073,0.50205]],[[-3.46193,-12.89781],[0.21127,-1.58756],[-0.54324,4.08215]],[[-9.3661,-6.29923],[3.49496,-0.43077],[-1.63408,0.20141]],[[-13.30012,-6.46112],[1.64719,0.33625],[-1.75159,-0.35756]],[[-16.64456,-9.40905],[0.58844,1.70483],[-0.29723,-0.86116]],[[-17.0037,-12.18881],[0,1.4377],[0,-2.25623]],[[-15.53806,-15.90589],[-1.11928,0.58235],[0.55592,-0.28924]],[[-11.66009,-16.35537],[-1.79353,-0.00529],[0,0]]],"closed":true,"fillColor":[0,0,0,1]}],["Path",{"applyMatrix":true,"segments":[[[2.74116,-0.68149],[0,0],[-0.17094,-0.00804]],[[2.20244,-0.67145],[0.18996,-0.01206],[-0.63602,0.04057]],[[0.49182,-0.21681],[0.50905,-0.26402],[0,0]],[-0.26905,0.17763],[[-1.07764,-0.22304],[0,0],[-0.65799,-0.3255]],[[-3.02079,-0.62371],[0.92179,0],[-1.51152,0]],[[-7.58072,2.12803],[2.4642,-2.39874],[-2.21643,2.15754]],[[-12.62024,5.05001],[1.96362,-0.26651],[-1.77068,0.24033]],[[-14.62252,5.70187],[0.17987,-0.39481],[-0.52551,1.15334]],[[-8.89692,9.14182],[-3.30773,-0.51795],[1.12153,0.17555]],[[-4.30583,9.03697],[-0.57592,0.21453],[0.17857,-0.06648]],[[-4.80407,9.78019],[0.47334,-0.5058],[-2.51856,2.69135]],[[-5.09886,19.90798],[-2.34638,-3.23913],[0.7907,1.09153]],[[-0.75378,24.6288],[-0.43267,-0.23757],[0.20784,0.11409]],[[-0.25346,24.84262],[-0.06735,-0.00317],[0.38321,0.01808]],[[4.70818,19.50419],[-0.93142,1.43345],[2.07115,-3.1875]],[[4.19748,9.80925],[2.37976,2.67003],[0,0]],[3.447,8.96743],[[4.10614,9.08473],[0,0],[0.36213,0.06488]],[[6.72917,9.18336],[-1.08083,0.01085],[1.64619,-0.01606]],[[10.02587,8.76503],[-1.11531,0.33315],[2.14607,-0.64108]],[[13.99,6.39736],[-0.47946,0.92718],[0.35495,-0.6864]],[[13.08174,5.19639],[0.8737,0],[-0.77325,0]],[[9.61067,4.33381],[0.75212,0.3794],[-0.47808,-0.24116]],[[6.86515,2.00454],[1.23828,1.21491],[-2.08167,-2.04238]],[[2.74116,-0.68077],[1.19682,0.05104],[0,0]]],"closed":true,"fillColor":[0,0,0,1]}]],"fillColor":[1,1,1],"strokeColor":[0,0,0,1],"strokeWidth":0.12174,"strokeCap":"square"}],"fontStyle":"normal","fontWeight":400}],"assets":[]}