<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>LukeTools Behaviour: Sine Block</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --text:#e7e7ea;
      --muted:#a8a8b3;
      --radius:12px;
      --radius2:10px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:transparent;color:var(--text);font-family:var(--font);}
    .wrap{padding:14px;box-sizing:border-box;}
    .card{
      background:rgba(20,20,22,0.92);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:var(--radius);
      padding:14px;
      box-sizing:border-box;
    }
    .title{font-size:16px;font-weight:700;margin:0 0 10px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text);}
    .btn{
      appearance:none;border:1px solid rgba(255,255,255,0.10);
      background:rgba(255,255,255,0.06);color:var(--text);
      border-radius:var(--radius2);padding:10px 12px;
      cursor:pointer;font-weight:700;font-size:13px;
    }
    .btn.primary{background:rgba(52,152,219,0.18);border-color:rgba(52,152,219,0.35);}
    .btn:active{transform:translateY(1px);}
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .field{display:flex;flex-direction:column;gap:6px;}
    label{font-size:12px;color:var(--muted);}
    input[type="number"]{
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.10);
      color:var(--text);
      border-radius:var(--radius2);
      padding:10px 10px;
      font-size:13px;
      outline:none;
    }
    .status{
      margin-top:12px;
      padding:10px 10px;
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(0,0,0,0.22);
      font-size:12px;
      color:var(--muted);
      white-space:pre-wrap;
    }
    .status.good{border-color:rgba(46,204,113,0.35);background:rgba(46,204,113,0.12);color:#d9ffe9;}
    .status.bad{border-color:rgba(231,76,60,0.35);background:rgba(231,76,60,0.12);color:#ffd9d6;}
    .status.warn{border-color:rgba(241,196,15,0.35);background:rgba(241,196,15,0.10);color:#fff2c2;}
    .small{font-size:11px;color:var(--muted);margin-top:8px;line-height:1.4;}
    .divider{height:1px;background:rgba(255,255,255,0.08);margin:12px 0;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">BEHAVIOUR MAKER: SINE BLOCK</div>

      <div class="row">
        <div class="pill"><strong>Selected Clip</strong> <span id="selLabel">No Clip Chosen</span></div>
        <button class="btn" id="btnRefresh">Refresh</button>
      </div>

      <div class="divider"></div>

      <div class="grid">
        <div class="field">
          <label for="amp">Amplitude pixels</label>
          <input id="amp" type="number" min="0" step="1" value="120">
        </div>
        <div class="field">
          <label for="speed">Speed cycles per second</label>
          <input id="speed" type="number" min="0" step="0.05" value="0.35">
        </div>
        <div class="field">
          <label for="phase">Phase offset radians</label>
          <input id="phase" type="number" step="0.1" value="0">
        </div>
        <div class="field">
          <label for="locky">Lock Y position</label>
          <input id="locky" type="number" step="1" value="1">
        </div>
      </div>

      <div class="row" style="margin-top:14px;">
        <button class="btn primary" id="btnCreate">Create</button>
      </div>

      <div id="status" class="status">Ready.</div>

      <div class="small">
        Notes
        <br>1. Select a solid clip then click Create
        <br>2. This injects an Update script that moves the clip left and right using a sine wave
        <br>3. Lock Y uses 1 to keep current Y constant, 0 allows Y to be unchanged by this behaviour
      </div>
    </div>
  </div>

<script>
(function(){
  "use strict";

  function $(id){ return document.getElementById(id); }

  var elSel = $("selLabel");
  var elStatus = $("status");

  function setStatus(msg, kind){
    elStatus.className = "status" + (kind ? (" " + kind) : "");
    elStatus.textContent = msg;
  }

  function getBridge(){
    return window.LukeToolsBridge || null;
  }

  function getSelection(){
    var bridge = getBridge();
    if(!bridge) return null;
    try{
      if(typeof bridge.getSelectionInfo === "function"){
        return bridge.getSelectionInfo();
      }
    }catch(e){}
    return null;
  }

  function refreshSelection(){
    var info = getSelection();
    if(!info || !info.uuid){
      elSel.textContent = "No Clip Chosen";
      elSel.removeAttribute("title");
      return null;
    }
    var label = (info.identifier ? info.identifier : (info.name ? info.name : info.uuid));
    elSel.textContent = label;
    elSel.setAttribute("title", info.uuid);
    return info;
  }

  function buildUpdateScript(opts){
    var cfg = {
      type: "LT_SINE_BLOCK",
      amp: Number(opts.amp)||120,
      speed: Number(opts.speed)||0.35,
      phase: Number(opts.phase)||0,
      lockY: (Number(opts.lockY)||0) ? 1 : 0
    };

    return [
"// LukeTools Behaviour: Sine Block",
"var LT_CFG = " + JSON.stringify(cfg, null, 0) + ";",
"",
"if(!this._LT_SINE){",
"  this._LT_SINE = { baseX: this.x, baseY: this.y, t: 0 };",
"}",
"",
"var st = this._LT_SINE;",
"",
"var dt = 1/60;",
"try {",
"  var p = this.project || null;",
"  if (p && typeof p._LT_lastTimeMs === 'number') {",
"    var now = Date.now();",
"    dt = (now - p._LT_lastTimeMs) / 1000;",
"    if (!isFinite(dt) || dt <= 0 || dt > 0.25) dt = 1/60;",
"    p._LT_lastTimeMs = now;",
"  } else if (p) {",
"    p._LT_lastTimeMs = Date.now();",
"  }",
"} catch(e) { }",
"",
"st.t += dt;",
"",
"var w = (Math.PI * 2) * (LT_CFG.speed || 0);",
"var xOff = (LT_CFG.amp || 0) * Math.sin((w * st.t) + (LT_CFG.phase || 0));",
"",
"this.x = st.baseX + xOff;",
"if (LT_CFG.lockY) {",
"  this.y = st.baseY;",
"}",
"",
"try {",
"  var p2 = this.project || null;",
"  if (p2) {",
"    if (!p2._LT_SOLIDS) p2._LT_SOLIDS = {};",
"    p2._LT_SOLIDS[this.uuid] = this;",
"  }",
"} catch(e2) { }",
"",
"// End"
    ].join("\n");
  }

  function injectUpdateScript(scriptText){
    var bridge = getBridge();
    if(!bridge){
      setStatus("LukeToolsBridge not found. This tool must run inside the Luke Tools panel.", "bad");
      return false;
    }
    if(typeof bridge.setUpdateScriptOnSelection !== "function"){
      setStatus("Bridge missing setUpdateScriptOnSelection.", "bad");
      return false;
    }
    try{
      var r = bridge.setUpdateScriptOnSelection(scriptText);
      if (r && r.ok === false) throw new Error(r.reason || "update script failed");
      return true;
    }catch(e){
      setStatus("Inject failed: " + (e && e.message ? e.message : String(e)), "bad");
      return false;
    }
  }

  $("btnRefresh").addEventListener("click", function(){
    refreshSelection();
  });

  $("btnCreate").addEventListener("click", function(){
    var info = refreshSelection();
    if(!info || !info.uuid){
      setStatus("No Clip Chosen. Select a clip on the stage and try again.", "warn");
      return;
    }

    var opts = {
      amp: $("amp").value,
      speed: $("speed").value,
      phase: $("phase").value,
      lockY: $("locky").value
    };

    var scriptText = buildUpdateScript(opts);
    var ok = injectUpdateScript(scriptText);
    if(ok){
      setStatus("Success. Added sine movement behaviour to: " + (info.identifier ? info.identifier : (info.name ? info.name : info.uuid)), "good");
    }
  });

  refreshSelection();
})();
</script>
</body>
</html>
