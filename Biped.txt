<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Biped</title>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; background:#0f0f0f; color:#ffffff; font-family:Arial, sans serif; }
    .wrap { display:flex; flex-direction:column; height:100%; }
    .top { padding:18px 22px; background:#1c1c1c; border-bottom:1px solid rgba(255,255,255,0.08); }
    .title { font-size:20px; font-weight:700; margin:0 0 6px 0; }
    .sub { font-size:13px; opacity:0.85; }
    .content { flex:1; padding:22px; display:flex; gap:18px; align-items:flex-start; }
    .card { width:420px; max-width:calc(100vw - 44px); background:#1a1a1a; border:1px solid rgba(255,255,255,0.08); border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,0.35); padding:18px; }
    .card h3 { margin:0 0 10px 0; font-size:16px; }
    .row { margin-top:10px; }
    .btn { width:100%; padding:14px 12px; border:0; border-radius:12px; background:rgba(0,148,255,0.78); color:#fff; font-size:15px; font-weight:700; cursor:pointer; }
    .btn:active { transform:translateY(1px); }
    .muted { font-size:12px; opacity:0.75; margin-top:10px; line-height:1.35; }
    .log { margin-top:12px; font-family:Consolas, monospace; font-size:12px; white-space:pre-wrap; background:#101010; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px; min-height:84px; }
    .kv { font-family:Consolas, monospace; font-size:12px; opacity:0.9; background:#101010; border:1px solid rgba(255,255,255,0.08); border-radius:12px; padding:12px; }
    .kv div { margin:4px 0; }
    .mini { font-size:11px; opacity:0.7; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Biped</div>
      <div class="sub">Select Arm_R then click Arrange. Close this tool to show the pose panel in Wick.</div>
    </div>

    <div class="content">
      <div class="card">
        <h3>Arrange</h3>
        <div class="kv" id="selBox">
          <div>Selected clip <span id="selName"></span></div>
          <div>Selected uuid <span id="selUuid"></span></div>
        </div>

        <div class="row">
          <button class="btn" id="arrangeBtn">Arrange Arm</button>
          <div class="muted">Expected nesting Arm_R contains Shoulder_R and Shoulder_R contains Elbo_R</div>
        </div>

        <div class="log" id="logBox"></div>
        <div class="mini">If Arrange says missing something, check your identifiers exactly match Shoulder_R and Elbo_R</div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      function s(v) { return (v === null || v === undefined) ? "" : String(v); }

      function getBridge() {
        try { if (window.LukeToolsBridge) return window.LukeToolsBridge; } catch (e1) {}
        try { if (window.parent && window.parent.LukeToolsBridge) return window.parent.LukeToolsBridge; } catch (e2) {}
        return null;
      }

      var logBox = document.getElementById("logBox");
      var selName = document.getElementById("selName");
      var selUuid = document.getElementById("selUuid");
      var arrangeBtn = document.getElementById("arrangeBtn");

      function log(msg) {
        logBox.textContent = s(msg);
      }

      function refreshSelection() {
        var bridge = getBridge();
        if (!bridge) {
          selName.textContent = "";
          selUuid.textContent = "";
          return;
        }
        try {
          selName.textContent = s(bridge.getSelectedClipName ? bridge.getSelectedClipName() : "");
        } catch (e1) { selName.textContent = ""; }
        try {
          selUuid.textContent = s(bridge.getSelectedClipUUID ? bridge.getSelectedClipUUID() : "");
        } catch (e2) { selUuid.textContent = ""; }
      }

      arrangeBtn.addEventListener("click", function () {
        var bridge = getBridge();
        if (!bridge) {
          log("Bridge not found");
          return;
        }
        if (typeof bridge.arrangeArmRigOnSelection !== "function") {
          log("arrangeArmRigOnSelection missing on bridge");
          return;
        }

        log("Arranging");
        try {
          var res = bridge.arrangeArmRigOnSelection({ shoulderId: "Shoulder_R", elbowId: "Elbo_R" });
          if (!res || res.ok !== true) {
            log("Arrange failed " + s(res && res.error ? res.error : "unknown"));
            return;
          }
          log("Arrange ok\njoinY " + s(res.joinY) + "\nshoulder moved " + s(res.shoulderNormalized && res.shoulderNormalized.moved) + "\nelbow moved " + s(res.elbowNormalized && res.elbowNormalized.moved));
        } catch (e) {
          log("Arrange failed " + s(e));
        }
      });

      refreshSelection();
      setInterval(refreshSelection, 350);
    })();
  </script>
</body>
</html>
