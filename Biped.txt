<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Inspect selected clip children version 3</title>
  <style>
    body{
      font-family: Arial, sans serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: #111;
    }
    h1{
      font-size: 18px;
      margin: 0 0 10px 0;
    }
    .row{ margin: 10px 0; }
    .box{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      background: #fafafa;
    }
    button{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      margin-right: 8px;
    }
    button:active{ transform: translateY(1px); }
    pre{
      font-family: Consolas, Menlo, Monaco, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }
    .label{ font-weight: 700; }
    .muted{ color: #444; font-size: 13px; }
    code{
      font-family: Consolas, Menlo, Monaco, monospace;
      font-size: 12px;
      background: #f1f1f1;
      padding: 2px 6px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>Inspect selected clip contents</h1>

  <div class="row box">
    <div class="row"><span class="label">Tool</span>: <span id="toolVersion"></span></div>
    <div class="row"><span class="label">Selected clip name</span>: <span id="selName">(none)</span></div>
    <div class="row muted">
      This inspects the selected clip timeline and lists child clip instances.
      It then dumps any string fields on the instance that look like names or ids, and tries to resolve clip asset names by searching the project library using any uuid values it can discover.
    </div>
    <div class="row">
      <button id="btnRefresh" type="button">Refresh selection</button>
      <button id="btnInspect" type="button">Inspect children</button>
    </div>
  </div>

  <div class="row box">
    <div class="row"><span class="label">Log</span></div>
    <pre id="log"></pre>
  </div>

<script>
(function () {
  "use strict";

  var VERSION = "inspect selected clip children v3";

  function el(id){ return document.getElementById(id); }
  el("toolVersion").textContent = VERSION;

  var logEl = el("log");

  function clearLog(){ logEl.textContent = ""; }
  function logLine(t){ logEl.textContent += String(t === undefined ? "" : t) + "\n"; }

  function s(v){
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function tidy(v){
    return s(v).replace(/\s+/g, " ").trim();
  }

  function isFiniteNumber(v){
    return typeof v === "number" && isFinite(v);
  }

  function getBridge(){
    try{ if (window.LukeToolsBridge) return window.LukeToolsBridge; }catch(e1){}
    try{ if (window.parent && window.parent.LukeToolsBridge) return window.parent.LukeToolsBridge; }catch(e2){}
    return null;
  }

  function getEditor(){
    try { if (window.wickEditor) return window.wickEditor; } catch (e1) {}
    try { if (window.WickEditor && window.WickEditor.editor) return window.WickEditor.editor; } catch (e2) {}
    try { if (window.editor) return window.editor; } catch (e3) {}
    try { if (window.app) return window.app; } catch (e4) {}

    try { if (window.parent && window.parent.wickEditor) return window.parent.wickEditor; } catch (e5) {}
    try { if (window.parent && window.parent.WickEditor && window.parent.WickEditor.editor) return window.parent.WickEditor.editor; } catch (e6) {}
    try { if (window.parent && window.parent.editor) return window.parent.editor; } catch (e7) {}
    try { if (window.parent && window.parent.app) return window.parent.app; } catch (e8) {}

    return null;
  }

  function getProject(ed){
    if (!ed) return null;
    try { if (ed.project) return ed.project; } catch (e1) {}
    try { if (ed.editor && ed.editor.project) return ed.editor.project; } catch (e2) {}
    try { if (ed.state && ed.state.project) return ed.state.project; } catch (e3) {}
    return null;
  }

  function getObjUUID(obj){
    if (!obj) return "";
    try { if (typeof obj.uuid === "string") return tidy(obj.uuid); } catch (e1) {}
    try { if (typeof obj.UUID === "string") return tidy(obj.UUID); } catch (e2) {}
    try { if (typeof obj.id === "string") return tidy(obj.id); } catch (e3) {}
    return "";
  }

  function getObjName(obj){
    if (!obj) return "";
    try { if (typeof obj.name === "string") return tidy(obj.name); } catch (e1) {}
    try { if (typeof obj.getName === "function") return tidy(obj.getName()); } catch (e2) {}

    try { if (typeof obj.displayName === "string") return tidy(obj.displayName); } catch (e3) {}
    try { if (typeof obj.label === "string") return tidy(obj.label); } catch (e4) {}
    try { if (typeof obj.title === "string") return tidy(obj.title); } catch (e5) {}
    try { if (typeof obj.objectName === "string") return tidy(obj.objectName); } catch (e6) {}
    try { if (typeof obj._name === "string") return tidy(obj._name); } catch (e7) {}

    return "";
  }

  function getXY(obj){
    if (!obj) return null;

    try{
      if (isFiniteNumber(obj.x) && isFiniteNumber(obj.y)) return { x: obj.x, y: obj.y, mode: "xy" };
    }catch(e1){}

    try{
      if (obj.transformation && isFiniteNumber(obj.transformation.x) && isFiniteNumber(obj.transformation.y)) {
        return { x: obj.transformation.x, y: obj.transformation.y, mode: "transformation" };
      }
    }catch(e2){}

    try{
      if (obj.transform && isFiniteNumber(obj.transform.x) && isFiniteNumber(obj.transform.y)) {
        return { x: obj.transform.x, y: obj.transform.y, mode: "transform" };
      }
    }catch(e3){}

    return null;
  }

  function getTimelineFromAsset(asset){
    if (!asset) return null;
    try{ if (asset.timeline) return asset.timeline; }catch(e1){}
    try{ if (asset._timeline) return asset._timeline; }catch(e2){}
    return null;
  }

  function looksLikeClipInstance(obj){
    if (!obj) return false;
    try{ if (obj.clipAsset) return true; }catch(e1){}
    try{ if (obj.asset && getTimelineFromAsset(obj.asset)) return true; }catch(e2){}
    try{ if (getTimelineFromAsset(obj)) return true; }catch(e3){}
    return false;
  }

  function resolveClipAssetFromObject(obj){
    if (!obj) return null;
    try{ if (obj.clipAsset) return obj.clipAsset; }catch(e1){}
    try{ if (obj.asset) return obj.asset; }catch(e2){}
    if (getTimelineFromAsset(obj)) return obj;
    return null;
  }

  function getLayersFromTimeline(tl){
    if (!tl) return [];
    try{ if (Array.isArray(tl.layers)) return tl.layers; }catch(e1){}
    try{ if (Array.isArray(tl._layers)) return tl._layers; }catch(e2){}
    return [];
  }

  function getFramesFromLayer(layer){
    if (!layer) return [];
    try{ if (Array.isArray(layer.frames)) return layer.frames; }catch(e1){}
    try{ if (Array.isArray(layer._frames)) return layer._frames; }catch(e2){}
    try{ if (Array.isArray(layer.frame)) return layer.frame; }catch(e3){}
    return [];
  }

  function getObjectsFromFrame(fr){
    if (!fr) return [];
    try{ if (Array.isArray(fr.wickObjects)) return fr.wickObjects; }catch(e1){}
    try{ if (Array.isArray(fr.objects)) return fr.objects; }catch(e2){}
    try{ if (Array.isArray(fr.children)) return fr.children; }catch(e3){}
    try{ if (Array.isArray(fr._children)) return fr._children; }catch(e4){}
    return [];
  }

  function collectFramesFromTimeline(tl){
    var frames = [];
    var layers = getLayersFromTimeline(tl);
    for (var i = 0; i < layers.length; i += 1){
      var frs = getFramesFromLayer(layers[i]);
      for (var j = 0; j < frs.length; j += 1){
        if (frs[j]) frames.push({ frame: frs[j], layerIndex: i, frameIndex: j });
      }
    }
    return frames;
  }

  function uuidLike(v){
    v = tidy(v);
    if (!v) return false;
    return /^[0-9a-f]{8}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{4}\-[0-9a-f]{12}$/i.test(v);
  }

  function extractStringFields(obj, maxDepth){
    maxDepth = maxDepth || 2;

    var out = [];
    var uuidCandidates = [];
    var seen = new Set();

    function addUUID(v){
      v = tidy(v);
      if (!v) return;
      if (!uuidLike(v)) return;
      if (uuidCandidates.indexOf(v) !== -1) return;
      uuidCandidates.push(v);
    }

    function addField(k, v){
      k = tidy(k);
      v = tidy(v);
      if (!k && !v) return;
      out.push({ key: k, value: v });
      addUUID(v);
    }

    function shouldKeepKey(k){
      k = String(k || "").toLowerCase();
      return (
        k.indexOf("name") !== -1 ||
        k.indexOf("label") !== -1 ||
        k.indexOf("title") !== -1 ||
        k.indexOf("uuid") !== -1 ||
        k.indexOf("id") !== -1 ||
        k.indexOf("asset") !== -1 ||
        k.indexOf("clip") !== -1
      );
    }

    function walk(cur, prefix, depth){
      if (!cur) return;
      if (seen.has(cur)) return;
      seen.add(cur);

      var keys = [];
      try { keys = Object.keys(cur); } catch (e1) { keys = []; }

      for (var i = 0; i < keys.length; i += 1){
        var k = keys[i];
        var v = null;

        try { v = cur[k]; } catch (e2) { continue; }

        var fullKey = prefix ? (prefix + "." + k) : k;

        if (typeof v === "string"){
          if (shouldKeepKey(k) || uuidLike(v)) addField(fullKey, v);
          continue;
        }

        if (typeof v === "number" || typeof v === "boolean"){
          if (shouldKeepKey(k)) addField(fullKey, String(v));
          continue;
        }

        if (v && typeof v === "object" && depth < maxDepth){
          // Only walk likely useful branches
          var kk = String(k || "").toLowerCase();
          var allow =
            kk.indexOf("asset") !== -1 ||
            kk.indexOf("clip") !== -1 ||
            kk.indexOf("transform") !== -1 ||
            kk.indexOf("transformation") !== -1 ||
            kk.indexOf("project") !== -1 ||
            kk.indexOf("library") !== -1;

          // Still allow walking plain objects but keep it limited
          if (allow || depth == 0){
            walk(v, fullKey, depth + 1);
          }
        }
      }
    }

    // seed with known direct fields
    addUUID(getObjUUID(obj));

    walk(obj, "", 0);

    // also try clipAsset and asset explicitly if present
    try{ if (obj.clipAsset) walk(obj.clipAsset, "clipAsset", 1); }catch(e3){}
    try{ if (obj.asset) walk(obj.asset, "asset", 1); }catch(e4){}

    return { fields: out, uuids: uuidCandidates };
  }

  function gatherAssetsFromProject(project){
    var assets = [];
    var arrays = [];

    try{ if (Array.isArray(project.assets)) arrays.push(project.assets); }catch(e1){}
    try{ if (Array.isArray(project._assets)) arrays.push(project._assets); }catch(e2){}
    try{ if (project.library && Array.isArray(project.library.assets)) arrays.push(project.library.assets); }catch(e3){}
    try{ if (project.library && Array.isArray(project.library._assets)) arrays.push(project.library._assets); }catch(e4){}

    for (var i = 0; i < arrays.length; i += 1){
      for (var j = 0; j < arrays[i].length; j += 1){
        if (arrays[i][j]) assets.push(arrays[i][j]);
      }
    }

    return assets;
  }

  function assetGetUUID(asset){
    if (!asset) return "";
    try{ if (typeof asset.uuid === "string") return tidy(asset.uuid); }catch(e1){}
    try{ if (typeof asset.id === "string") return tidy(asset.id); }catch(e2){}
    return "";
  }

  function assetGetName(asset){
    if (!asset) return "";
    try{ if (typeof asset.name === "string") return tidy(asset.name); }catch(e1){}
    try{ if (typeof asset.getName === "function") return tidy(asset.getName()); }catch(e2){}
    try{ if (typeof asset.displayName === "string") return tidy(asset.displayName); }catch(e3){}
    try{ if (typeof asset.label === "string") return tidy(asset.label); }catch(e4){}
    return "";
  }

  function buildAssetMap(project){
    var map = {};
    if (!project) return map;

    var assets = gatherAssetsFromProject(project);
    for (var i = 0; i < assets.length; i += 1){
      var a = assets[i];
      var u = assetGetUUID(a);
      if (!u) continue;
      if (!map[u]) map[u] = a;
    }

    // try known maps if present
    try{
      if (project.assetMap && typeof project.assetMap === "object"){
        var keys = Object.keys(project.assetMap);
        for (var j = 0; j < keys.length; j += 1){
          var k = keys[j];
          if (!map[k] && project.assetMap[k]) map[k] = project.assetMap[k];
        }
      }
    }catch(e1){}

    try{
      if (project.library && project.library.assetMap && typeof project.library.assetMap === "object"){
        var keys2 = Object.keys(project.library.assetMap);
        for (var j2 = 0; j2 < keys2.length; j2 += 1){
          var k2 = keys2[j2];
          if (!map[k2] && project.library.assetMap[k2]) map[k2] = project.library.assetMap[k2];
        }
      }
    }catch(e2){}

    return map;
  }

  function refreshSelectionRaw(){
    var bridge = getBridge();
    if (!bridge){
      el("selName").textContent = "(bridge missing)";
      return null;
    }

    try{ if (typeof bridge.captureSelectionNow === "function") bridge.captureSelectionNow(); }catch(e1){}

    var nm = "";
    try{ if (typeof bridge.getSelectedClipName === "function") nm = tidy(bridge.getSelectedClipName()); }catch(e2){}
    el("selName").textContent = nm || "(none)";

    try{
      if (typeof bridge.captureSelectionNow === "function"){
        var sel = bridge.captureSelectionNow();
        if (sel && sel.raw) return sel.raw;
      }
    }catch(e3){}

    return null;
  }

  function inspectChildren(){
    clearLog();

    var rawSel = refreshSelectionRaw();
    if (!rawSel){
      logLine("No selection found");
      return;
    }

    var ed = getEditor();
    var project = getProject(ed);
    var assetMap = buildAssetMap(project);

    var containerAsset = resolveClipAssetFromObject(rawSel);
    if (!containerAsset){
      logLine("Selection is not a clip or clip asset");
      return;
    }

    var tl = getTimelineFromAsset(containerAsset);
    if (!tl){
      logLine("Selected clip has no timeline");
      return;
    }

    var frames = collectFramesFromTimeline(tl);
    if (!frames.length){
      logLine("Selected clip has no frames");
      return;
    }

    var found = [];
    var seen = new Set();

    for (var i = 0; i < frames.length; i += 1){
      var fr = frames[i].frame;
      var objs = getObjectsFromFrame(fr);

      for (var j = 0; j < objs.length; j += 1){
        var o = objs[j];
        if (!o) continue;
        if (!looksLikeClipInstance(o)) continue;
        if (seen.has(o)) continue;
        seen.add(o);
        found.push({ obj: o, layerIndex: frames[i].layerIndex, frameIndex: frames[i].frameIndex });
      }
    }

    if (!found.length){
      logLine("No child clips found on the timeline of the selected clip");
      return;
    }

    logLine("Child clips found " + found.length);
    logLine("");

    for (var k = 0; k < found.length; k += 1){
      var child = found[k].obj;
      var instanceName = getObjName(child);
      var instanceUUID = getObjUUID(child);
      var xy = getXY(child);

      logLine("Index " + (k + 1));
      logLine("Layer index " + found[k].layerIndex);
      logLine("Frame index " + found[k].frameIndex);

      logLine("Instance name " + (instanceName || "(blank)"));
      logLine("Instance uuid " + (instanceUUID || "(blank)"));

      if (xy){
        logLine("X " + xy.x);
        logLine("Y " + xy.y);
        logLine("Position mode " + xy.mode);
      } else {
        logLine("X and Y not found");
      }

      var extracted = extractStringFields(child, 2);

      if (extracted.uuids.length){
        logLine("Uuid candidates " + extracted.uuids.join(", "));
      } else {
        logLine("Uuid candidates none");
      }

      // Resolve possible assets by uuid candidates
      var resolvedAssets = [];
      for (var u = 0; u < extracted.uuids.length; u += 1){
        var uid = extracted.uuids[u];
        var a = assetMap[uid] || null;
        if (!a) continue;
        var nm = assetGetName(a);
        var au = assetGetUUID(a);
        var item = (nm ? nm : "(blank)") + " (" + au + ")";
        if (resolvedAssets.indexOf(item) === -1) resolvedAssets.push(item);
      }

      if (resolvedAssets.length){
        logLine("Resolved assets " + resolvedAssets.join(", "));
      } else {
        logLine("Resolved assets none");
      }

      if (extracted.fields.length){
        logLine("String fields");
        for (var f = 0; f < extracted.fields.length; f += 1){
          var kv = extracted.fields[f];
          if (!kv) continue;
          logLine("  " + kv.key + " = " + kv.value);
        }
      } else {
        logLine("String fields none");
      }

      logLine("");
    }

    logLine("Note");
    logLine("If names are still blank, Wick is not exposing clip names on instances in this part of the API.");
    logLine("In that case use uuid targeting, or store uuids by selecting each part once and saving them in localStorage.");
  }

  el("btnRefresh").addEventListener("click", function(){
    clearLog();
    refreshSelectionRaw();
    logLine("Refreshed");
  });

  el("btnInspect").addEventListener("click", function(){
    inspectChildren();
  });

  refreshSelectionRaw();
})();
</script>
</body>
</html>
