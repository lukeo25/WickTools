<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Arrange Arm Rig</title>
  <style>
    body{
      font-family: Arial, sans serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: #111;
    }
    h1{ font-size: 18px; margin: 0 0 10px 0; }
    .row{ margin: 10px 0; }
    .box{
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 12px;
      background: #fafafa;
    }
    button{
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      margin-right: 8px;
    }
    button:active{ transform: translateY(1px); }
    input{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      width: 180px;
    }
    .label{ font-weight: bold; }
    .muted{ color: #444; font-size: 13px; }
    pre{
      font-family: Consolas, Menlo, Monaco, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }
    .grid{
      display: grid;
      grid-template-columns: 150px 1fr;
      gap: 10px;
      align-items: center;
    }
  </style>
</head>
<body>
  <h1>Arrange Arm Rig inside Selected Clip</h1>

  <div class="row box">
    <div class="row"><span class="label">Selected clip</span>: <span id="selName">(none)</span></div>
    <div class="row muted">
      Select the container clip instance (for example Arm_R) then press Arrange.
      This will:
      1) Find children named Shoulder_R and Elbow_R inside the selected clip.
      2) Move the CONTENTS inside those clips so their top center is at 0,0.
      3) Place Shoulder_R at 0,0 and Elbow_R at 0, shoulderHeight (optionally minus overlap).
      Then the arm rotates around the crosshair at 0,0 (shoulder joint).
    </div>

    <div class="row grid">
      <div class="label">Shoulder name</div>
      <div><input id="shoulderName" value="Shoulder_R"></div>

      <div class="label">Elbow name</div>
      <div><input id="elbowName" value="Elbow_R"></div>

      <div class="label">Overlap px</div>
      <div><input id="overlap" value="0"></div>
    </div>

    <div class="row">
      <button id="btnRefresh" type="button">Refresh selection</button>
      <button id="btnArrange" type="button">Arrange</button>
    </div>
  </div>

  <div class="row box">
    <div class="row"><span class="label">Log</span></div>
    <pre id="log"></pre>
  </div>

<script>
(function () {
  "use strict";

  function el(id){ return document.getElementById(id); }
  var logEl = el("log");

  function clearLog(){ logEl.textContent = ""; }
  function logLine(msg){ logEl.textContent += String(msg === undefined ? "" : msg) + "\n"; }

  function s(v){
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function tidy(v){
    return s(v).replace(/\s+/g, " ").trim();
  }

  function isNum(n){
    return typeof n === "number" && isFinite(n);
  }

  function toNum(v, fallback){
    var n = Number(v);
    if (!isFinite(n)) return fallback;
    return n;
  }

  function getBridge(){
    try{ if (window.LukeToolsBridge) return window.LukeToolsBridge; }catch(e1){}
    try{ if (window.parent && window.parent.LukeToolsBridge) return window.parent.LukeToolsBridge; }catch(e2){}
    return null;
  }

  function getEditor(){
    try { if (window.wickEditor) return window.wickEditor; } catch (e1) {}
    try { if (window.WickEditor && window.WickEditor.editor) return window.WickEditor.editor; } catch (e2) {}
    try { if (window.editor) return window.editor; } catch (e3) {}
    try { if (window.app) return window.app; } catch (e4) {}
    return null;
  }

  function markDirty(ed){
    try{ if (ed && ed.project && typeof ed.project.markAsModified === "function") ed.project.markAsModified(); }catch(e1){}
    try{ if (ed && ed.project) ed.project.unsavedChanges = true; }catch(e2){}
    try{ if (ed && typeof ed.requestRender === "function") ed.requestRender(); }catch(e3){}
    try{ if (ed && ed.renderer && typeof ed.renderer.requestRender === "function") ed.renderer.requestRender(); }catch(e4){}
  }

  function getObjName(obj){
    if (!obj) return "";
    try{
      if (typeof obj.name === "string") return tidy(obj.name);
      if (typeof obj.getName === "function") return tidy(obj.getName());
    }catch(e1){}
    return "";
  }

  function refreshSelection(){
    var bridge = getBridge();
    if (!bridge){
      el("selName").textContent = "(bridge missing)";
      return null;
    }

    try{ if (typeof bridge.captureSelectionNow === "function") bridge.captureSelectionNow(); }catch(e1){}

    var name = "";
    try{ if (typeof bridge.getSelectedClipName === "function") name = tidy(bridge.getSelectedClipName()); }catch(e2){}
    el("selName").textContent = name || "(none)";

    try{
      if (typeof bridge.captureSelectionNow === "function"){
        var sel = bridge.captureSelectionNow();
        if (sel && sel.raw) return sel.raw;
      }
    }catch(e3){}

    return null;
  }

  function getXY(obj){
    if (!obj) return null;

    if (isNum(obj.x) && isNum(obj.y)) return { x: obj.x, y: obj.y, mode: "xy" };

    if (obj.transformation && isNum(obj.transformation.x) && isNum(obj.transformation.y)) {
      return { x: obj.transformation.x, y: obj.transformation.y, mode: "transformation" };
    }

    if (obj.transform && isNum(obj.transform.x) && isNum(obj.transform.y)) {
      return { x: obj.transform.x, y: obj.transform.y, mode: "transform" };
    }

    return null;
  }

  function setXY(obj, x, y, mode){
    if (!obj) return false;
    if (!isNum(x) || !isNum(y)) return false;

    if (mode === "xy"){
      obj.x = x;
      obj.y = y;
      return true;
    }

    if (mode === "transformation"){
      if (!obj.transformation) obj.transformation = {};
      obj.transformation.x = x;
      obj.transformation.y = y;
      return true;
    }

    if (mode === "transform"){
      if (!obj.transform) obj.transform = {};
      obj.transform.x = x;
      obj.transform.y = y;
      return true;
    }

    return false;
  }

  function normalizeBounds(b){
    if (!b) return null;

    if (isNum(b.x) && isNum(b.y) && isNum(b.width) && isNum(b.height)){
      return { minX: b.x, minY: b.y, maxX: b.x + b.width, maxY: b.y + b.height };
    }

    if (isNum(b.minX) && isNum(b.minY) && isNum(b.maxX) && isNum(b.maxY)){
      return { minX: b.minX, minY: b.minY, maxX: b.maxX, maxY: b.maxY };
    }

    if (isNum(b.left) && isNum(b.top) && isNum(b.right) && isNum(b.bottom)){
      return { minX: b.left, minY: b.top, maxX: b.right, maxY: b.bottom };
    }

    if (Array.isArray(b) && b.length >= 4 && isNum(b[0]) && isNum(b[1]) && isNum(b[2]) && isNum(b[3])){
      return { minX: b[0], minY: b[1], maxX: b[2], maxY: b[3] };
    }

    return null;
  }

  function getObjectBounds(obj){
    if (!obj) return null;

    try{
      if (typeof obj.getBounds === "function"){
        var b1 = normalizeBounds(obj.getBounds());
        if (b1) return b1;
      }
    }catch(e1){}

    try{
      if (typeof obj.getBoundingBox === "function"){
        var b2 = normalizeBounds(obj.getBoundingBox());
        if (b2) return b2;
      }
    }catch(e2){}

    try{
      var b3 = normalizeBounds(obj.bounds);
      if (b3) return b3;
    }catch(e3){}

    try{
      var b4 = normalizeBounds(obj._bounds);
      if (b4) return b4;
    }catch(e4){}

    var xy = getXY(obj);
    if (xy){
      return { minX: xy.x, minY: xy.y, maxX: xy.x, maxY: xy.y };
    }

    return null;
  }

  function getTimelineFromAsset(asset){
    if (!asset) return null;
    try{ if (asset.timeline) return asset.timeline; }catch(e1){}
    try{ if (asset._timeline) return asset._timeline; }catch(e2){}
    return null;
  }

  function getLayersFromTimeline(tl){
    if (!tl) return [];
    try{ if (Array.isArray(tl.layers)) return tl.layers; }catch(e1){}
    try{ if (Array.isArray(tl._layers)) return tl._layers; }catch(e2){}
    return [];
  }

  function getFramesFromLayer(layer){
    if (!layer) return [];
    try{ if (Array.isArray(layer.frames)) return layer.frames; }catch(e1){}
    try{ if (Array.isArray(layer._frames)) return layer._frames; }catch(e2){}
    return [];
  }

  function getObjectsFromFrame(fr){
    if (!fr) return [];
    try{ if (Array.isArray(fr.wickObjects)) return fr.wickObjects; }catch(e1){}
    try{ if (Array.isArray(fr.objects)) return fr.objects; }catch(e2){}
    try{ if (Array.isArray(fr.children)) return fr.children; }catch(e3){}
    try{ if (Array.isArray(fr._children)) return fr._children; }catch(e4){}
    return [];
  }

  function collectFramesFromTimeline(tl){
    var frames = [];
    var layers = getLayersFromTimeline(tl);
    for (var i = 0; i < layers.length; i += 1){
      var frs = getFramesFromLayer(layers[i]);
      for (var j = 0; j < frs.length; j += 1){
        if (frs[j]) frames.push(frs[j]);
      }
    }
    return frames;
  }

  function resolveClipAssetFromSelection(selObj){
    if (!selObj) return null;

    try{ if (selObj.clipAsset) return selObj.clipAsset; }catch(e1){}

    if (getTimelineFromAsset(selObj)) return selObj;

    try{
      if (selObj.asset && getTimelineFromAsset(selObj.asset)) return selObj.asset;
    }catch(e2){}

    return null;
  }

  function collectPlacedObjectsFromFrames(frames){
    var out = [];
    var seen = new Set();

    for (var i = 0; i < frames.length; i += 1){
      var fr = frames[i];
      if (!fr) continue;

      var objs = getObjectsFromFrame(fr);
      if (!objs || !objs.length) continue;

      for (var k = 0; k < objs.length; k += 1){
        var o = objs[k];
        if (!o) continue;

        var xy = getXY(o);
        if (!xy) continue;

        if (!seen.has(o)){
          seen.add(o);
          out.push({ obj: o, mode: xy.mode });
        }
      }
    }

    return out;
  }

  function computeBounds(placed){
    var minX = Infinity;
    var minY = Infinity;
    var maxX = -Infinity;
    var maxY = -Infinity;

    for (var i = 0; i < placed.length; i += 1){
      var b = getObjectBounds(placed[i].obj);
      if (!b) continue;
      if (b.minX < minX) minX = b.minX;
      if (b.minY < minY) minY = b.minY;
      if (b.maxX > maxX) maxX = b.maxX;
      if (b.maxY > maxY) maxY = b.maxY;
    }

    if (!isFinite(minX) || !isFinite(minY) || !isFinite(maxX) || !isFinite(maxY)) return null;
    return { minX: minX, minY: minY, maxX: maxX, maxY: maxY };
  }

  function moveContentsOfClipAssetToTopCenter(asset){
    var tl = getTimelineFromAsset(asset);
    if (!tl) return { ok: false, reason: "no timeline" };

    var frames = collectFramesFromTimeline(tl);
    if (!frames.length) return { ok: false, reason: "no frames" };

    var placed = collectPlacedObjectsFromFrames(frames);
    if (!placed.length) return { ok: false, reason: "no objects" };

    var bounds = computeBounds(placed);
    if (!bounds) return { ok: false, reason: "no bounds" };

    var anchorX = (bounds.minX + bounds.maxX) / 2;
    var anchorY = bounds.minY;
    var dx = -anchorX;
    var dy = -anchorY;

    var moved = 0;
    for (var i = 0; i < placed.length; i += 1){
      var o = placed[i].obj;
      var xy = getXY(o);
      if (!xy) continue;
      if (setXY(o, xy.x + dx, xy.y + dy, xy.mode)) moved += 1;
    }

    return {
      ok: true,
      moved: moved,
      before: bounds,
      dx: dx,
      dy: dy
    };
  }

  function computeClipAssetBounds(asset){
    var tl = getTimelineFromAsset(asset);
    if (!tl) return null;
    var frames = collectFramesFromTimeline(tl);
    if (!frames.length) return null;
    var placed = collectPlacedObjectsFromFrames(frames);
    if (!placed.length) return null;
    return computeBounds(placed);
  }

  function findNamedInstancesInClipAsset(containerAsset, targetName){
    var tl = getTimelineFromAsset(containerAsset);
    if (!tl) return [];
    var frames = collectFramesFromTimeline(tl);
    var matches = [];
    var seen = new Set();

    for (var i = 0; i < frames.length; i += 1){
      var objs = getObjectsFromFrame(frames[i]);
      for (var k = 0; k < objs.length; k += 1){
        var o = objs[k];
        if (!o) continue;

        var n = getObjName(o);
        if (!n) continue;

        if (n === targetName){
          if (!seen.has(o)){
            seen.add(o);
            matches.push(o);
          }
        }
      }
    }

    return matches;
  }

  function setInstancesPosition(containerAsset, targetName, x, y){
    var tl = getTimelineFromAsset(containerAsset);
    if (!tl) return { ok: false, reason: "no timeline" };
    var frames = collectFramesFromTimeline(tl);
    if (!frames.length) return { ok: false, reason: "no frames" };

    var changed = 0;

    for (var i = 0; i < frames.length; i += 1){
      var objs = getObjectsFromFrame(frames[i]);
      for (var k = 0; k < objs.length; k += 1){
        var o = objs[k];
        if (!o) continue;
        if (getObjName(o) !== targetName) continue;

        var xy = getXY(o);
        if (!xy) continue;

        if (setXY(o, x, y, xy.mode)) changed += 1;
      }
    }

    return { ok: true, changed: changed };
  }

  function arrange(){
    clearLog();

    var raw = refreshSelection();
    if (!raw){
      logLine("No selection found. Select the container clip instance (Arm_R) and try again.");
      return;
    }

    var containerAsset = resolveClipAssetFromSelection(raw);
    if (!containerAsset){
      logLine("Selection does not look like a clip instance. (No clipAsset / timeline)");
      return;
    }

    var shoulderName = tidy(el("shoulderName").value);
    var elbowName = tidy(el("elbowName").value);
    var overlap = toNum(el("overlap").value, 0);

    if (!shoulderName || !elbowName){
      logLine("Please enter both Shoulder and Elbow names.");
      return;
    }

    logLine("Shoulder: " + shoulderName);
    logLine("Elbow: " + elbowName);
    logLine("Overlap: " + overlap);

    var shoulderInstances = findNamedInstancesInClipAsset(containerAsset, shoulderName);
    var elbowInstances = findNamedInstancesInClipAsset(containerAsset, elbowName);

    if (!shoulderInstances.length){
      logLine("Could not find any instance named " + shoulderName + " inside the selected clip.");
      return;
    }
    if (!elbowInstances.length){
      logLine("Could not find any instance named " + elbowName + " inside the selected clip.");
      return;
    }

    var shoulderAsset = resolveClipAssetFromSelection(shoulderInstances[0]) || shoulderInstances[0].clipAsset || null;
    var elbowAsset = resolveClipAssetFromSelection(elbowInstances[0]) || elbowInstances[0].clipAsset || null;

    if (!shoulderAsset){
      logLine("Shoulder instance found but could not resolve its clip asset.");
      return;
    }
    if (!elbowAsset){
      logLine("Elbow instance found but could not resolve its clip asset.");
      return;
    }

    logLine("Shifting Shoulder contents to top center...");
    var shMove = moveContentsOfClipAssetToTopCenter(shoulderAsset);
    if (!shMove.ok){
      logLine("Shoulder shift failed: " + shMove.reason);
      return;
    }
    logLine("Shoulder objects moved: " + shMove.moved);

    logLine("Shifting Elbow contents to top center...");
    var elMove = moveContentsOfClipAssetToTopCenter(elbowAsset);
    if (!elMove.ok){
      logLine("Elbow shift failed: " + elMove.reason);
      return;
    }
    logLine("Elbow objects moved: " + elMove.moved);

    var shBounds = computeClipAssetBounds(shoulderAsset);
    if (!shBounds){
      logLine("Could not compute shoulder bounds after shift.");
      return;
    }

    var shoulderHeight = shBounds.maxY - shBounds.minY;
    if (!isFinite(shoulderHeight)) shoulderHeight = 0;

    logLine("Shoulder height: " + shoulderHeight);

    var elbowY = shoulderHeight - overlap;

    logLine("Placing Shoulder at 0,0");
    var shSet = setInstancesPosition(containerAsset, shoulderName, 0, 0);
    logLine("Shoulder instances updated: " + (shSet.ok ? shSet.changed : 0));

    logLine("Placing Elbow at 0," + elbowY);
    var elSet = setInstancesPosition(containerAsset, elbowName, 0, elbowY);
    logLine("Elbow instances updated: " + (elSet.ok ? elSet.changed : 0));

    markDirty(getEditor());
    logLine("Done. Exit the clip and rotate the Arm_R instance to test the new pivot positions.");
  }

  el("btnRefresh").addEventListener("click", function(){
    clearLog();
    refreshSelection();
    logLine("Refreshed");
  });

  el("btnArrange").addEventListener("click", function(){
    arrange();
  });

  refreshSelection();
})();
</script>

</body>
</html>
