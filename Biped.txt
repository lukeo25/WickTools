<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Arm rig arrange v4</title>
  <style>
    body{
      font-family: Arial, sans serif;
      margin: 0;
      padding: 16px;
      background: #ffffff;
      color: #111;
    }
    h1{
      font-size: 18px;
      margin: 0 0 12px 0;
    }
    .box{
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      background: #fafafa;
      margin-bottom: 12px;
    }
    .row{ margin: 8px 0; }
    .label{ font-weight: 700; }
    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
      margin-right: 8px;
    }
    button:active{ transform: translateY(1px); }
    pre{
      font-family: Consolas, Menlo, Monaco, monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 0;
    }
    input{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      width: 240px;
      max-width: 100%;
    }
    .muted{ color: #444; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Arrange Shoulder and Elbow inside selected clip</h1>

  <div class="box">
    <div class="row"><span class="label">Selected clip</span>: <span id="selName">(none)</span></div>

    <div class="row muted">
      This targets child clip instances by identifier.
      It uses _identifier or _cachedSerializeData.identifier.
      It does not guess or search beyond those names.
    </div>

    <div class="row">
      <span class="label">Shoulder identifier</span>
      <div class="row">
        <input id="shoulderId" value="Shoulder_R">
      </div>
    </div>

    <div class="row">
      <span class="label">Elbow identifier</span>
      <div class="row">
        <input id="elbowId" value="Elbo_R">
      </div>
    </div>

    <div class="row">
      <span class="label">Extra gap</span>
      <div class="row">
        <input id="gap" value="0">
      </div>
    </div>

    <div class="row">
      <button id="btnRefresh" type="button">Refresh selection</button>
      <button id="btnArrange" type="button">Arrange</button>
    </div>
  </div>

  <div class="box">
    <div class="row"><span class="label">Log</span></div>
    <pre id="log"></pre>
  </div>

<script>
(function () {
  "use strict";

  function el(id){ return document.getElementById(id); }
  var logEl = el("log");

  function clearLog(){ logEl.textContent = ""; }
  function logLine(t){ logEl.textContent += String(t === undefined ? "" : t) + "\n"; }

  function s(v){
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function tidy(v){
    return s(v).replace(/\s+/g, " ").trim();
  }

  function num(v, fallback){
    var n = Number(v);
    if (!isFinite(n)) return fallback;
    return n;
  }

  function isFiniteNumber(v){
    return typeof v === "number" && isFinite(v);
  }

  function getBridge(){
    try{ if (window.LukeToolsBridge) return window.LukeToolsBridge; }catch(e1){}
    try{ if (window.parent && window.parent.LukeToolsBridge) return window.parent.LukeToolsBridge; }catch(e2){}
    return null;
  }

  function getEditor(){
    try { if (window.wickEditor) return window.wickEditor; } catch (e1) {}
    try { if (window.WickEditor && window.WickEditor.editor) return window.WickEditor.editor; } catch (e2) {}
    try { if (window.editor) return window.editor; } catch (e3) {}
    try { if (window.app) return window.app; } catch (e4) {}

    try { if (window.parent && window.parent.wickEditor) return window.parent.wickEditor; } catch (e5) {}
    try { if (window.parent && window.parent.WickEditor && window.parent.WickEditor.editor) return window.parent.WickEditor.editor; } catch (e6) {}
    try { if (window.parent && window.parent.editor) return window.parent.editor; } catch (e7) {}
    try { if (window.parent && window.parent.app) return window.parent.app; } catch (e8) {}

    return null;
  }

  function markDirty(ed){
    try{
      if (ed && ed.project && typeof ed.project.markAsModified === "function"){
        ed.project.markAsModified();
      }
    }catch(e1){}
    try{
      if (ed && ed.project){
        ed.project.unsavedChanges = true;
      }
    }catch(e2){}
  }

  function getIdentifier(obj){
    if (!obj) return "";
    try{ if (typeof obj._identifier === "string") return tidy(obj._identifier); }catch(e1){}
    try{
      if (obj._cachedSerializeData && typeof obj._cachedSerializeData.identifier === "string"){
        return tidy(obj._cachedSerializeData.identifier);
      }
    }catch(e2){}
    try{ if (typeof obj.identifier === "string") return tidy(obj.identifier); }catch(e3){}
    try{ if (typeof obj.name === "string") return tidy(obj.name); }catch(e4){}
    return "";
  }

  function getUUID(obj){
    if (!obj) return "";
    try{ if (typeof obj._uuid === "string") return tidy(obj._uuid); }catch(e1){}
    try{ if (typeof obj.uuid === "string") return tidy(obj.uuid); }catch(e2){}
    try{ if (typeof obj.UUID === "string") return tidy(obj.UUID); }catch(e3){}
    try{ if (typeof obj.id === "string") return tidy(obj.id); }catch(e4){}
    try{
      if (obj._cachedSerializeData && typeof obj._cachedSerializeData.uuid === "string"){
        return tidy(obj._cachedSerializeData.uuid);
      }
    }catch(e5){}
    return "";
  }

  function getXY(obj){
    if (!obj) return null;

    try{
      if (isFiniteNumber(obj.x) && isFiniteNumber(obj.y)) return { x: obj.x, y: obj.y, mode: "xy" };
    }catch(e1){}

    try{
      if (obj.transformation && isFiniteNumber(obj.transformation.x) && isFiniteNumber(obj.transformation.y)){
        return { x: obj.transformation.x, y: obj.transformation.y, mode: "transformation" };
      }
    }catch(e2){}

    try{
      if (obj.transform && isFiniteNumber(obj.transform.x) && isFiniteNumber(obj.transform.y)){
        return { x: obj.transform.x, y: obj.transform.y, mode: "transform" };
      }
    }catch(e3){}

    return null;
  }

  function setXY(obj, x, y){
    if (!obj) return false;

    try{
      if (isFiniteNumber(obj.x) && isFiniteNumber(obj.y)){
        obj.x = x;
        obj.y = y;
        return true;
      }
    }catch(e1){}

    try{
      if (obj.transformation && isFiniteNumber(obj.transformation.x) && isFiniteNumber(obj.transformation.y)){
        obj.transformation.x = x;
        obj.transformation.y = y;
        return true;
      }
    }catch(e2){}

    try{
      if (obj.transform && isFiniteNumber(obj.transform.x) && isFiniteNumber(obj.transform.y)){
        obj.transform.x = x;
        obj.transform.y = y;
        return true;
      }
    }catch(e3){}

    return false;
  }

  function getTimelineFromClipLike(obj){
    if (!obj) return null;
    try{ if (obj.timeline) return obj.timeline; }catch(e1){}
    try{ if (obj._timeline) return obj._timeline; }catch(e2){}
    try{ if (obj.clipAsset && obj.clipAsset.timeline) return obj.clipAsset.timeline; }catch(e3){}
    try{ if (obj.clipAsset && obj.clipAsset._timeline) return obj.clipAsset._timeline; }catch(e4){}
    try{ if (obj.asset && obj.asset.timeline) return obj.asset.timeline; }catch(e5){}
    try{ if (obj.asset && obj.asset._timeline) return obj.asset._timeline; }catch(e6){}
    return null;
  }

  function getLayersFromTimeline(tl){
    if (!tl) return [];
    try{ if (Array.isArray(tl.layers)) return tl.layers; }catch(e1){}
    try{ if (Array.isArray(tl._layers)) return tl._layers; }catch(e2){}
    return [];
  }

  function getFramesFromLayer(layer){
    if (!layer) return [];
    try{ if (Array.isArray(layer.frames)) return layer.frames; }catch(e1){}
    try{ if (Array.isArray(layer._frames)) return layer._frames; }catch(e2){}
    try{ if (Array.isArray(layer.frame)) return layer.frame; }catch(e3){}
    return [];
  }

  function getObjectsFromFrame(fr){
    if (!fr) return [];
    try{ if (Array.isArray(fr.wickObjects)) return fr.wickObjects; }catch(e1){}
    try{ if (Array.isArray(fr.objects)) return fr.objects; }catch(e2){}
    try{ if (Array.isArray(fr.children)) return fr.children; }catch(e3){}
    try{ if (Array.isArray(fr._children)) return fr._children; }catch(e4){}
    return [];
  }

  function collectChildClipsFromTimeline(tl){
    var layers = getLayersFromTimeline(tl);
    var out = [];
    var seen = new Set();

    for (var i = 0; i < layers.length; i += 1){
      var frames = getFramesFromLayer(layers[i]);
      for (var j = 0; j < frames.length; j += 1){
        var objs = getObjectsFromFrame(frames[j]);
        for (var k = 0; k < objs.length; k += 1){
          var o = objs[k];
          if (!o) continue;

          // Clip instances show up with _classname Clip in your inspector
          var isClip = false;
          try{ if (o._classname === "Clip") isClip = true; }catch(e1){}
          try{ if (!isClip && o._cachedSerializeData && o._cachedSerializeData.classname === "Clip") isClip = true; }catch(e2){}

          if (!isClip) continue;
          if (seen.has(o)) continue;
          seen.add(o);
          out.push(o);
        }
      }
    }

    return out;
  }

  function findChildByIdentifier(containerClip, wantedIdentifier){
    wantedIdentifier = tidy(wantedIdentifier);
    if (!wantedIdentifier) return null;

    var tl = getTimelineFromClipLike(containerClip);
    if (!tl) return null;

    var children = collectChildClipsFromTimeline(tl);

    for (var i = 0; i < children.length; i += 1){
      var id = getIdentifier(children[i]);
      if (id === wantedIdentifier) return children[i];
    }

    return null;
  }

  function getObjectBounds(obj){
    if (!obj) return null;

    // native bounds
    try{
      if (typeof obj.getBounds === "function"){
        var b1 = obj.getBounds();
        if (b1 && isFiniteNumber(b1.x) && isFiniteNumber(b1.y) && isFiniteNumber(b1.width) && isFiniteNumber(b1.height)){
          return { minX: b1.x, minY: b1.y, maxX: b1.x + b1.width, maxY: b1.y + b1.height };
        }
        if (b1 && isFiniteNumber(b1.left) && isFiniteNumber(b1.top) && isFiniteNumber(b1.right) && isFiniteNumber(b1.bottom)){
          return { minX: b1.left, minY: b1.top, maxX: b1.right, maxY: b1.bottom };
        }
      }
    }catch(e1){}

    // bounds field
    try{
      var b2 = obj.bounds || obj._bounds || null;
      if (b2){
        if (isFiniteNumber(b2.x) && isFiniteNumber(b2.y) && isFiniteNumber(b2.width) && isFiniteNumber(b2.height)){
          return { minX: b2.x, minY: b2.y, maxX: b2.x + b2.width, maxY: b2.y + b2.height };
        }
        if (isFiniteNumber(b2.left) && isFiniteNumber(b2.top) && isFiniteNumber(b2.right) && isFiniteNumber(b2.bottom)){
          return { minX: b2.left, minY: b2.top, maxX: b2.right, maxY: b2.bottom };
        }
      }
    }catch(e2){}

    // width height with center position
    var x = null;
    var y = null;
    var w = null;
    var h = null;

    try{ if (isFiniteNumber(obj.x)) x = obj.x; }catch(e3){}
    try{ if (isFiniteNumber(obj.y)) y = obj.y; }catch(e4){}

    try{ if (isFiniteNumber(obj.width)) w = obj.width; }catch(e5){}
    try{ if (isFiniteNumber(obj.height)) h = obj.height; }catch(e6){}
    try{ if (!w && isFiniteNumber(obj._width)) w = obj._width; }catch(e7){}
    try{ if (!h && isFiniteNumber(obj._height)) h = obj._height; }catch(e8){}

    // cached serialize size
    try{
      if (obj._cachedSerializeData){
        if (!w && isFiniteNumber(obj._cachedSerializeData.width)) w = obj._cachedSerializeData.width;
        if (!h && isFiniteNumber(obj._cachedSerializeData.height)) h = obj._cachedSerializeData.height;
      }
    }catch(e9){}

    if (x !== null && y !== null && w !== null && h !== null){
      return { minX: x - w / 2, minY: y - h / 2, maxX: x + w / 2, maxY: y + h / 2 };
    }

    return null;
  }

  function unionBounds(a, b){
    if (!a) return b;
    if (!b) return a;
    return {
      minX: Math.min(a.minX, b.minX),
      minY: Math.min(a.minY, b.minY),
      maxX: Math.max(a.maxX, b.maxX),
      maxY: Math.max(a.maxY, b.maxY)
    };
  }

  function computeContentBounds(clip){
    // bounds of objects inside this clip across all frames
    var tl = getTimelineFromClipLike(clip);
    if (!tl) return null;

    var layers = getLayersFromTimeline(tl);
    var bounds = null;

    for (var i = 0; i < layers.length; i += 1){
      var frames = getFramesFromLayer(layers[i]);
      for (var j = 0; j < frames.length; j += 1){
        var objs = getObjectsFromFrame(frames[j]);
        for (var k = 0; k < objs.length; k += 1){
          var o = objs[k];
          if (!o) continue;
          var b = getObjectBounds(o);
          if (!b) continue;
          bounds = unionBounds(bounds, b);
        }
      }
    }

    return bounds;
  }

  function shiftClipContents(clip, dx, dy){
    // shifts all objects inside clip across all frames by dx dy
    var tl = getTimelineFromClipLike(clip);
    if (!tl) return false;

    var moved = 0;

    var layers = getLayersFromTimeline(tl);
    for (var i = 0; i < layers.length; i += 1){
      var frames = getFramesFromLayer(layers[i]);
      for (var j = 0; j < frames.length; j += 1){
        var objs = getObjectsFromFrame(frames[j]);
        for (var k = 0; k < objs.length; k += 1){
          var o = objs[k];
          if (!o) continue;

          var pos = getXY(o);
          if (pos){
            setXY(o, pos.x + dx, pos.y + dy);
            moved += 1;
          }
        }
      }
    }

    return moved > 0;
  }

  function setTopCenterAsOrigin(clip){
    // move internal contents so that top center becomes 0 0 in the clip local space
    var b = computeContentBounds(clip);
    if (!b) return { ok: false, reason: "content bounds not found" };

    var centerX = (b.minX + b.maxX) / 2;
    var topY = b.minY;

    var dx = -centerX;
    var dy = -topY;

    var did = shiftClipContents(clip, dx, dy);
    if (!did) return { ok: false, reason: "no movable objects found in clip" };

    // recompute after shift
    var b2 = computeContentBounds(clip);

    return { ok: true, dx: dx, dy: dy, boundsBefore: b, boundsAfter: b2 };
  }

  function getSelectedRaw(){
    var bridge = getBridge();
    if (!bridge) return null;

    try{ if (typeof bridge.captureSelectionNow === "function") bridge.captureSelectionNow(); }catch(e1){}

    try{
      if (typeof bridge.captureSelectionNow === "function"){
        var sel = bridge.captureSelectionNow();
        if (sel && sel.raw) return sel.raw;
      }
    }catch(e2){}

    return null;
  }

  function refreshSelectionUI(){
    var bridge = getBridge();
    var nm = "";
    try{ if (bridge && typeof bridge.getSelectedClipName === "function") nm = tidy(bridge.getSelectedClipName()); }catch(e1){}
    el("selName").textContent = nm || "(none)";
  }

  function arrange(){
    clearLog();

    var shoulderId = tidy(el("shoulderId").value);
    var elbowId = tidy(el("elbowId").value);
    var gap = num(el("gap").value, 0);

    if (!shoulderId || !elbowId){
      logLine("Missing identifiers");
      return;
    }

    var container = getSelectedRaw();
    if (!container){
      logLine("No selected clip object");
      return;
    }

    var ed = getEditor();

    // In your inspector the selected clip object has _classname Clip.
    // We will use its own timeline.
    var containerIdentifier = getIdentifier(container);
    logLine("Selected identifier " + (containerIdentifier || "(blank)"));
    logLine("Selected uuid " + (getUUID(container) || "(blank)"));

    var shoulder = findChildByIdentifier(container, shoulderId);
    var elbow = findChildByIdentifier(container, elbowId);

    if (!shoulder){
      logLine("Shoulder not found: " + shoulderId);
      return;
    }
    if (!elbow){
      logLine("Elbow not found: " + elbowId);
      return;
    }

    logLine("Found shoulder uuid " + getUUID(shoulder));
    logLine("Found elbow uuid " + getUUID(elbow));
    logLine("");

    // Move contents inside each so origin is at top center
    var shRes = setTopCenterAsOrigin(shoulder);
    if (!shRes.ok){
      logLine("Shoulder origin shift failed: " + shRes.reason);
      return;
    }

    var elRes = setTopCenterAsOrigin(elbow);
    if (!elRes.ok){
      logLine("Elbow origin shift failed: " + elRes.reason);
      return;
    }

    logLine("Shifted shoulder contents dx " + shRes.dx + " dy " + shRes.dy);
    logLine("Shifted elbow contents dx " + elRes.dx + " dy " + elRes.dy);
    logLine("");

    // Determine shoulder height to stack elbow under it
    var shBoundsAfter = shRes.boundsAfter;
    if (!shBoundsAfter){
      logLine("Cannot compute shoulder bounds after shift");
      return;
    }

    var shoulderHeight = shBoundsAfter.maxY - shBoundsAfter.minY;
    if (!isFiniteNumber(shoulderHeight) || shoulderHeight <= 0){
      logLine("Shoulder height invalid");
      return;
    }

    var shPos = getXY(shoulder);
    var elPos = getXY(elbow);

    if (!shPos || !elPos){
      logLine("Cannot read shoulder or elbow position");
      return;
    }

    // Align x and stack y
    var newElbowX = shPos.x;
    var newElbowY = shPos.y + shoulderHeight + gap;

    var did1 = setXY(elbow, newElbowX, newElbowY);

    if (!did1){
      logLine("Failed to set elbow position");
      return;
    }

    // Optional align shoulder x to nearest integer to avoid tiny drift
    setXY(shoulder, shPos.x, shPos.y);

    markDirty(ed);

    logLine("Done");
    logLine("Shoulder at x " + shPos.x + " y " + shPos.y);
    logLine("Elbow at x " + newElbowX + " y " + newElbowY);
    logLine("Used shoulder height " + shoulderHeight);
  }

  el("btnRefresh").addEventListener("click", function(){
    clearLog();
    refreshSelectionUI();
    logLine("Refreshed");
  });

  el("btnArrange").addEventListener("click", function(){
    refreshSelectionUI();
    arrange();
  });

  refreshSelectionUI();
})();
</script>
</body>
</html>
