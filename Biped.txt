<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LukeTools Biped Arm Rig Tool</title>
  <style>
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #111;
      color: #eee;
    }
    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
    }
    .card {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .row > * { flex: 0 0 auto; }
    .grow { flex: 1 1 auto; min-width: 220px; }
    .label { font-size: 12px; opacity: 0.9; }
    .value { font-weight: 700; }
    input[type="text"]{
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: #fff;
      outline: none;
      font-size: 13px;
    }
    input[type="range"]{ width: 260px; }
    button {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: rgba(0,0,0,0.75);
      border-color: rgba(0,0,0,0.75);
    }
    button:active { transform: translateY(1px); }
    .muted { opacity: 0.75; }
    .log {
      white-space: pre-wrap;
      font-family: Consolas, Menlo, monospace;
      font-size: 12px;
      line-height: 1.3;
      background: rgba(0,0,0,0.35);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 12px;
      min-height: 140px;
      max-height: 46vh;
      overflow: auto;
    }
    .pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="grow">
          <div class="label">Selected clip</div>
          <div class="value" id="selName">(not loaded)</div>
          <div class="muted" style="font-size:12px;margin-top:4px;">This tool calls LukeToolsBridge in the Wick Editor page. If LukeToolsBridge is missing, the userscript is not running.</div>
        </div>
        <div>
          <button id="btnRefresh">Refresh selection</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div class="grow">
          <div class="label">Shoulder identifier inside selected clip</div>
          <input id="shoulderId" type="text" value="Shoulder_R">
        </div>
        <div class="grow">
          <div class="label">Elbow identifier inside selected clip</div>
          <input id="elbowId" type="text" value="Elbo_R">
        </div>
        <div>
          <button class="primary" id="btnArrange">Arrange in editor</button>
        </div>
      </div>
      <div class="muted" style="font-size:12px;margin-top:10px;">
        Arrange in editor changes the selected clip timeline data (not preview only). It moves Shoulder_R and Elbo_R into an arm stack and shifts their internal contents so their pivot is at the top.
      </div>
    </div>

    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div class="grow">
          <div class="label">Shoulder rotation</div>
          <div class="row">
            <input id="shSlider" type="range" min="-180" max="180" step="1" value="0">
            <span class="pill"><span id="shVal">0</span> deg</span>
          </div>
        </div>

        <div class="grow">
          <div class="label">Elbow rotation</div>
          <div class="row">
            <input id="elSlider" type="range" min="-180" max="180" step="1" value="0">
            <span class="pill"><span id="elVal">0</span> deg</span>
          </div>
        </div>

        <div>
          <button class="primary" id="btnInjectUpdate">Inject update script</button>
        </div>
      </div>

      <div class="muted" style="font-size:12px;margin-top:10px;">
        Inject update script writes an update script to the selected clip that reads these slider values from localStorage and rotates Shoulder_R and Elbo_R every frame.
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="label">Log</div>
        <div>
          <button id="btnClear">Clear</button>
        </div>
      </div>
      <div id="log" class="log"></div>
    </div>
  </div>

<script>
(function () {
  "use strict";

  var KEY_RIG_SHOULDER = "LukeToolsRigShoulderDeg";
  var KEY_RIG_ELBOW = "LukeToolsRigElbowDeg";

  function $(id) { return document.getElementById(id); }

  var logEl = $("log");

  function log() {
    var parts = [];
    for (var i = 0; i < arguments.length; i += 1) parts.push(String(arguments[i]));
    var line = parts.join(" ");
    logEl.textContent += line + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  }

  function getBridge() {
    try {
      if (window.LukeToolsBridge) return window.LukeToolsBridge;
    } catch (e1) {}
    try {
      if (parent && parent.LukeToolsBridge) return parent.LukeToolsBridge;
    } catch (e2) {}
    return null;
  }

  function readLocalNumber(key, fallback) {
    try {
      var v = localStorage.getItem(key);
      if (v === null || v === undefined || v === "") return fallback;
      var n = Number(v);
      if (!isFinite(n)) return fallback;
      return n;
    } catch (e) {
      return fallback;
    }
  }

  function writeLocalNumber(key, val) {
    try { localStorage.setItem(key, String(val)); } catch (e) {}
  }

  function refreshSelection() {
    var bridge = getBridge();
    if (!bridge) {
      $("selName").textContent = "(LukeToolsBridge missing)";
      log("LukeToolsBridge missing. The userscript must be running in the Wick Editor tab.");
      return;
    }

    var info = null;
    try {
      info = bridge.captureSelectionNow ? bridge.captureSelectionNow() : null;
    } catch (e1) {
      info = null;
    }

    var nm = "";
    try { nm = bridge.getSelectedClipName ? bridge.getSelectedClipName() : ""; } catch (e2) { nm = ""; }

    $("selName").textContent = nm ? nm : "(no selection)";
    if (info && info.uuid) log("Selection uuid", info.uuid);
    log("Selection name", nm ? nm : "(blank)");
  }

  function buildArmRigUpdateScript(shoulderIdentifier, elbowIdentifier) {
    shoulderIdentifier = String(shoulderIdentifier || "").trim() || "Shoulder_R";
    elbowIdentifier = String(elbowIdentifier || "").trim() || "Elbo_R";

    function esc(s) {
      return String(s).replace(/\\/g, "\\\\").replace(/"/g, "\\\"");
    }

    return (
      "/* LukeTools ArmRig Update START */\n" +
      "var KEY_SH = \"" + esc(KEY_RIG_SHOULDER) + "\";\n" +
      "var KEY_EL = \"" + esc(KEY_RIG_ELBOW) + "\";\n" +
      "\n" +
      "function readNum(key, fallback) {\n" +
      "  try {\n" +
      "    var v = localStorage.getItem(key);\n" +
      "    if (v === null || v === undefined || v === \"\") return fallback;\n" +
      "    var n = Number(v);\n" +
      "    if (!isFinite(n)) return fallback;\n" +
      "    return n;\n" +
      "  } catch (e) { return fallback; }\n" +
      "}\n" +
      "\n" +
      "function findChildByIdentifier(container, wanted) {\n" +
      "  if (!container || !wanted) return null;\n" +
      "  try {\n" +
      "    for (var k in container) {\n" +
      "      if (!Object.prototype.hasOwnProperty.call(container, k)) continue;\n" +
      "      if (k === wanted) return container[k];\n" +
      "    }\n" +
      "  } catch (e1) {}\n" +
      "  try {\n" +
      "    var kids = null;\n" +
      "    if (typeof container.getChildren === \"function\") kids = container.getChildren();\n" +
      "    else if (Array.isArray(container.children)) kids = container.children;\n" +
      "    else if (Array.isArray(container._children)) kids = container._children;\n" +
      "    if (kids && kids.length) {\n" +
      "      for (var i = 0; i < kids.length; i += 1) {\n" +
      "        var c = kids[i];\n" +
      "        if (!c) continue;\n" +
      "        if (c._identifier === wanted) return c;\n" +
      "        if (c._cachedSerializeData && c._cachedSerializeData.identifier === wanted) return c;\n" +
      "        if (c.name === wanted) return c;\n" +
      "      }\n" +
      "    }\n" +
      "  } catch (e2) {}\n" +
      "  return null;\n" +
      "}\n" +
      "\n" +
      "function setRot(o, deg) {\n" +
      "  if (!o) return;\n" +
      "  var r = Number(deg);\n" +
      "  if (!isFinite(r)) r = 0;\n" +
      "  try { if (typeof o.setRotation === \"function\") { o.setRotation(r); return; } } catch (e1) {}\n" +
      "  try { if (typeof o.rotation === \"number\") { o.rotation = r; } } catch (e2) {}\n" +
      "  try { if (typeof o._rotation === \"number\") { o._rotation = r; } } catch (e3) {}\n" +
      "  try { if (o.transformation && typeof o.transformation.rotation === \"number\") { o.transformation.rotation = r; } } catch (e4) {}\n" +
      "  try { if (o._cachedSerializeData && typeof o._cachedSerializeData.rotation === \"number\") { o._cachedSerializeData.rotation = r; } } catch (e5) {}\n" +
      "}\n" +
      "\n" +
      "var shoulder = null;\n" +
      "var elbow = null;\n" +
      "try { shoulder = this[\"" + esc(shoulderIdentifier) + "\"]; } catch (e1) { shoulder = null; }\n" +
      "try { elbow = this[\"" + esc(elbowIdentifier) + "\"]; } catch (e2) { elbow = null; }\n" +
      "if (!shoulder) shoulder = findChildByIdentifier(this, \"" + esc(shoulderIdentifier) + "\");\n" +
      "if (!elbow) elbow = findChildByIdentifier(this, \"" + esc(elbowIdentifier) + "\");\n" +
      "\n" +
      "var shDeg = readNum(KEY_SH, 0);\n" +
      "var elDeg = readNum(KEY_EL, 0);\n" +
      "if (shoulder) setRot(shoulder, shDeg);\n" +
      "if (elbow) setRot(elbow, elDeg);\n" +
      "/* LukeTools ArmRig Update END */\n"
    );
  }

  function doArrange() {
    var bridge = getBridge();
    if (!bridge) { log("LukeToolsBridge missing"); return; }

    var sh = $("shoulderId").value;
    var el = $("elbowId").value;

    if (!bridge.arrangeArmRigInSelectedClip) {
      log("Bridge function arrangeArmRigInSelectedClip missing.");
      log("You need the updated userscript that adds arrangeArmRigInSelectedClip.");
      return;
    }

    var res = null;
    try { res = bridge.arrangeArmRigInSelectedClip(sh, el); } catch (e1) { res = null; log("Arrange error", e1); }

    log("Arrange result", JSON.stringify(res || {}, null, 2));
  }

  function doInjectUpdate() {
    var bridge = getBridge();
    if (!bridge) { log("LukeToolsBridge missing"); return; }

    var sh = $("shoulderId").value;
    var el = $("elbowId").value;

    var src = buildArmRigUpdateScript(sh, el);

    if (!bridge.setScriptOnSelection) {
      log("Bridge function setScriptOnSelection missing");
      return;
    }

    var ok = false;
    try { ok = bridge.setScriptOnSelection("update", src); } catch (e1) { ok = false; log("Inject error", e1); }

    log("Inject update ok", ok);
  }

  function wireSliders() {
    var shS = $("shSlider");
    var elS = $("elSlider");

    var shV = $("shVal");
    var elV = $("elVal");

    var shInit = readLocalNumber(KEY_RIG_SHOULDER, 0);
    var elInit = readLocalNumber(KEY_RIG_ELBOW, 0);

    shS.value = String(shInit);
    elS.value = String(elInit);

    shV.textContent = String(shInit);
    elV.textContent = String(elInit);

    shS.addEventListener("input", function () {
      shV.textContent = String(shS.value);
      writeLocalNumber(KEY_RIG_SHOULDER, shS.value);
    });

    elS.addEventListener("input", function () {
      elV.textContent = String(elS.value);
      writeLocalNumber(KEY_RIG_ELBOW, elS.value);
    });
  }

  $("btnRefresh").addEventListener("click", refreshSelection);
  $("btnArrange").addEventListener("click", doArrange);
  $("btnInjectUpdate").addEventListener("click", doInjectUpdate);
  $("btnClear").addEventListener("click", function(){ logEl.textContent = ""; });

  wireSliders();
  refreshSelection();
  log("Tool ready.");
})();
</script>
</body>
</html>
