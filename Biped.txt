<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Origin to top</title>
</head>
<body>
  <h2>Origin to top</h2>

  <p>
    Selected name
    <strong id="selName">(none)</strong>
  </p>

  <p>
    This sets OriginY to Height divided by 2 and adjusts Y by the same delta so the artwork stays in place
  </p>

  <button id="btnRefresh" type="button">Refresh selection</button>
  <button id="btnApply" type="button">Set origin to top</button>

  <pre id="log"></pre>

<script>
(function () {
  "use strict";

  function el(id) { return document.getElementById(id); }
  var logEl = el("log");

  function logLine(msg) {
    logEl.textContent += String(msg || "") + "\n";
  }

  function clearLog() {
    logEl.textContent = "";
  }

  function s(v) {
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function isNum(n) {
    return typeof n === "number" && isFinite(n);
  }

  function getBridge() {
    try { if (window.LukeToolsBridge) return window.LukeToolsBridge; } catch (e1) {}
    try { if (window.parent && window.parent.LukeToolsBridge) return window.parent.LukeToolsBridge; } catch (e2) {}
    return null;
  }

  function refreshSelection() {
    var bridge = getBridge();
    if (!bridge) {
      el("selName").textContent = "(bridge missing)";
      return null;
    }

    try { if (typeof bridge.captureSelectionNow === "function") bridge.captureSelectionNow(); } catch (e1) {}

    var name = "";
    try { if (typeof bridge.getSelectedClipName === "function") name = s(bridge.getSelectedClipName()).trim(); } catch (e2) {}
    el("selName").textContent = name || "(none)";

    try {
      if (typeof bridge.captureSelectionNow === "function") {
        var sel = bridge.captureSelectionNow();
        if (sel && sel.raw) return sel.raw;
      }
    } catch (e3) {}

    return null;
  }

  function getXY(obj) {
    if (!obj) return null;

    if (isNum(obj.x) && isNum(obj.y)) return { x: obj.x, y: obj.y, mode: "xy" };

    if (obj.transformation && isNum(obj.transformation.x) && isNum(obj.transformation.y)) {
      return { x: obj.transformation.x, y: obj.transformation.y, mode: "transformation" };
    }

    if (obj.transform && isNum(obj.transform.x) && isNum(obj.transform.y)) {
      return { x: obj.transform.x, y: obj.transform.y, mode: "transform" };
    }

    return null;
  }

  function setXY(obj, x, y, mode) {
    if (!obj) return false;
    if (!isNum(x) || !isNum(y)) return false;

    if (mode === "xy") {
      obj.x = x;
      obj.y = y;
      return true;
    }

    if (mode === "transformation") {
      if (!obj.transformation) obj.transformation = {};
      obj.transformation.x = x;
      obj.transformation.y = y;
      return true;
    }

    if (mode === "transform") {
      if (!obj.transform) obj.transform = {};
      obj.transform.x = x;
      obj.transform.y = y;
      return true;
    }

    return false;
  }

  function getOrigin(obj) {
    if (!obj) return null;

    if (isNum(obj.originX) && isNum(obj.originY)) return { ox: obj.originX, oy: obj.originY, mode: "originXY" };

    if (obj.origin && isNum(obj.origin.x) && isNum(obj.origin.y)) return { ox: obj.origin.x, oy: obj.origin.y, mode: "originObj" };

    if (obj.transformation && isNum(obj.transformation.originX) && isNum(obj.transformation.originY)) {
      return { ox: obj.transformation.originX, oy: obj.transformation.originY, mode: "transformationOriginXY" };
    }

    if (obj.transform && isNum(obj.transform.originX) && isNum(obj.transform.originY)) {
      return { ox: obj.transform.originX, oy: obj.transform.originY, mode: "transformOriginXY" };
    }

    return null;
  }

  function setOrigin(obj, ox, oy, mode) {
    if (!obj) return false;
    if (!isNum(ox) || !isNum(oy)) return false;

    if (mode === "originXY") {
      obj.originX = ox;
      obj.originY = oy;
      return true;
    }

    if (mode === "originObj") {
      if (!obj.origin) obj.origin = {};
      obj.origin.x = ox;
      obj.origin.y = oy;
      return true;
    }

    if (mode === "transformationOriginXY") {
      if (!obj.transformation) obj.transformation = {};
      obj.transformation.originX = ox;
      obj.transformation.originY = oy;
      return true;
    }

    if (mode === "transformOriginXY") {
      if (!obj.transform) obj.transform = {};
      obj.transform.originX = ox;
      obj.transform.originY = oy;
      return true;
    }

    return false;
  }

  function getSize(obj) {
    if (!obj) return null;

    if (isNum(obj.width) && isNum(obj.height)) return { w: obj.width, h: obj.height, mode: "wh" };

    try {
      if (typeof obj.getBounds === "function") {
        var b = obj.getBounds();
        if (b && isNum(b.width) && isNum(b.height)) return { w: b.width, h: b.height, mode: "boundsWH" };
        if (b && isNum(b.x) && isNum(b.y) && isNum(b.width) && isNum(b.height)) return { w: b.width, h: b.height, mode: "boundsRect" };
      }
    } catch (e1) {}

    try {
      if (obj.bounds && isNum(obj.bounds.width) && isNum(obj.bounds.height)) return { w: obj.bounds.width, h: obj.bounds.height, mode: "boundsPropWH" };
    } catch (e2) {}

    return null;
  }

  function getEditor() {
    try { if (window.wickEditor) return window.wickEditor; } catch (e1) {}
    try { if (window.WickEditor && window.WickEditor.editor) return window.WickEditor.editor; } catch (e2) {}
    try { if (window.editor) return window.editor; } catch (e3) {}
    try { if (window.app) return window.app; } catch (e4) {}
    return null;
  }

  function markDirty(ed) {
    try { if (ed && ed.project && typeof ed.project.markAsModified === "function") ed.project.markAsModified(); } catch (e1) {}
    try { if (ed && ed.project) ed.project.unsavedChanges = true; } catch (e2) {}
    try { if (ed && typeof ed.requestRender === "function") ed.requestRender(); } catch (e3) {}
    try { if (ed && ed.renderer && typeof ed.renderer.requestRender === "function") ed.renderer.requestRender(); } catch (e4) {}
  }

  function applyOriginToTop() {
    clearLog();

    var obj = refreshSelection();
    if (!obj) {
      logLine("No selection raw object found");
      return;
    }

    var xy = getXY(obj);
    var ori = getOrigin(obj);
    var size = getSize(obj);

    logLine("Found x y " + (xy ? (xy.x + " " + xy.y + " " + xy.mode) : "missing"));
    logLine("Found origin " + (ori ? (ori.ox + " " + ori.oy + " " + ori.mode) : "missing"));
    logLine("Found size " + (size ? (size.w + " " + size.h + " " + size.mode) : "missing"));

    if (!xy) {
      logLine("Cannot change position because x and y were not found");
      return;
    }

    if (!ori) {
      logLine("Cannot change origin because originX originY were not found on this selection");
      return;
    }

    if (!size || !isNum(size.h) || size.h <= 0) {
      logLine("Cannot change origin because height was not found");
      return;
    }

    var oldOY = ori.oy;
    var newOY = size.h / 2;
    var deltaOY = newOY - oldOY;

    var okOrigin = setOrigin(obj, ori.ox, newOY, ori.mode);
    if (!okOrigin) {
      logLine("Failed to set origin");
      return;
    }

    var okXY = setXY(obj, xy.x, xy.y + deltaOY, xy.mode);
    if (!okXY) {
      logLine("Failed to set y");
      return;
    }

    markDirty(getEditor());

    logLine("Applied new OriginY " + newOY);
    logLine("Applied new Y " + (xy.y + deltaOY));
  }

  el("btnRefresh").addEventListener("click", function () {
    clearLog();
    refreshSelection();
    logLine("Refreshed");
  });

  el("btnApply").addEventListener("click", function () {
    applyOriginToTop();
  });

  refreshSelection();
})();
</script>

</body>
</html>
