<!doctype html>
<html lang="en">
<head>
  <title>Inspect selected clip contents</title>
</head>
<body>
  <div id="wrap"></div>

<script>
(function () {
  "use strict";

  function make(tag) { return document.createElement(tag); }

  var wrap = document.getElementById("wrap");
  wrap.style.fontFamily = "Arial, sans serif";
  wrap.style.padding = "16px";
  wrap.style.color = "#111";
  wrap.style.backgroundColor = "#fff";

  var h = make("div");
  h.textContent = "Inspect selected clip contents";
  h.style.fontSize = "18px";
  h.style.fontWeight = "700";
  h.style.marginBottom = "10px";
  wrap.appendChild(h);

  var info = make("div");
  info.style.marginBottom = "10px";
  wrap.appendChild(info);

  var selectedLabel = make("span");
  selectedLabel.textContent = "Selected clip name: ";
  selectedLabel.style.fontWeight = "700";
  info.appendChild(selectedLabel);

  var selectedName = make("span");
  selectedName.id = "selectedName";
  selectedName.textContent = "(none)";
  info.appendChild(selectedName);

  var controls = make("div");
  controls.style.marginBottom = "10px";
  wrap.appendChild(controls);

  function makeBtn(text) {
    var b = make("button");
    b.type = "button";
    b.textContent = text;
    b.style.padding = "10px 12px";
    b.style.borderRadius = "10px";
    b.style.border = "1px solid #ddd";
    b.style.backgroundColor = "#fff";
    b.style.cursor = "pointer";
    b.style.marginRight = "8px";
    return b;
  }

  var btnRefresh = makeBtn("Refresh selection");
  var btnInspect = makeBtn("Inspect children");
  controls.appendChild(btnRefresh);
  controls.appendChild(btnInspect);

  var logBox = make("pre");
  logBox.style.whiteSpace = "pre-wrap";
  logBox.style.wordBreak = "break-word";
  logBox.style.border = "1px solid #ddd";
  logBox.style.borderRadius = "10px";
  logBox.style.padding = "12px";
  logBox.style.backgroundColor = "#fafafa";
  logBox.style.margin = "0";
  logBox.style.fontFamily = "Consolas, Menlo, Monaco, monospace";
  logBox.style.fontSize = "12px";
  wrap.appendChild(logBox);

  function clearLog() { logBox.textContent = ""; }
  function logLine(t) { logBox.textContent += String(t === undefined ? "" : t) + "\n"; }

  function s(v) {
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function tidy(v) {
    return s(v).replace(/\s+/g, " ").trim();
  }

  function isFiniteNumber(v) {
    return typeof v === "number" && isFinite(v);
  }

  function getBridge() {
    try { if (window.LukeToolsBridge) return window.LukeToolsBridge; } catch (e1) {}
    try { if (window.parent && window.parent.LukeToolsBridge) return window.parent.LukeToolsBridge; } catch (e2) {}
    return null;
  }

  function getObjName(obj) {
    if (!obj) return "";
    try {
      if (typeof obj.name === "string") return tidy(obj.name);
      if (typeof obj.getName === "function") return tidy(obj.getName());
    } catch (e1) {}
    return "";
  }

  function getObjUUID(obj) {
    if (!obj) return "";
    try { if (typeof obj.uuid === "string") return tidy(obj.uuid); } catch (e1) {}
    try { if (typeof obj.UUID === "string") return tidy(obj.UUID); } catch (e2) {}
    try { if (typeof obj.id === "string") return tidy(obj.id); } catch (e3) {}
    return "";
  }

  function getAssetNameFromObj(obj) {
    if (!obj) return "";
    try {
      if (obj.clipAsset) {
        if (typeof obj.clipAsset.name === "string") return tidy(obj.clipAsset.name);
        if (typeof obj.clipAsset.getName === "function") return tidy(obj.clipAsset.getName());
      }
    } catch (e1) {}
    try {
      if (obj.asset) {
        if (typeof obj.asset.name === "string") return tidy(obj.asset.name);
        if (typeof obj.asset.getName === "function") return tidy(obj.asset.getName());
      }
    } catch (e2) {}
    return "";
  }

  function getTimelineFromAsset(asset) {
    if (!asset) return null;
    try { if (asset.timeline) return asset.timeline; } catch (e1) {}
    try { if (asset._timeline) return asset._timeline; } catch (e2) {}
    return null;
  }

  function resolveClipAssetFromObject(obj) {
    if (!obj) return null;
    try { if (obj.clipAsset) return obj.clipAsset; } catch (e1) {}
    try { if (obj.asset) return obj.asset; } catch (e2) {}
    if (getTimelineFromAsset(obj)) return obj;
    return null;
  }

  function getLayersFromTimeline(tl) {
    if (!tl) return [];
    try { if (Array.isArray(tl.layers)) return tl.layers; } catch (e1) {}
    try { if (Array.isArray(tl._layers)) return tl._layers; } catch (e2) {}
    return [];
  }

  function getFramesFromLayer(layer) {
    if (!layer) return [];
    try { if (Array.isArray(layer.frames)) return layer.frames; } catch (e1) {}
    try { if (Array.isArray(layer._frames)) return layer._frames; } catch (e2) {}
    try { if (Array.isArray(layer.frame)) return layer.frame; } catch (e3) {}
    return [];
  }

  function getObjectsFromFrame(fr) {
    if (!fr) return [];
    try { if (Array.isArray(fr.wickObjects)) return fr.wickObjects; } catch (e1) {}
    try { if (Array.isArray(fr.objects)) return fr.objects; } catch (e2) {}
    try { if (Array.isArray(fr.children)) return fr.children; } catch (e3) {}
    try { if (Array.isArray(fr._children)) return fr._children; } catch (e4) {}
    return [];
  }

  function collectFramesFromTimeline(tl) {
    var frames = [];
    var layers = getLayersFromTimeline(tl);
    for (var i = 0; i < layers.length; i += 1) {
      var frs = getFramesFromLayer(layers[i]);
      for (var j = 0; j < frs.length; j += 1) {
        if (frs[j]) frames.push(frs[j]);
      }
    }
    return frames;
  }

  function looksLikeClipInstance(obj) {
    if (!obj) return false;
    try { if (obj.clipAsset) return true; } catch (e1) {}
    try { if (obj.asset && getTimelineFromAsset(obj.asset)) return true; } catch (e2) {}
    try { if (getTimelineFromAsset(obj)) return true; } catch (e3) {}
    return false;
  }

  function getXY(obj) {
    if (!obj) return null;
    var x = null;
    var y = null;

    try {
      if (isFiniteNumber(obj.x) && isFiniteNumber(obj.y)) {
        x = obj.x; y = obj.y;
        return { x: x, y: y, mode: "xy" };
      }
    } catch (e1) {}

    try {
      if (obj.transformation && isFiniteNumber(obj.transformation.x) && isFiniteNumber(obj.transformation.y)) {
        x = obj.transformation.x; y = obj.transformation.y;
        return { x: x, y: y, mode: "transformation" };
      }
    } catch (e2) {}

    try {
      if (obj.transform && isFiniteNumber(obj.transform.x) && isFiniteNumber(obj.transform.y)) {
        x = obj.transform.x; y = obj.transform.y;
        return { x: x, y: y, mode: "transform" };
      }
    } catch (e3) {}

    return null;
  }

  function refreshSelectionRaw() {
    var bridge = getBridge();
    if (!bridge) {
      selectedName.textContent = "(bridge missing)";
      return null;
    }

    try { if (typeof bridge.captureSelectionNow === "function") bridge.captureSelectionNow(); } catch (e1) {}

    var nm = "";
    try { if (typeof bridge.getSelectedClipName === "function") nm = tidy(bridge.getSelectedClipName()); } catch (e2) {}
    selectedName.textContent = nm || "(none)";

    try {
      if (typeof bridge.captureSelectionNow === "function") {
        var sel = bridge.captureSelectionNow();
        if (sel && sel.raw) return sel.raw;
      }
    } catch (e3) {}

    return null;
  }

  function inspectChildren() {
    clearLog();

    var rawSel = refreshSelectionRaw();
    if (!rawSel) {
      logLine("No selection found");
      return;
    }

    var containerAsset = resolveClipAssetFromObject(rawSel);
    if (!containerAsset) {
      logLine("Selection is not a clip or clip asset");
      return;
    }

    var tl = getTimelineFromAsset(containerAsset);
    if (!tl) {
      logLine("Selected clip has no timeline");
      return;
    }

    var frames = collectFramesFromTimeline(tl);
    if (!frames.length) {
      logLine("Selected clip has no frames");
      return;
    }

    var found = [];
    var seen = new Set();

    for (var i = 0; i < frames.length; i += 1) {
      var objs = getObjectsFromFrame(frames[i]);
      for (var j = 0; j < objs.length; j += 1) {
        var o = objs[j];
        if (!o) continue;
        if (!looksLikeClipInstance(o)) continue;
        if (seen.has(o)) continue;
        seen.add(o);
        found.push(o);
      }
    }

    if (!found.length) {
      logLine("No child clips found on the timeline of the selected clip");
      return;
    }

    logLine("Child clips found: " + found.length);
    logLine("");

    for (var k = 0; k < found.length; k += 1) {
      var child = found[k];
      var instanceName = getObjName(child);
      var assetName = getAssetNameFromObj(child);
      var uuid = getObjUUID(child);
      var xy = getXY(child);

      logLine("Index " + (k + 1));
      logLine("Instance name " + (instanceName || "(blank)"));
      logLine("Asset name " + (assetName || "(blank)"));
      logLine("UUID " + (uuid || "(blank)"));
      if (xy) {
        logLine("X " + xy.x);
        logLine("Y " + xy.y);
        logLine("Position mode " + xy.mode);
      } else {
        logLine("X and Y not found");
      }
      logLine("");
    }
  }

  btnRefresh.addEventListener("click", function () {
    clearLog();
    refreshSelectionRaw();
    logLine("Refreshed");
  });

  btnInspect.addEventListener("click", function () {
    inspectChildren();
  });

  refreshSelectionRaw();
})();
</script>
</body>
</html>
